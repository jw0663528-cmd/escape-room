<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爪注 拽拽住: 专 转</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        /* * ==========================================================================
         * 1. CORE VARIABLES & RESET (RTL adjustments applied here)
         * ==========================================================================
         */
        :root {
            --c-bg-dark: #050505;
            --c-panel: #0a0b10;
            --c-border: #2a2b30;
            
            --c-text-main: #a8b2d1;
            --c-text-dim: #5a6070;
            --c-text-bright: #ffffff;

            /* HUD Colors */
            --c-primary: #00f2ff; /* Cyan - UI */
            --c-success: #00ff9d; /* Green - Bio */
            --c-warn: #ffae00;    /* Orange - Alert */
            --c-danger: #ff2a2a;  /* Red - Critical */
            --c-rare: #b300ff;    /* Purple - Special */

            /* Layout */
            --sidebar-width: 380px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--c-bg-dark);
            color: var(--c-text-main);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* Set overall direction to RTL */
        #game-wrapper, header, main, aside, .panel h3, #objective-text { direction: rtl; text-align: right; }


        /* * ==========================================================================
         * 2. BOOT SEQUENCE SCREEN
         * ==========================================================================
         */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Share Tech Mono', monospace;
            color: var(--c-primary);
        }

        .boot-log { width: 600px; height: 300px; overflow: hidden; font-size: 14px; line-height: 1.5; opacity: 0.8; }
        .boot-loader {
            width: 300px; height: 4px; background: #333; margin-top: 20px; position: relative;
        }
        .boot-bar {
            width: 0%; height: 100%; background: var(--c-success);
            transition: width 3s ease-out;
            box-shadow: 0 0 10px var(--c-success);
        }

        /* * ==========================================================================
         * 3. MAIN GAME LAYOUT
         * ==========================================================================
         */
        #game-wrapper {
            width: 100%; height: 100%;
            display: grid;
            /* Default Desktop Layout: Viewport (80%) | Sidebar (380px) */
            grid-template-columns: 1fr var(--sidebar-width);
            grid-template-rows: var(--header-height) 1fr;
            opacity: 0; transition: opacity 1s; /* Fade in after boot */
        }

        /* Top Header Bar */
        #top-bar {
            grid-column: 1 / -1;
            background: var(--c-panel);
            border-bottom: 1px solid var(--c-border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
            z-index: 50;
        }

        .brand-title {
            font-family: 'Orbitron', sans-serif; font-size: 24px; letter-spacing: 2px;
            background: linear-gradient(90deg, var(--c-primary), #fff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .sys-status { font-family: 'Share Tech Mono'; font-size: 14px; color: var(--c-success); }
        .sys-status.alert { color: var(--c-danger); animation: blink 1s infinite; }

        /* Left Column: Viewport (Main content) */
        #viewport {
            position: relative;
            background: #000;
            overflow: hidden;
            /* Flipped border to align with sidebar on the right */
            border-right: 1px solid var(--c-border); 
        }

        /* Right Column: Sidebar (HUD) */
        #sidebar {
            background: rgba(10, 11, 16, 0.95);
            display: flex; flex-direction: column;
            border-left: 1px solid var(--c-border);
            padding: 20px;
            backdrop-filter: blur(10px);
            z-index: 40;
        }

        /* * ==========================================================================
         * 4. VIEWPORT LAYERS & VISUALS
         * ==========================================================================
         */
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 1.5s; background-size: cover; background-position: center; }
        
        #bg-day { background-image: url('https://i.ibb.co/7tQt5S0h/Gemini-Generated-Image-prcu4rprcu4rprcu.png'); opacity: 1; }
        #bg-night { background-image: url('https://i.ibb.co/svJJmvYr/Gemini-Generated-Image-l4kaehl4kaehl4ka.png'); opacity: 0; }
        #bg-lab { background-image: url('https://i.ibb.co/d04yrgRx/Gemini-Generated-Image-j02tg6j02tg6j02t.png'); opacity: 0; }

        #fx-canvas { pointer-events: none; z-index: 5; opacity: 0.7; }
        
        #scan-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 242, 255, 0.05),
                rgba(0, 242, 255, 0.05) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none; z-index: 6; opacity: 0; transition: opacity 0.3s;
        }
        #scan-overlay.active { opacity: 1; }

        /* * ==========================================================================
         * 5. INTERACTIVE HOTSPOTS (Positioning kept LTR to align with non-flipped image)
         * ==========================================================================
         */
        .hotspot {
            position: absolute;
            z-index: 20;
            cursor: pointer;
            opacity: 0; 
            transition: all 0.3s;
            border: 1px dashed rgba(255,255,255,0.2);
        }

        /* Scanner Logic */
        .scanner-active .hotspot { opacity: 0.3; background: rgba(0, 242, 255, 0.1); border-color: var(--c-primary); }
        .hotspot:hover { opacity: 1 !important; box-shadow: 0 0 15px var(--c-primary); border: 1px solid #fff; background: rgba(0, 242, 255, 0.2); }

        /* Positioning (Percentages) */
        /* Train */
        #spot-cat { top: 14%; left: 20%; width: 12%; height: 14%; }
        #spot-map { top: 35%; left: 9%; width: 18%; height: 23%; }
        #spot-window { top: 22%; left: 35%; width: 28%; height: 38%; }
        #spot-hat { top: 26%; left: 67%; width: 10%; height: 16%; }
        #spot-door { top: 18%; left: 78%; width: 20%; height: 75%; }
        /* Lab */
        #spot-flask { top: 55%; left: 25%; width: 15%; height: 25%; }
        #spot-jar { top: 15%; left: 60%; width: 25%; height: 55%; }
        #spot-notes { top: 70%; left: 45%; width: 20%; height: 15%; }

        /* * ==========================================================================
         * 6. UI PANELS (SIDEBAR)
         * ==========================================================================
         */
        .panel { background: rgba(255,255,255,0.03); border: 1px solid var(--c-border); padding: 15px; margin-bottom: 15px; border-radius: 6px; }
        .panel h3 { 
            margin: 0 0 10px 0; font-family: 'Orbitron'; font-size: 14px; 
            color: var(--c-primary); letter-spacing: 1px; text-transform: uppercase; 
            border-bottom: 1px solid #333; padding-bottom: 5px; 
            text-align: right; 
        }

        /* Backpack Button & Image (NEW) */
        #backpack-area { 
            margin-bottom: 20px; text-align: center; 
            padding-bottom: 10px; border-bottom: 1px solid var(--c-border);
        }
        #backpack-area img { 
            display: block; width: 100px; height: 100px; object-fit: cover; 
            margin: 0 auto 10px auto; border: 2px solid var(--c-primary); border-radius: 50%;
            max-width: 100%; 
        }
        #backpack-btn {
            width: 80%; padding: 10px; background: var(--c-success); border: none; 
            color: #000; font-family: 'Orbitron'; font-weight: bold; cursor: pointer;
            border-radius: 4px; transition: 0.2s;
        }
        #backpack-btn:hover { background: #00ffc8; box-shadow: 0 0 10px var(--c-success); }


        /* Scanner Toggle */
        #scanner-btn {
            width: 100%; padding: 15px;
            background: transparent; border: 1px solid var(--c-primary); color: var(--c-primary);
            font-family: 'Share Tech Mono'; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: 0.3s; text-transform: uppercase; margin-bottom: 20px;
        }
        #scanner-btn:hover, #scanner-btn.active { background: var(--c-primary); color: #000; box-shadow: 0 0 15px var(--c-primary); }

        /* Mission Log */
        #objective-text { font-size: 14px; line-height: 1.4; color: #fff; text-align: right; }

        /* DataBank (Journal) */
        #databank { height: 150px; overflow-y: auto; font-family: 'Share Tech Mono'; font-size: 12px; color: #888; text-align: right; }
        .log-entry { margin-bottom: 8px; border-right: 2px solid #333; padding-right: 8px; border-left: none; padding-left: 0;}
        .log-entry.new { border-color: var(--c-success); color: var(--c-success); }

        /* Inventory Modal Grid */
        #inv-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
            margin: 20px auto; max-width: 400px;
        }
        .inv-slot { aspect-ratio: 1; background: #000; border: 1px solid #333; display: flex; justify-content: center; align-items: center; font-size: 24px; transition: 0.3s; position: relative; }
        .inv-slot.filled { border-color: var(--c-success); box-shadow: inset 0 0 10px rgba(0,255,157,0.2); }
        .inv-tooltip { 
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #000; border: 1px solid #fff; padding: 5px; font-size: 10px; 
            width: 120px; text-align: center; display: none; z-index: 100; white-space: nowrap;
        }
        .inv-slot:hover .inv-tooltip { display: block; }
        #inventory-modal-title { font-size: 16px; margin-bottom: 5px; color: #fff; }


        /* * ==========================================================================
         * 7. MINI-GAMES & MODALS
         * ==========================================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .game-window {
            width: 600px; height: 400px;
            background: #111; border: 2px solid var(--c-primary);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
            padding: 20px; position: relative;
            display: flex; flex-direction: column;
            direction: rtl; 
            text-align: right;
        }
        .game-header { font-family: 'Orbitron'; font-size: 20px; color: var(--c-primary); margin-bottom: 20px; text-align: center;}
        .close-modal { position: absolute; top: 10px; left: 15px; cursor: pointer; color: #666; font-size: 20px; } 
        .close-modal:hover { color: #fff; }

        /* --- Mini-Game 1: Frequency Tuner (Window) --- */
        #tuner-game { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #wave-canvas { width: 100%; height: 150px; background: #000; border: 1px solid #333; margin-bottom: 20px; }
        input[type=range] { width: 80%; cursor: pointer; }
        #tuner-status { margin-top: 10px; font-family: 'Share Tech Mono'; color: var(--c-warn); }

        /* --- Mini-Game 2: Keypad Hack (Door) --- */
        #keypad-game { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 250px; margin: 0 auto; }
        .key-btn { 
            padding: 20px; background: #222; border: 1px solid #444; color: #fff; 
            font-family: 'Orbitron'; font-size: 18px; cursor: pointer; transition: 0.2s; 
        }
        .key-btn:hover { background: var(--c-primary); color: #000; }
        #keypad-display { 
            grid-column: 1 / -1; background: #000; color: var(--c-primary); 
            font-family: 'Share Tech Mono'; font-size: 24px; padding: 10px; text-align: center; border: 1px solid #444;
        }

        /* --- Mini-Game 3: Chemical Mixer (Flask) --- */
        #chem-game { display: flex; justify-content: space-around; padding-top: 50px; }
        .chem-btn { width: 80px; height: 100px; border: 2px solid #fff; cursor: pointer; position: relative; overflow: hidden; }
        .chem-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; opacity: 0.5; transition: height 0.5s; }
        #beaker-main { width: 120px; height: 150px; border: 3px solid #fff; border-radius: 0 0 20px 20px; position: relative; overflow: hidden; }
        #beaker-fill { position: absolute; bottom: 0; width: 100%; height: 0%; background: #333; transition: all 0.5s; }


        /* * ==========================================================================
         * 8. MOBILE RESPONSIVENESS FIXES
         * ==========================================================================
         */
        @media (max-width: 768px) {
            
            /* Main Layout Grid */
            #game-wrapper {
                grid-template-columns: 1fr; /* Single column */
                grid-template-rows: var(--header-height) 1fr auto; /* Header | Viewport | Sidebar */
            }

            /* Top Bar */
            #top-bar {
                padding: 0 15px;
            }

            /* Sidebar (now at the bottom) */
            #sidebar {
                grid-row: 3; /* Move to the bottom of the grid */
                width: 100%;
                max-height: 50vh; /* Limit height so viewport remains visible */
                overflow-y: auto;
                padding: 10px 15px;
                border-right: none;
                border-top: 1px solid var(--c-border);
                border-left: none; /* Remove desktop border */
            }
            
            /* Viewport (Main Content) */
            #viewport {
                grid-row: 2;
                border-right: none;
            }

            /* Sidebar Content adjustments */
            .panel { margin-bottom: 10px; }
            #databank { height: 100px; } /* Reduce height on mobile */
            #backpack-area { margin-bottom: 10px; padding-bottom: 5px; }
            #backpack-area img { width: 60px; height: 60px; margin-bottom: 5px; }
            #backpack-btn { width: 100%; }
            #scanner-btn { margin-bottom: 10px; padding: 10px; }

            /* Modals (Make them full screen on mobile) */
            .game-window {
                width: 95%;
                height: 90%;
                max-width: 95%; /* Override desktop width */
                margin: 0 auto;
                padding: 15px;
            }
            .modal-overlay {
                align-items: flex-start; /* Align to top */
                padding-top: 5vh;
            }
        }

    </style>
</head>
<body>

    <div id="boot-screen">
        <div class="boot-log" id="boot-log"></div>
        <div class="boot-loader"><div class="boot-bar" id="boot-bar"></div></div>
    </div>

    <div id="game-wrapper">
        
        <header id="top-bar">
            <div id="sys-status" class="sys-status">注专转 转拽</div>
            <div class="brand-title">拽拽住_注专转 <span style="font-size:12px; vertical-align:middle;">v9.4</span></div>
        </header>

        <main id="viewport">
            <canvas id="fx-canvas"></canvas>
            <div id="scan-overlay"></div>
            
            <div id="bg-lab" class="layer"></div>
            <div id="bg-night" class="layer"></div>
            <div id="bg-day" class="layer"></div>

            <div id="hotspot-layer">
                <div id="spot-cat" class="hotspot train-obj" data-ref="cat"></div>
                <div id="spot-map" class="hotspot train-obj" data-ref="map"></div>
                <div id="spot-window" class="hotspot train-obj" data-ref="window"></div>
                <div id="spot-hat" class="hotspot train-obj" data-ref="hat"></div>
                <div id="spot-door" class="hotspot train-obj" data-ref="door"></div>

                <div id="spot-flask" class="hotspot lab-obj hidden" data-ref="flask"></div>
                <div id="spot-jar" class="hotspot lab-obj hidden" data-ref="jar"></div>
                <div id="spot-notes" class="hotspot lab-obj hidden" data-ref="notes"></div>
            </div>
        </main>

        <aside id="sidebar">
            
            <div id="backpack-area">
                <a href="https://imgbb.com/"><img src="https://i.ibb.co/B5SmhWNb/Whats-App-Image-2025-12-15-at-11-01-52.jpg" alt="转转 砖转砖" border="0"></a>
                <button id="backpack-btn" onclick="InventoryModal.open()">转拽  ()</button>
            </div>

            <button id="scanner-btn" onclick="Game.toggleScanner()">驻注 住专拽 []</button>

            <div class="panel">
                <h3>砖 转</h3>
                <div id="objective-text">转...</div>
            </div>

            <div class="panel" style="flex-grow:1; display:flex; flex-direction:column;">
                <h3> 拽专</h3>
                <div id="databank">
                    </div>
            </div>
            
        </aside>
    </div>

    <div id="game-modal" class="modal-overlay">
        <div class="game-window">
            <div class="close-modal" onclick="Modal.close()"></div>
            <div class="game-header" id="modal-title">砖 注专转</div>
            
            <div id="modal-content" style="flex:1; position:relative;">
                
                <div id="tuner-game" class="minigame hidden">
                    <p style="color:#aaa; text-align:right;"> 转 转专 转  爪 转 专驻, 住住 注  **** (Halteres) 砖 . 注 拽 转 转 注 砖 1.5 砖转.</p>
                    <canvas id="wave-canvas"></canvas>
                    <input type="range" min="1" max="100" value="50" id="wave-slider">
                    <div id="tuner-status">转: 砖</div>
                </div>

                <div id="keypad-game" class="minigame hidden">
                    <div id="keypad-display">_ _ _ _</div>
                    <button class="key-btn" onclick="Keypad.press(1)">1</button>
                    <button class="key-btn" onclick="Keypad.press(2)">2</button>
                    <button class="key-btn" onclick="Keypad.press(3)">3</button>
                    <button class="key-btn" onclick="Keypad.press(4)">4</button>
                    <button class="key-btn" onclick="Keypad.press(5)">5</button>
                    <button class="key-btn" onclick="Keypad.press(6)">6</button>
                    <button class="key-btn" onclick="Keypad.press(7)">7</button>
                    <button class="key-btn" onclick="Keypad.press(8)">8</button>
                    <button class="key-btn" onclick="Keypad.press(9)">9</button>
                </div>

                <div id="chem-game" class="minigame hidden">
                    <div style="text-align:center; position:absolute; top:0; width:100%;">注专 **专拽** () + **** ()  住转  爪.</div>
                    <div class="chem-btn" onclick="Chem.add('red')" style="border-color:#f00;"><div class="chem-fill" style="background:#f00;"></div></div>
                    <div id="beaker-main"><div id="beaker-fill"></div></div>
                    <div class="chem-btn" onclick="Chem.add('blue')" style="border-color:#00f;"><div class="chem-fill" style="background:#00f;"></div></div>
                    <div class="chem-btn" onclick="Chem.add('green')" style="border-color:#0f0;"><div class="chem-fill" style="background:#0f0;"></div></div>
                </div>

                <div id="riddle-container" class="minigame hidden">
                    <p id="riddle-text" style="font-size:16px; line-height:1.5; color:#fff; margin-bottom:20px; text-align:right;"></p>
                    <input type="text" id="riddle-input" style="width:100%; padding:10px; background:#000; color:var(--c-primary); border:1px solid #333; font-family:'Share Tech Mono'; font-size:18px; text-align:right;">
                    <button onclick="Riddle.check()" style="margin-top:10px; padding:10px 20px; background:var(--c-primary); border:none; font-weight:bold; cursor:pointer;">砖</button>
                    <p id="riddle-err" style="color:var(--c-danger); margin-top:10px; text-align:right;"></p>
                </div>

                <div id="victory-screen" class="minigame hidden">
                    <h1>砖 砖</h1>
                    <p>驻转 专驻 砖 "专 专拽住 专 爪. 砖转  砖.</p>
                    <p>转 拽专 专 .</p>
                    <button onclick="location.reload()" style="margin-top:30px; padding:15px 40px; background:var(--c-success); border:none; font-weight:bold; cursor:pointer;">转 住爪</button>
                </div>

            </div>
        </div>
    </div>
    
    <div id="inventory-modal" class="modal-overlay">
        <div class="game-window" style="height: auto; width: 500px; max-width: 95%;">
            <div class="close-modal" onclick="InventoryModal.close()"></div>
            <div class="game-header">转拽 :  -</div>
            <p id="inventory-modal-title" style="text-align: center;">驻专 拽专 砖转驻住</p>
            <div id="inv-grid">
                <div class="inv-slot" id="slot-0"></div>
                <div class="inv-slot" id="slot-1"></div>
                <div class="inv-slot" id="slot-2"></div>
                <div class="inv-slot" id="slot-3"></div>
                <div class="inv-slot" id="slot-4"></div>
                <div class="inv-slot" id="slot-5"></div>
                <div class="inv-slot" id="slot-6"></div>
                <div class="inv-slot" id="slot-7"></div>
            </div>
            <p style="text-align: center; font-size: 12px; color: var(--c-text-dim);">专祝 注 驻专 注 住祝.</p>
        </div>
    </div>


    <script>
        // --- ASSETS & CONFIG (Hebrew Translation) ---
        const ITEMS = {
            needle: { id: 'needle', icon: '', name: '拽 拽专-', desc: '砖 砖专 拽 转砖; 驻砖专  注.' },
            sensor: { id: 'sensor', icon: '', name: '砖 转专 专砖', desc: ' 专砖转 拽 砖 转砖 转专 转转  驻拽.' },
            gyro: { id: 'gyro', icon: '锔', name: ' 专住拽驻', desc: '爪 转注驻 注专 砖专转  砖 .' },
            chem: { id: 'chem', icon: '', name: '拽 -爪', desc: '转  驻 -爪  注 专拽.' },
            formula: { id: 'formula', icon: '', name: '住转 专拽住', desc: '专转 住转 砖 专注: 专拽 + .' },
            antidote: { id: 'antidote', icon: 'И', name: '', desc: ' 砖住转  专 转 专注 拽.' },
            drone: { id: 'drone', icon: '', name: '专驻 -拽旨侄拽住', desc: '注专转 住驻拽 驻专住 -转.' } 
        };

        // --- GLOBAL STATE ---
        const State = {
            phase: 'TRAIN', // 专转 -> 注
            inventory: ['drone'],
            isScannerOn: false,
            isNight: false,
            progress: 0,
            solved: []
        };

        // --- BOOT SEQUENCE ---
        function runBoot() {
            const log = document.getElementById('boot-log');
            const bar = document.getElementById('boot-bar');
            const lines = [
                "转 转 注专转...",
                "注  转拽 -...",
                "转专 拽砖专 专拽 BSF-01...",
                "专 专拽 住...",
                " 砖...",
                "注专转 . 驻注转 '爪注 拽拽住'..."
            ];
            
            let i = 0;
            const interval = setInterval(() => {
                if(i >= lines.length) {
                    clearInterval(interval);
                    setTimeout(startGame, 500);
                    return;
                }
                const p = document.createElement('div');
                p.innerText = "> " + lines[i];
                log.appendChild(p);
                log.scrollTop = log.scrollHeight;
                i++;
            }, 300);

            // Animate Bar
            setTimeout(() => { bar.style.width = "100%"; }, 100);
        }

        function startGame() {
            document.getElementById('boot-screen').style.display = 'none';
            document.getElementById('game-wrapper').style.opacity = 1;
            Game.init();
        }

        // --- GAME ENGINE ---
        const Game = {
            init() {
                Inventory.render();
                Journal.add("砖 . 砖 1: 专 转 专转. 注 转专 转 4 专 拽专 砖专拽住 住转专 专转. 注转 砖转 转 , 住!", true);
                Journal.add("专: 爪 4 专 - 住转专 专转  驻专抓 转 转 注 住转专转.", true);
                
                this.updateObjective();
                Fx.init(); // Start particles
                
                // Add Click Listeners
                document.querySelectorAll('.hotspot').forEach(el => {
                    el.addEventListener('click', (e) => this.handleObjectClick(e.target));
                });

                // Start Clock
                setInterval(this.tickClock, 1000);
            },

            tickClock() {
                // Night cycle logic (translated to Hebrew)
                const now = new Date();
                const sec = now.getSeconds();
                
                if (State.phase === 'TRAIN') {
                    if (sec > 30 && !State.isNight) {
                        State.isNight = true;
                        document.getElementById('bg-day').style.opacity = 0;
                        document.getElementById('bg-night').style.opacity = 1;
                        document.getElementById('sys-status').innerText = "爪 转专 ";
                        document.getElementById('sys-status').classList.add('alert');
                    } else if (sec <= 30 && State.isNight) {
                        State.isNight = false;
                        document.getElementById('bg-day').style.opacity = 1;
                        document.getElementById('bg-night').style.opacity = 0;
                        document.getElementById('sys-status').innerText = "注专转 转拽";
                        document.getElementById('sys-status').classList.remove('alert');
                    }
                }
            },

            toggleScanner() {
                State.isScannerOn = !State.isScannerOn;
                const btn = document.getElementById('scanner-btn');
                const overlay = document.getElementById('scan-overlay');
                
                if (State.isScannerOn) {
                    btn.classList.add('active');
                    btn.innerText = "住专拽 [驻注]";
                    overlay.classList.add('active');
                    document.body.classList.add('scanner-active');
                    Journal.add("住专拽 -拽 驻注. 转转  专转 注.", true);
                } else {
                    btn.classList.remove('active');
                    btn.innerText = "住专拽 []";
                    overlay.classList.remove('active');
                    document.body.classList.remove('scanner-active');
                }
            },

            handleObjectClick(target) {
                if (!State.isScannerOn && target.id !== 'spot-door') {
                    Journal.add(" 转 转. 驻注 转 住专拽 拽 .", false);
                    return;
                }

                const ref = target.dataset.ref;
                
                if (State.solved.includes(ref)) return;

                switch(ref) {
                    case 'cat':
                        // Needle (Proboscis)
                        Riddle.open("转 专砖: 拽 转砖", "  拽拽 砖专转 注专  专  . 转 砖   砖     拽.   转专转 转 拽 驻 砖 转砖 砖砖砖 砖?", "拽", ITEMS.needle, ref);
                        break;
                    case 'map':
                        // Thermal Sensor
                        Riddle.open("转  拽专: 砖 ", " 驻砖专 转专 驻拽 转转  专拽, 砖专转 转 转专 砖 转砖.  转 专  住专拽.  住 拽专  砖转砖  转  祝?", "转专", ITEMS.sensor, ref);
                        break;
                    case 'hat':
                        // Chem-Receptor (CO2 sensing)
                        Riddle.open("拽 : 驻 -爪", " 专 转  砖转 砖,   转 专.  专 住住 转专 驻砖 .  专  砖 , 驻 砖?", "拽", ITEMS.chem, ref);
                        break;
                    case 'window':
                        // Gyro-Halteres (stabilization)
                        Modal.open("爪 专:  住专", "tuner-game");
                        Tuner.start(target);
                        break;
                    case 'door':
                        // Door Check
                        const req = ['needle', 'sensor', 'gyro', 'chem'];
                        const hasAll = req.every(i => State.inventory.includes(i));
                        if(hasAll) {
                            Modal.open("注拽驻转 : 拽 注", "keypad-game");
                        } else {
                            Journal.add(`转 注. 专砖 4 专 -. 住专 ${req.length - (State.inventory.length - 1)} 驻专.`, false);
                        }
                        break;
                    case 'notes':
                        // Formula Notes
                        Riddle.open("驻注 拽专: 住 专注", "驻转   爪注 **** (爪 注  注 注) 转住驻转 爪注 **** (爪 注  注 ).  住 砖 专拽住?", "住", ITEMS.formula, ref);
                        break;
                    case 'flask':
                        // Chemical Mixer
                        if(!State.inventory.includes('formula')) {
                            Journal.add("专砖转 住  驻注 转 住转住专 .", false);
                            return;
                        }
                        Modal.open("住转转  拽拽住", "chem-game");
                        break;
                    case 'jar':
                        // Final Deployment
                        if(State.inventory.includes('antidote')) {
                            Modal.open("驻专住 住驻转: 专 ", "victory-screen");
                        } else {
                            Journal.add("专 注. 专砖   专 转 驻转  拽专.", false);
                        }
                        break;
                }
            },

            updateObjective() {
                const txt = document.getElementById('objective-text');
                if (State.phase === 'TRAIN') {
                    const count = 4 - (State.inventory.length - 1); 
                    if(count > 0) txt.innerText = `爪 ${count} 专 住驻 (拽专 砖 专拽 注驻驻)  驻专抓 转 转 注.`;
                    else txt.innerText = " 专 住驻. 驻专抓 转 转 注.";
                } else {
                    txt.innerText = "爪 转 住. 注专 转 . 砖 转 祝 - 驻 砖注 注.";
                }
            },

            transitionToLab() {
                State.phase = 'LAB';
                document.getElementById('viewport').style.opacity = 0;
                setTimeout(() => {
                    document.querySelectorAll('.hotspot').forEach(e => e.classList.add('hidden'));
                    document.querySelectorAll('.lab-obj').forEach(e => e.classList.remove('hidden'));
                    
                    document.getElementById('bg-lab').style.opacity = 1;
                    document.getElementById('bg-day').style.opacity = 0;
                    document.getElementById('bg-night').style.opacity = 0; 
                    document.getElementById('viewport').style.opacity = 1;
                    
                    Journal.add("砖 1 砖! 专转 注 住转专转 砖 专拽住. 砖注 转拽转拽, 爪 转 住 !", true);
                    Game.updateObjective();
                }, 1000);
            }
        };

        // --- INVENTORY MODAL SYSTEM ---
        const InventoryModal = {
            open() {
                document.getElementById('inventory-modal').classList.add('active');
                Inventory.render();
            },
            close() {
                document.getElementById('inventory-modal').classList.remove('active');
            }
        };

        // --- INVENTORY SYSTEM ---
        const Inventory = {
            render() {
                const slots = document.querySelectorAll('#inv-grid .inv-slot');
                slots.forEach(s => { s.innerHTML = ''; s.classList.remove('filled'); });
                
                State.inventory.forEach((itemId, idx) => {
                    if(idx < 8) {
                        const itemData = Object.values(ITEMS).find(item => item.id === itemId);

                        if(itemData) {
                            slots[idx].innerHTML = itemData.icon + `<div class="inv-tooltip">${itemData.name}<br>${itemData.desc}</div>`;
                            slots[idx].classList.add('filled');
                        }
                    }
                });
            },
            add(itemObj) {
                if(!State.inventory.includes(itemObj.id)) {
                    State.inventory.push(itemObj.id);
                    if (document.getElementById('inventory-modal').classList.contains('active')) {
                         this.render();
                    }
                    Journal.add(`专砖: ${itemObj.name}. 转 住驻 .`, true);
                    Game.updateObjective();
                }
            }
        };

        // --- JOURNAL SYSTEM ---
        const Journal = {
            add(msg, isNew = false) {
                const db = document.getElementById('databank');
                const div = document.createElement('div');
                div.className = 'log-entry' + (isNew ? ' new' : '');
                div.innerText = `> ${msg}`;
                db.prepend(div); 
            }
        };

        // --- MODAL SYSTEM ---
        const Modal = {
            open(title, contentId) {
                document.getElementById('game-modal').classList.add('active');
                document.getElementById('modal-title').innerText = title;
                
                document.querySelectorAll('.minigame').forEach(el => el.classList.add('hidden'));
                document.getElementById(contentId).classList.remove('hidden');
            },
            close() {
                document.getElementById('game-modal').classList.remove('active');
            }
        };

        // --- RIDDLE LOGIC (STRICTER CHECK) ---
        const Riddle = {
            currentRef: null,
            currentReward: null,
            answerKey: null,

            open(title, text, answerKey, reward, ref) {
                this.currentRef = ref;
                this.currentReward = reward;
                this.answerKey = answerKey; 
                
                const box = document.getElementById('riddle-text');
                box.innerText = text;
                document.getElementById('riddle-input').value = "";
                document.getElementById('riddle-err').innerText = "";
                
                Modal.open(title, "riddle-container");
            },

            check() {
                const rawVal = document.getElementById('riddle-input').value.toLowerCase().trim();
                const normalizedVal = rawVal.replace(/\s/g, ''); // Remove all spaces
                let success = false;
                
                // Define strict keywords (in Hebrew)
                const needleKeys = ['拽', '', '转砖']; 
                const sensorKeys = ['转专', '']; 
                const chemKeys = ['拽', '驻爪', '-爪', 'co2']; 
                // Formula keys: "住" or "专拽" or the names of the colors/concepts
                const formulaKeys = ['住', '专拽', '', '', '专拽', '']; 

                if (this.answerKey === '拽' && needleKeys.some(key => normalizedVal.includes(key.replace(/\s/g, '')))) success = true;
                if (this.answerKey === '转专' && sensorKeys.some(key => normalizedVal.includes(key.replace(/\s/g, '')))) success = true;
                if (this.answerKey === '拽' && chemKeys.some(key => normalizedVal.includes(key.replace(/\s/g, '')))) success = true;
                if (this.answerKey === '住' && formulaKeys.some(key => normalizedVal.includes(key.replace(/\s/g, '')))) success = true;

                if(success) {
                    State.solved.push(this.currentRef);
                    Inventory.add(this.currentReward);
                    Modal.close();
                    document.querySelector(`[data-ref="${this.currentRef}"]`).classList.add('hidden'); 
                } else {
                    document.getElementById('riddle-err').innerText = "转砖 砖. 住 砖.";
                }
            }
        };

        // --- MINIGAME 1: TUNER (Gyro-Halteres) ---
        const Tuner = {
            target: null,
            start(domTarget) {
                this.target = domTarget;
                const canvas = document.getElementById('wave-canvas');
                const ctx = canvas.getContext('2d');
                const slider = document.getElementById('wave-slider');
                const status = document.getElementById('tuner-status');
                
                canvas.width = 300; canvas.height = 150; 

                let val = 50;
                let matchTimer = null;
                const requiredHoldTime = 1500; // 1.5 seconds hold time

                slider.oninput = (e) => val = e.target.value;

                function checkMatch(currentVal) {
                    // Sweet spot check (must be between 23 and 27)
                    return currentVal > 23 && currentVal < 27;
                }

                function draw() {
                    if(!document.getElementById('tuner-game').offsetParent) {
                         // Clear timer if modal is closed abruptly
                         if (matchTimer !== null) clearTimeout(matchTimer);
                         return; 
                    } 
                    
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0,0,300,150);
                    
                    // Target Wave (Fixed - represents the Halteres' natural frequency)
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#0f0'; 
                    ctx.beginPath();
                    for(let x=0; x<300; x++) {
                        let y = 75 + Math.sin(x * 0.1) * 30; // Fixed frequency (0.1)
                        if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                    }
                    ctx.stroke();

                    // User Wave (Adjustable Frequency)
                    ctx.strokeStyle = '#00e5ff'; 
                    ctx.beginPath();
                    let freq = 0.05 + (val-50)*0.002; 
                    for(let x=0; x<300; x++) {
                        let y = 75 + Math.sin(x * freq) * 30;
                        if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                    }
                    ctx.stroke();

                    const isMatched = checkMatch(val);

                    if (isMatched) {
                        status.innerText = "转: 注 ( 爪转...)";
                        status.style.color = "#00ff9d"; // Success green

                        if (matchTimer === null) {
                            // Start timer only if it's not already running
                            matchTimer = setTimeout(() => {
                                // Solution found!
                                status.innerText = "转: 注 ( !)";
                                setTimeout(() => {
                                    Modal.close();
                                    if(!State.solved.includes('window')) {
                                        State.solved.push('window');
                                        Inventory.add(ITEMS.gyro);
                                        document.querySelector(`[data-ref="window"]`).classList.add('hidden');
                                    }
                                }, 500); 
                            }, requiredHoldTime);
                        }
                    } else {
                        status.innerText = "转: 砖";
                        status.style.color = "#f00"; // Red
                        
                        // Reset timer if moved away
                        if (matchTimer !== null) {
                            clearTimeout(matchTimer);
                            matchTimer = null;
                        }
                    }
                    
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        // --- MINIGAME 2: KEYPAD ---
        const Keypad = {
            code: "3141", // The door code
            current: "",
            press(num) {
                this.current += num;
                document.getElementById('keypad-display').innerText = this.current;
                if(this.current.length === 4) {
                    if(this.current === this.code) {
                        Modal.close();
                        Journal.add("转 驻专爪. 住 注 驻转!", true);
                        Game.transitionToLab();
                    } else {
                        this.current = "";
                        document.getElementById('keypad-display').innerText = "砖";
                        setTimeout(() => document.getElementById('keypad-display').innerText = "_ _ _ _", 500);
                    }
                }
            }
        };

        // --- MINIGAME 3: CHEMISTRY ---
        const Chem = {
            mix: [],
            add(color) {
                this.mix.push(color);
                const beaker = document.getElementById('beaker-fill');
                beaker.style.height = (this.mix.length * 33) + "%";
                
                if(this.mix.length === 1) beaker.style.background = color;
                else beaker.style.background = "linear-gradient(to top, " + this.mix.join(',') + ")";

                if(this.mix.length === 2) {
                    // Check Recipe: Green + Blue (Bio + Tech)
                    if(this.mix.includes('green') && this.mix.includes('blue') && !this.mix.includes('red')) {
                        setTimeout(() => {
                            Modal.close();
                            Inventory.add(ITEMS.antidote);
                            Journal.add(" 住转 爪.  专 转  拽拽住!", true);
                            Game.updateObjective();
                            document.querySelector(`[data-ref="flask"]`).classList.add('hidden');
                        }, 1000);
                    } else {
                        setTimeout(() => {
                             this.mix = [];
                             beaker.style.height = "0%";
                             Journal.add("转注专转  爪. 专拽.", false);
                        }, 1000);
                    }
                }
            }
        };

        // --- PARTICLE FX (No change, graphical utility) ---
        const Fx = {
            init() {
                const cvs = document.getElementById('fx-canvas');
                const ctx = cvs.getContext('2d');
                cvs.width = window.innerWidth; cvs.height = window.innerHeight;
                
                const particles = [];
                for(let i=0; i<50; i++) particles.push({
                    x: Math.random()*cvs.width, y: Math.random()*cvs.height,
                    vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5,
                    size: Math.random()*2
                });

                function loop() {
                    ctx.clearRect(0,0,cvs.width,cvs.height);
                    ctx.fillStyle = State.isNight ? "rgba(255, 200, 50, 0.5)" : "rgba(255, 255, 255, 0.3)"; 
                    
                    particles.forEach(p => {
                        p.x += p.vx; p.y += p.vy;
                        if(p.x < 0) p.x = cvs.width; if(p.x > cvs.width) p.x = 0;
                        if(p.y < 0) p.y = cvs.height; if(p.y > cvs.height) p.y = 0;
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                        ctx.fill();
                    });
                    requestAnimationFrame(loop);
                }
                loop();
            }
        };

        // START
        window.onload = runBoot;

    </script>
</body>
</html>
