<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>×¤×¨×•×˜×•×§×•×œ ×”×¢×•×§×¥ | ××¢×¨×›×ª ××‘×¦×¢×™×ª V5.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@100;300;400;700;900&family=Rubik:wght@300;400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        /* * ==========================================================================
         * 1. SYSTEM CORE & VARIABLES
         * ==========================================================================
         */
        :root {
            --bg-void: #020202;
            --bg-panel: #0b0c10;
            --bg-overlay: rgba(0, 0, 0, 0.85);
            
            --border-dim: #1f2833;
            --border-light: #45a29e;
            
            /* ×¢×¨×›×ª ×¦×‘×¢×™×: ×”× ×“×¡×” (×–×”×‘/×¢× ×‘×¨) */
            --c-gold: #ffb700; 
            --c-gold-dim: rgba(255, 183, 0, 0.15);
            --c-cyan: #66fcf1;
            
            --status-ok: #00ff9d;
            --status-warn: #ffae00;
            --status-crit: #ff2a2a;

            --sidebar-w: 400px;
            --header-h: 70px;
            
            --font-ui: 'Heebo', sans-serif;
            --font-mono: 'Share Tech Mono', monospace;
        }

        /* ××™×¤×•×¡ ××œ× ×•×× ×™×¢×ª ×”×ª× ×”×’×•×™×•×ª ×“×¤×“×¤×Ÿ */
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            touch-action: manipulation;
        }

        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            background-color: var(--bg-void);
            color: #e0e0e0;
            font-family: var(--font-ui);
            overflow: hidden;
            overscroll-behavior: none;
        }

        /* ××¤×§×˜ CRT (××¡×š ×™×©×Ÿ) ×’×œ×•×‘×œ×™ */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none; z-index: 9999;
            opacity: 0.6;
        }

        /* ×’×œ×™×œ×” ××•×ª×××ª */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--c-gold); border-radius: 2px; }

        /* * ==========================================================================
         * 2. BOOT SEQUENCE UI
         * ==========================================================================
         */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: var(--font-mono); direction: ltr;
        }

        .terminal-box {
            width: 90%; max-width: 800px; height: 60vh;
            border: 1px solid #333; padding: 20px;
            background: #050505; color: var(--c-cyan);
            overflow: hidden; margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(102, 252, 241, 0.1);
            position: relative;
        }

        .boot-line {
            display: block; font-size: 14px; margin-bottom: 4px;
            text-shadow: 0 0 5px var(--c-cyan);
        }
        
        .loading-wrapper {
            width: 90%; max-width: 800px; height: 4px; background: #222;
            position: relative; overflow: hidden;
        }
        .loading-fill {
            height: 100%; width: 0%; background: var(--c-gold);
            box-shadow: 0 0 10px var(--c-gold);
            transition: width 0.1s linear;
        }

        /* * ==========================================================================
         * 3. MAIN GAME LAYOUT
         * ==========================================================================
         */
        #main-interface {
            display: grid;
            grid-template-columns: 1fr var(--sidebar-w);
            grid-template-rows: var(--header-h) 1fr;
            width: 100vw; height: 100vh; height: 100dvh;
            opacity: 0; transition: opacity 1s;
        }

        /* HEADER */
        #header {
            grid-column: 1 / -1;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-dim);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .logo-section h1 {
            font-family: 'Rubik', sans-serif; font-size: 24px; font-weight: 900;
            margin: 0; color: var(--c-gold); letter-spacing: 2px; text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 183, 0, 0.3);
        }
        .logo-section span { font-size: 11px; color: #666; letter-spacing: 1px; }

        .indicators { display: flex; gap: 20px; font-size: 12px; font-family: var(--font-mono); }
        .ind { display: flex; align-items: center; gap: 8px; opacity: 0.4; transition: 0.3s; }
        .ind.active { opacity: 1; color: var(--status-ok); text-shadow: 0 0 5px var(--status-ok); }
        .ind.danger { opacity: 1; color: var(--status-crit); text-shadow: 0 0 5px var(--status-crit); animation: blink 1s infinite; }
        .led { width: 6px; height: 6px; border-radius: 50%; background: currentColor; box-shadow: 0 0 8px currentColor; }

        /* VIEWPORT (GAME WORLD) */
        #viewport {
            position: relative; background: #000;
            overflow: hidden; border-left: 1px solid var(--border-dim);
            cursor: crosshair;
        }

        .layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: opacity 1.5s, transform 5s; opacity: 0; z-index: 1;
        }
        
        #layer-train { background-image: url('https://i.ibb.co/7tQt5S0h/Gemini-Generated-Image-prcu4rprcu4rprcu.png'); opacity: 1; }
        #layer-hallway { background-image: url('https://i.ibb.co/svJJmvYr/Gemini-Generated-Image-l4kaehl4kaehl4ka.png'); filter: brightness(0.4) sepia(1) hue-rotate(180deg); }
        #layer-engine { background-image: url('https://i.ibb.co/d04yrgRx/Gemini-Generated-Image-j02tg6j02tg6j02t.png'); filter: brightness(0.3) contrast(1.2); }

        #fx-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        
        #overlay-gas { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, rgba(0,255,100,0.1), transparent 80%); z-index: 6; pointer-events: none; opacity: 0; transition: 1s; mix-blend-mode: screen; }
        #overlay-thermal { position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(180deg, rgba(0,50,0,0.2), transparent), repeating-linear-gradient(0deg, transparent, transparent 2px, #00ff00 3px); background-size: 100% 4px; filter: contrast(2) invert(1) brightness(1.2); mix-blend-mode: hard-light; z-index: 7; opacity: 0; pointer-events: none; transition: 0.5s; }
        #overlay-dark { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at 50% 50%, transparent 150px, #000 500px); z-index: 8; opacity: 0; pointer-events: none; transition: 2s; }

        /* HOTSPOTS */
        #interact-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 20; }
        
        .hotspot {
            position: absolute; width: 64px; height: 64px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0; transition: 0.3s;
            border-radius: 50%;
        }
        
        .reticle {
            position: absolute; width: 100%; height: 100%;
            border: 1px dashed rgba(255, 183, 0, 0.4); border-radius: 50%;
            animation: spin-slow 10s linear infinite;
        }
        .corner-marks {
            position: absolute; width: 60%; height: 60%;
            border: 2px solid var(--c-gold);
            transform: rotate(45deg); transition: 0.3s;
            box-shadow: 0 0 10px var(--c-gold-dim);
        }

        .scanner-on .hotspot { opacity: 0.6; }
        .hotspot:hover, .hotspot:active { opacity: 1 !important; transform: scale(1.1); }
        .hotspot:hover .corner-marks { background: var(--c-gold-dim); box-shadow: 0 0 20px var(--c-gold); }

        .label {
            position: absolute; bottom: -30px; 
            font-family: var(--font-mono); font-size: 12px; color: var(--c-gold);
            background: rgba(0,0,0,0.9); padding: 4px 8px; border: 1px solid var(--c-gold);
            opacity: 0; transition: 0.3s; white-space: nowrap; pointer-events: none;
        }
        .hotspot:hover .label { opacity: 1; }

        /* SIDEBAR */
        #sidebar {
            background: rgba(12, 13, 16, 0.98); border-left: 1px solid var(--border-dim);
            display: flex; flex-direction: column; padding: 20px; gap: 15px;
            box-shadow: -5px 0 30px rgba(0,0,0,0.5); z-index: 50; overflow-y: auto;
        }

        .panel {
            background: rgba(255,255,255,0.02); border: 1px solid var(--border-dim);
            border-radius: 4px; padding: 15px; position: relative;
        }
        .p-title {
            font-family: 'Rubik'; font-size: 13px; color: var(--c-gold);
            text-transform: uppercase; border-bottom: 1px solid #333;
            padding-bottom: 5px; margin-bottom: 10px; letter-spacing: 1px;
        }

        #log-feed {
            height: 120px; overflow-y: auto; font-size: 14px; line-height: 1.5; color: #ccc;
        }
        .log-item { margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed #222; animation: fadeIn 0.3s; }
        .log-item strong { color: var(--c-gold); }

        /* SCANNER BUTTON */
        #btn-scanner {
            width: 100%; padding: 15px;
            background: transparent; border: 1px solid var(--c-cyan); color: var(--c-cyan);
            font-family: 'Rubik'; font-weight: 700; font-size: 16px; cursor: pointer;
            transition: 0.3s; display: flex; justify-content: center; gap: 10px;
            text-transform: uppercase;
        }
        #btn-scanner.active { background: rgba(102, 252, 241, 0.15); box-shadow: 0 0 20px rgba(102, 252, 241, 0.2); color: #fff; border-color: #fff; }

        /* CRAFTING */
        .craft-container { display: flex; flex-direction: column; gap: 10px; }
        .craft-slots { display: flex; gap: 5px; }
        .c-slot {
            flex: 1; aspect-ratio: 1; background: #000; border: 1px dashed #444;
            display: flex; justify-content: center; align-items: center; font-size: 24px;
            color: #333; transition: 0.3s;
        }
        .c-slot.filled { border-color: var(--c-gold); color: #fff; box-shadow: inset 0 0 10px var(--c-gold-dim); }

        #btn-craft {
            width: 100%; padding: 12px; background: #222; border: none; color: #555;
            font-weight: bold; cursor: not-allowed; transition: 0.3s;
        }
        #btn-craft.ready { background: var(--c-gold); color: #000; cursor: pointer; box-shadow: 0 0 15px var(--c-gold-dim); }

        /* INVENTORY */
        #inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .inv-cell {
            aspect-ratio: 1; background: #080808; border: 1px solid #333; border-radius: 4px;
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .inv-cell.selected { border-color: var(--status-ok); box-shadow: 0 0 10px rgba(0,255,157,0.2); }

        /* * ==========================================================================
         * 4. MODALS & MINIGAMES
         * ==========================================================================
         */
        .modal-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px;
            backdrop-filter: blur(10px);
        }
        .modal-wrap.visible { opacity: 1; pointer-events: auto; }

        .modal-box {
            background: #0b0c10; border: 2px solid var(--c-gold);
            box-shadow: 0 0 40px rgba(255, 183, 0, 0.2);
            width: 600px; max-width: 100%; max-height: 90vh;
            border-radius: 8px; display: flex; flex-direction: column;
            overflow: hidden;
        }
        
        .modal-head {
            background: rgba(255, 183, 0, 0.1); border-bottom: 1px solid #333;
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-family: 'Rubik'; font-size: 18px; color: var(--c-gold); text-transform: uppercase; }
        .modal-close { font-size: 24px; cursor: pointer; color: #666; padding: 5px; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: center; }

        /* Game 1: Wave Tuner */
        #tuner-ui canvas { width: 100%; height: 200px; background: #000; border: 1px solid #333; margin-bottom: 15px; }
        input[type=range] { width: 100%; height: 40px; cursor: pointer; }
        .tuner-status { font-family: var(--font-mono); font-size: 20px; color: var(--status-crit); margin-top: 10px; }

        /* Game 2: Sonar */
        #sonar-circle {
            width: 280px; height: 280px; border-radius: 50%; border: 2px solid var(--status-ok);
            background: radial-gradient(#002200, #000); margin: 0 auto; position: relative; overflow: hidden;
        }
        #sonar-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: conic-gradient(transparent 0deg, rgba(0,255,157,0.5) 20deg, transparent 20deg);
            border-radius: 50%; animation: radar 3s linear infinite;
        }
        #sonar-blip {
            position: absolute; width: 24px; height: 24px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 15px #fff; cursor: pointer; opacity: 0; transition: 0.1s;
        }

        /* Intro modal specific */
        #modal-intro .modal-box { max-width: 700px; text-align: center; padding-bottom: 10px; }
        #modal-intro .modal-body p { font-size: 18px; color: #ccc; margin-bottom: 20px; }

        /* Quiz modal */
        #modal-quiz .choices { display:flex; flex-direction:column; gap:10px; margin-top:10px; text-align:right; }
        .choice-btn { padding: 12px 16px; border:1px solid #333; background:transparent; cursor:pointer; text-align:right; font-size:16px; border-radius:6px; color:#ffffff;}
        .choice-btn:hover { transform:scale(1.02); color:#ffffff;}

        /* Transition modal */
        #modal-transition .modal-box { max-width: 420px; text-align: center; }

        /* * ==========================================================================
         * 5. MOBILE RESPONSIVE OVERRIDES
         * ==========================================================================
         */
        @media (max-width: 900px) {
            #main-interface {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr auto; /* Header, Game, Controls */
            }
            
            #header { padding: 0 15px; height: 60px; }
            .logo-section h1 { font-size: 18px; }
            .logo-section span { display: none; }
            
            #viewport { border-left: none; border-bottom: 1px solid var(--border-dim); }
            
            #sidebar {
                border-left: none; border-top: 1px solid var(--border-dim);
                width: 100%; height: auto; max-height: 45vh;
                padding: 10px; gap: 10px;
            }
            
            .panel { padding: 10px; margin-bottom: 0; }
            #log-feed { height: 70px; font-size: 13px; }
            
            #btn-scanner { padding: 10px; font-size: 14px; }
            
            /* Horizontal scrolling inventory for mobile */
            #inventory-grid { grid-template-columns: repeat(6, 1fr); overflow-x: auto; padding-bottom: 5px; }
            .inv-cell { min-width: 50px; font-size: 20px; }
            
            .hotspot { width: 70px; height: 70px; }
            .hs-label { font-size: 11px; bottom: -25px; }
        }

        @keyframes blink { 50% { opacity: 0.3; } }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin-slow { 100% { transform: rotate(360deg); } }
        @keyframes radar { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="scanlines"></div>

    <div id="boot-screen">
        <div class="terminal-box" id="term-out"></div>
        <div class="loading-wrapper">
            <div class="loading-fill" id="boot-progress"></div>
        </div>
    </div>

    <div id="main-interface">
        
        <header id="header">
            <div class="logo-section">
                <h1>×¤×¨×•×˜×•×§×•×œ ×”×¢×•×§×¥</h1>
                <span>×××©×§ ××”× ×“×¡ V5.0</span>
            </div>
            <div class="indicators">
                <div class="ind danger active" id="ind-gas"><div class="led"></div> ×’×– ×¨×¢×™×œ</div>
                <div class="ind" id="ind-thermal"><div class="led"></div> ×ª×¨××™</div>
                <div class="ind" id="ind-audio"><div class="led"></div> ×©××¢</div>
                <div class="ind" id="ind-timer"><div class="led" style="background:var(--c-gold)"></div><span id="timer-display">03:00</span></div>
            </div>
        </header>
                <div id="modal-story" class="modal-wrap visible">
          <div class="modal-box" style="max-width:900px;">
            <div class="modal-head">
              <div class="modal-title">×¤×¨×•×˜×•×§×•×œ ×”×¢×•×§×¥</div>
            </div>
            <div class="modal-body" style="text-align:right; line-height:1.6; font-size:15px; color:#ddd; max-height:70vh; overflow-y:auto;">
        
        <p><strong>×›×¨×’×¢ × ×›× ×¡×ª ×œ×¨×›×‘×ª ×”×§×˜×œ× ×™×ª ×ª× ×¡×” ×œ×©×¨×•×“.</strong></p>
        
        <p><strong>×”×“×××” ×‘×§×¨×•×Ÿ ××¡×¤×¨ 5</strong> ××•×¤×¨×ª ×‘×¨×’×¢ ××—×“. ×‘×–×” ××—×¨ ×–×”, ×¤×ª×—×™ ×”××•×•×¨×•×¨ ×‘×ª×§×¨×” × ×¤×ª×—×™× ×‘×œ×—×© ××¨×•×š ×•××¦××¨×¨, ×•××“×™× ×™×¨×§×¨×§×™× ××ª×—×™×œ×™× ×œ×–×œ×•×’ ×¤× ×™××”. ×ª×©×¢×ª ×”× ×•×¡×¢×™× ×”××—×¨×™× ×‘×§×¨×•×Ÿ ×¦×•×¨×—×™× ×‘×‘×”×œ×”, ×“×•×¤×§×™× ×¢×œ ×”×“×œ×ª×•×ª ×”× ×¢×•×œ×•×ª ×‘×—×•×¡×¨ ××•× ×™×.</p>
        
        <p>×¨×§ ××ª×” × ×•×ª×¨ ×¢×•××“ ×‘××¨×›×– ×”×—×“×¨ ×œ×œ× ×ª×–×•×–×”. ×›××”× ×“×¡ ××›×•× ×•×ª ××‘×¨×™×§, ××ª×” ×œ× × ×•×ª×Ÿ ×œ×¤×—×“ ×œ×”×©×ª×œ×˜ ×¢×œ×™×š. ×‘×–××Ÿ ×©×”××—×¨×™× ×××‘×“×™× ×¢×©×ª×•× ×•×ª, ×”××•×— ×©×œ×š ×¢×•×‘×¨ ×œ××¦×‘ ×¢×‘×•×“×”: × ×™×ª×•×— ×‘×¢×™×”, ××¦×™××ª ×¤×ª×¨×•×Ÿ. ××ª×” ×¨×•×›×Ÿ ××¢×œ ×”××–×•×•×“×” ×”×›×¡×•×¤×” ×©×”×•× ×—×” ×‘××¨×›×– ×”×§×¨×•×Ÿ.</p>
        
        <p>×”××¡×š ×¢×œ ×”×§×™×¨ ××¨×™×¦×“ ×•×“××•×ª×• ×©×œ ×“"×¨ ××¨×§×“×™×•×¡ ××•×¤×™×¢×”.  
        "×”×’×– ×”×–×” ×™×”×¨×•×’ ××ª ×›×•×œ×›× ×ª×•×š ×“×§×•×ª," ×”×•× ××—×™×™×š.  
        "×”× ×•×’×“×Ÿ × ××¦× ××¦×œ×™, ×‘×§×¨×•×Ÿ ×”×§×˜×¨. ×™×© ×œ×›× ×”×–×“×× ×•×ª ××—×ª."</p>
        
        <p><strong>×”××©×™××” ×”×¨××©×•× ×”: × ×˜×¨×•×œ ×”×× ×’× ×•×Ÿ</strong><br>
        ×”×’×– × ×¤×œ×˜ ××ª×•×š ×“×™×–×” ××©×•×¨×™×™× ×ª ×”××•×’× ×ª ×‘××¢×¨×›×ª ×œ×—×¥ ×¨×’×™×©×”. ××ª×” ××‘×™×Ÿ ×©×›×œ × ×™×¡×™×•×Ÿ ×¡×ª×™××” ×‘×›×•×— ×™×’×¨×•× ×œ×¤×™×¦×•×¥ ×”××›×œ ×›×•×œ×•.</p>
        
        <p>××ª×” ××–×”×” ×× ×•×¢ ×¨×˜×˜ ×–×¢×™×¨, ××—×˜ ×’××™×©×” ×•×¡×•×œ×œ×ª ×œ×™×ª×™×•×.  
        ×¨××– ××”×‘×”×‘ ×¢×œ ×”×¦×’: <em>â€œ×”×™×ª×•×© ×§×•×“×—, ×œ× ×“×•×§×¨.â€</em></p>
        
        <p><strong>×”××©×™××” ×”×©× ×™×™×”: ×”×“×¨×š ×œ×§×˜×¨</strong><br>
        ×”×“×œ×ª ×œ×§×¨×•×Ÿ ×”×‘× × ×¤×ª×—×ª ×œ××¡×“×¨×•×Ÿ ×—×©×•×š ××œ× ×‘×œ×™×™×–×¨×™× ×•×‘×•×¨×•×ª.  
        ×¢×“×©×•×ª, ×—×™×™×©×Ÿ ×ª×¨××™ ×•×—×œ×§×™ ×¨×—×¤×Ÿ ×”×•×¤×›×™× ×œ××©×§×¤×™ ×¨××™×™×” ×‘×™×•××™××˜×™×™×.</p>
        
        <p><strong>×”×©×™×: ×”×—×“×¨ ×”×—×©×•×š</strong><br>
        ×¤×¢×™××•×ª ×œ×‘. ×‘×•×Ö¾×‘×•×.  
        ××ª×” ×××–×™×Ÿ, ×××ª×¨, ×•×¤×•×¢×œ.</p>
        
        <p><strong>×‘×–×›×•×ª ×§×•×¨ ×”×¨×•×— ×©×œ×š ×•×”×”×‘× ×” ×©×œ ×× ×’× ×•× ×™ ×”×˜×‘×¢ â€” ×›×•×œ× × ×™×¦×œ×•.</strong></p>
        
        <button id="start-game-btn"
          style="margin-top:20px;width:100%;padding:14px;font-size:16px;
          background:var(--c-gold);border:none;cursor:pointer;border-radius:6px;">
        ×”×ª×—×œ
        </button>
        
            </div>
          </div>
        </div>

        <main id="viewport">
            <canvas id="fx-canvas"></canvas>
            
            <div id="overlay-gas" style="opacity:1;"></div>
            <div id="overlay-thermal"></div>
            <div id="overlay-dark"></div>

            <div class="layer" id="layer-engine"></div>
            <div class="layer" id="layer-hallway"></div>
            <div class="layer" id="layer-train"></div>

            <div id="interact-layer">
                <div class="hotspot" id="hs-suitcase" data-id="suitcase" style="top:70%; left:75%;"><div class="reticle"></div><div class="corner-marks"></div><div class="label">××–×•×•×“×”</div></div>
                <div class="hotspot" id="hs-seat" data-id="seat" style="top:60%; left:20%;"><div class="reticle"></div><div class="corner-marks"></div><div class="label">××•×©×‘</div></div>
                <div class="hotspot" id="hs-vent" data-id="vent" style="top:5%; left:50%; width:150px; height:80px;"><div class="reticle"></div><div class="corner-marks"></div><div class="label">×“×™×–×” ××©×•×¨×™×™× ×ª</div></div>

                <div class="hotspot" id="hs-debris" data-id="debris" style="top:80%; left:30%; display:none;"><div class="reticle"></div><div class="corner-marks"></div><div class="label">×’×¨×•×˜××•×ª</div></div>
                <div class="hotspot" id="hs-panel" data-id="panel" style="top:50%; left:10%; display:none;"><div class="reticle"></div><div class="corner-marks"></div><div class="label">×¤×× ×œ</div></div>
                <div class="hotspot" id="hs-door" data-id="door" style="top:35%; left:50%; width:100px; height:180px; display:none;"><div class="reticle"></div><div class="corner-marks"></div><div class="label">×“×œ×ª ×× ×•×¢</div></div>

                <div class="hotspot" id="hs-closet" data-id="closet" style="top:60%; left:15%; display:none;"><div class="reticle"></div><div class="corner-marks"></div><div class="label">××¨×•×Ÿ ×¦×™×•×“</div></div>
                <div class="hotspot" id="hs-arcadius" data-id="arcadius" style="top:35%; left:65%; width:120px; height:250px; display:none; opacity:0; pointer-events:none;"></div>
            </div>
        </main>

        <aside id="sidebar">
            <div class="panel" style="flex:1;">
                <div class="p-title">×™×•××Ÿ ××™×¨×•×¢×™×</div>
                <div id="log-feed"></div>
            </div>

            <button id="btn-scanner" onclick="Game.toggleScanner()">
                ğŸ‘ï¸ ×¡×•×¨×§ ×ª×¨××™: ×›×‘×•×™
            </button>

            <div class="panel">
                <div class="p-title">×©×•×œ×—×Ÿ ×¢×‘×•×“×” (×‘×—×¨ 3)</div>
                <div class="craft-container">
                    <div class="craft-slots">
                        <div class="c-slot" id="slot-0"></div>
                        <div class="c-slot" id="slot-1"></div>
                        <div class="c-slot" id="slot-2"></div>
                    </div>
                    <button id="btn-craft" onclick="Crafting.craft()">×‘×¦×¢ ××™× ×˜×’×¨×¦×™×”</button>
                </div>
            </div>

            <div class="panel">
                <div class="p-title">×¦×™×•×“</div>
                <div id="inv-grid"></div>
            </div>
        </aside>
    </div>

    <div id="modal-msg" class="modal-wrap">
        <div class="modal-box" style="max-width:400px; text-align:center;">
            <div class="modal-head">
                <div class="modal-title">×”×•×“×¢×”</div>
                <div class="modal-close" onclick="Modal.close('modal-msg')">Ã—</div>
            </div>
            <div class="modal-body">
                <p id="msg-text" style="font-size:16px; margin-bottom:20px; color:#ccc;"></p>
                <button onclick="Modal.close('modal-msg')" style="width:100%; padding:10px; background:#333; color:#fff; border:1px solid #666;">××™×©×•×¨</button>
            </div>
        </div>
    </div>

    <div id="modal-intro" class="modal-wrap visible">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title">×”×ª×—×œ×ª ××©×—×§</div>
            </div>
            <div class="modal-body">
                <p>× ×›× ×¡×ª ×œ×—×“×¨ ×‘×¨×™×—×” ×•×™×© ×œ×š ×©×œ×•×© ×“×§×•×ª ×‘×œ×‘×“ ×œ×¡×™×™× ××•×ª×•.</p>
                <p style="color:#aaa; font-size:14px; margin-top:0;">×œ××—×¨ ×©×ª×œ×—×¥ ×¢×œ "×”×ª×—×œ", ×”×˜×™×™××¨ ×™×ª×—×™×œ. ×‘××”×œ×š ××™×¡×•×£ ×”×—×•××¨×™× ×™×•×¤×™×¢×• ×—×™×“×•×ª ×¨×™×‘×•×™-×‘×—×™×¨×” ×œ×¤×™ ×§×¨××•× ×™× (×—×“×¨×™×).</p>
                <button id="start-game-btn" style="padding:12px 18px; font-size:16px; background:var(--c-gold); border:none; cursor:pointer; border-radius:6px;">×”×ª×—×œ</button>
            </div>
        </div>
    </div>

    <div id="modal-quiz" class="modal-wrap">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title">×—×™×“×”</div>
                <div class="modal-close" onclick="Modal.close('modal-quiz')">Ã—</div>
            </div>
            <div class="modal-body" id="quiz-body">
                <div id="quiz-text" style="text-align:right; color:#ddd; font-size:16px;"></div>
                <div class="choices" id="quiz-choices"></div>
            </div>
        </div>
    </div>

    <div id="modal-transition" class="modal-wrap">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title">××¢×‘×¨</div>
            </div>
            <div class="modal-body">
                <p style="font-size:18px; color:#ccc;">×¢×‘×¨×ª ××ª ×”×§×¨×•×Ÿ ×‘×”×¦×œ×—×”</p>
                <button onclick="Modal.close('modal-transition')" style="width:100%; padding:10px; background:#333; color:#fff; border:1px solid #666;">×”××©×š</button>
            </div>
        </div>
    </div>

    <div id="modal-tuner" class="modal-wrap">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title">×›×™×•×œ ×ª×“×¨ ×¨×˜×˜</div>
            </div>
            <div class="modal-body" id="tuner-ui">
                <p style="color:#888;">×”×ª×× ××ª ×”×’×œ ×”×›×—×•×œ ×œ×’×œ ×”×™×¨×•×§ ×›×“×™ ×œ×—×“×•×¨ ××ª ×”×“×™×–×”.</p>
                <canvas id="wave-canvas"></canvas>
                <input type="range" id="wave-slider" min="1" max="100" value="50">
                <div id="wave-status" class="tuner-status">×œ× ××¡×•× ×›×¨×Ÿ</div>
            </div>
        </div>
    </div>

    <div id="modal-sonar" class="modal-wrap">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title">××™×ª×•×¨ ×©××¢ ×›×™×•×•× ×™</div>
            </div>
            <div class="modal-body">
                <p style="color:#888;">×”×§×©×‘ ×œ×¤×¢×™××•×ª ×”×œ×‘. ×œ×—×¥ ×¢×œ ×”× ×§×•×“×” ×”×œ×‘× ×” ×›×©×”×™× ××•×¤×™×¢×”.</p>
                <div id="sonar-circle">
                    <div id="sonar-line"></div>
                    <div id="sonar-blip"></div>
                </div>
            </div>
        </div>
    </div>
    

    <script>
        /**
         * ==========================================================================
         * GAME DATA
         * ==========================================================================
         */

        const DB = {
            Items: {
                MOTOR: { id:'MOTOR', icon:'âš™ï¸', name:'×× ×•×¢ ×¨×˜×˜' },
                NEEDLE: { id:'NEEDLE', icon:'ğŸ“', name:'××—×˜' },
                BATTERY: { id:'BATTERY', icon:'ğŸ”‹', name:'×¡×•×œ×œ×”' },
                DRILL: { id:'DRILL', icon:'ğŸ¦Ÿ', name:'××§×“×— ×¨×˜×˜', tool:true },
                
                LENS: { id:'LENS', icon:'ğŸ‘“', name:'×¢×“×©×•×ª' },
                SENSOR: { id:'SENSOR', icon:'ğŸŒ¡ï¸', name:'×—×™×™×©×Ÿ' },
                PARTS: { id:'PARTS', icon:'ğŸš', name:'×—×œ×§×™ ×¨×—×¤×Ÿ' },
                GOGGLES: { id:'GOGGLES', icon:'ğŸ•¶ï¸', name:'××©×§×¤×™ ×ª×¨××™', tool:true },
                
                MIC: { id:'MIC', icon:'ğŸ™ï¸', name:'××™×§×¨×•×¤×•×Ÿ' },
                HEADSET: { id:'HEADSET', icon:'ğŸ§', name:'××•×–× ×™×™×”' },
                WIRE: { id:'WIRE', icon:'ğŸ”Œ', name:'×—×•×˜' },
                SONAR: { id:'SONAR', icon:'ğŸ“¡', name:'×¡×•×¨×§ ×§×•×œ×™', tool:true }
            },
            Story: {
                start: "×”×“×××” ×‘×§×¨×•×Ÿ 5 ×”×•×¤×¨×”. ×’×– ×¨×¢×™×œ ×××œ× ××ª ×”×—×œ×œ. ×“×™×–×” ××©×•×¨×™×™× ×ª ××•× ×¢×ª ×™×¦×™××”. ×¢×œ×™×š ×œ×‘× ×•×ª ×›×œ×™ ×—×“×™×¨×” ×¢×“×™×Ÿ.",
                p1_done: "×”×“×™×–×” × ×•×˜×¨×œ×”! ×”×’×– ×¤×¡×§. ×”×“×œ×ª × ×¤×ª×—×” ×œ××¡×“×¨×•×Ÿ ×—×©×•×š ××œ× ×‘××œ×›×•×“×•×ª ×œ×™×™×–×¨.",
                p2_done: "×”××©×§×¤×™×™× ×—×•×©×¤×™× ××ª ×”×œ×™×™×–×¨×™×. ×¢×‘×¨×ª ×‘×‘×˜×—×” ×œ×§×¨×•×Ÿ ×”×× ×•×¢. ×”××“×¢×Ÿ ××¡×ª×ª×¨ ×‘×—×•×©×š ×¢× ×”× ×•×’×“×Ÿ.",
                win: "×ª×¤×¡×ª ××•×ª×•! ×—×˜×¤×ª ××ª ×”× ×•×’×“×Ÿ. ×”×©×™×œ×•×‘ ×©×œ ×§×•×¨ ×¨×•×— ×•×”× ×“×¡×ª ×”×˜×‘×¢ ×”×¦×™×œ ××ª ×›×•×œ×."
            }
        };

        const State = {
            phase: 1,
            inventory: [],
            craftSlots: [],
            solved: [],
            scanner: false
        };

        /**
         * ==========================================================================
         * QUIZ DATA (×”××™×œ×™× ×©×œ ×”×—×™×“×•×ª × ×©××¨×• ×‘×“×™×•×§ ×›×¤×™ ×©×”×ª×§×‘×œ×•)
         * ==========================================================================
         */
        const QuizBank = {
            // ×—×™×“×” 1 (×§×¨×•×Ÿ ×¨××©×•×Ÿ)
            q1: {
                text: "×—×™×“×” 1 (×§×¨×•×Ÿ ×¨××©×•×Ÿ): ××™×–×” ××¡×•×’×™ ×”××—×˜×™× ×”×‘××™× ××™× ×• ××›××™×‘? (×¨××–: ××ª ×”××—×˜ ×©×œ ×”×™×ª×•×© ×œ× × ×™×ª×Ÿ ×œ×”×¨×’×™×©)",
                choices: [
                    "1) ××—×˜ ××—×•×¡×¤×¡ ×•×¨×•×˜×˜.",
                    "2) ××—×˜ ×œ×¢×™×¨×•×™ ×“×",
                    "3) ××—×˜ ×œ×‘×™×•×¤×¡×™×” ×‘××— ×”×¢×¦×",
                    "4) ××—×˜ ×©×œ ×‘×“×™×§×ª ×“× ××—×˜ ×¤×¨×¤×¨×™×ª"
                ],
                correctIndex: 0 // ×ª×©×•×‘×”: ×
            },
            // ×—×™×“×” 2 (×§×¨×•×Ÿ ×©× ×™)
            q2: {
                text: "×—×™×“×” 2 (×§×¨×•×Ÿ ×©× ×™): ××”×• ×”×™×ª×¨×•×Ÿ ×”××‘×¦×¢×™ ×”×¢×™×§×¨×™ ×©×œ ×¨×—×¤×Ÿ ×”×‘× ×•×™ ×›××• ×™×ª×•×©? (×¨××–: ×›×©×”×™×ª×•×© ×§×©×” ×œ×”×‘×—×™×Ÿ ×‘×•.)",
                choices: [
                    "×. ×™×›×•×œ×ª ×œ×˜×•×¡ ×œ×—×œ×œ ×”×—×™×¦×•×Ÿ.",
                    "×‘. ×™×›×•×œ×ª ×œ×©××ª ××©×§×œ×™× ×›×‘×“×™× ×××•×“ ×›××• ×˜× ×§×™×.",
                    "×’. ×™×›×•×œ×ª ×ª××¨×•×Ÿ ×’×‘×•×”×” ×‘×—×œ×œ×™× ×¦×¤×•×¤×™× ×•×™×¦×™×‘×•×ª ×‘×¨×•×—×•×ª, ×”××ª××™××” ×œ×¨×™×’×•×œ.",
                    "×“. ××”×™×¨×•×ª ×˜×™×¡×” ×©×¢×•×‘×¨×ª ××ª ××”×™×¨×•×ª ×”×§×•×œ"
                ],
                correctIndex: 2 // ×ª×©×•×‘×”: ×’
            },
            // ×—×™×“×” 3 (×§×¨×•×Ÿ ×©× ×™)
            q3: {
                text: "×—×™×“×” 3 (×§×¨×•×Ÿ ×©× ×™): ×”×™×ª×•×© ××¡×•×’×œ ×œ××ª×¨ ×‘× ×™ ××“× ×××¨×—×§ ×¨×‘ ×‘×¢×™×§×¨ ×‘×–×›×•×ª ×–×™×”×•×™ ×©×œ:",
                choices: [
                    "×. ×ª× ×•×¢×•×ª ×’×•×£ ××”×™×¨×•×ª.",
                    "×‘. ×¦×‘×¢ ×”×‘×’×“×™× ×©×× ×• ×œ×•×‘×©×™×.",
                    "×’. ×¤×œ×™×˜×ª ×¤×—××Ÿ ×“×•-×—××¦× ×™ (CO2) ×‘× ×©×™××” ×©×œ× ×•.",
                    "×“. ×’×œ×™ ×¨×“×™×• ×©×”×˜×œ×¤×•×Ÿ ×©×œ× ×• ××©×“×¨"
                ],
                correctIndex: 2 // ×ª×©×•×‘×”: ×’
            }
        };

        /**
         * ==========================================================================
         * GAME ENGINE
         * ==========================================================================
         */
        const Game = {
            init() {
                Inventory.init();
                Story.log(DB.Story.start);
                Fx.start();
                
                // Hotspot Listeners
                document.querySelectorAll('.hotspot').forEach(el => {
                    el.addEventListener('click', () => this.handleHotspot(el.dataset.id));
                });
            },

            handleHotspot(id) {
                // Scanner Check logic (×œ× ×œ×©× ×•×ª ×‘×“×™×§×” ×–×•)
                if (!State.scanner && id !== 'vent' && id !== 'door') {
                    Modal.msg("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××•×‘×™×™×§×˜. × ×“×¨×©×ª ×¡×¨×™×§×” ×ª×¨××™×ª.");
                    return;
                }
                
                if (State.solved.includes(id)) return;

                // ×—×™×‘×•×¨ ×‘×™×Ÿ × ×§×•×“×•×ª ××™×¡×•×£ ×œ×—×™×“×•×ª ×œ×¤×™ ×§×¨××•× ×™×
                const quizMap = {
                    // ×§×¨×•×Ÿ ×¨××©×•×Ÿ: suitcase/seat -> ×—×™×“×” q1
                    suitcase: QuizBank.q1,
                    // ×§×¨×•×Ÿ ×©× ×™: debris -> q2, panel -> q3
                    debris: QuizBank.q2,
                    panel: QuizBank.q3
                };

                // ×× ×™×© ×—×™×“×” ××©×•×™×›×ª ×œ××•×‘×™×™×§×˜ ×•× ×©××œ×ª ×›×‘×¨ - ××¤×©×¨ ×œ××¡×•×£ ×œ×œ× ×—×–×¨×”
                const shouldAsk = quizMap[id] && !Quiz.isAnsweredFor(id);

                if (shouldAsk) {
                    Quiz.ask(quizMap[id], (ok) => {
                        if (ok) {
                            // ×§×¨×™××” ×œ××™×¡×•×£ ×œ××—×¨ ×ª×©×•×‘×” × ×›×•× ×”
                            if (['suitcase','seat'].includes(id)) {
                                if (id === 'suitcase') this.collect(['MOTOR', 'BATTERY'], id, "×× ×•×¢ ×•×¡×•×œ×œ×”");
                                if (id === 'seat') this.collect(['NEEDLE'], id, "××—×˜ ××™×§×¨×•× ×™×ª");
                            }
                            if (id === 'debris') this.collect(['LENS', 'PARTS'], id, "×¢×“×©×•×ª ×•×—×œ×§×™×");
                            if (id === 'panel') this.collect(['SENSOR'], id, "×—×™×™×©×Ÿ ×ª×¨××™");
                            Quiz.markAnswered(id);
                        } else {
                            // ×ª×©×•×‘×” ×©×’×•×™×” - ×œ×”×¦×™×’ ×”×•×“×¢×”, ×•×œ× ×œ××¡×•×£
                            Modal.msg("×ª×©×•×‘×” ×©×’×•×™×”", "×”×ª×©×•×‘×” ×œ× × ×›×•× ×”. × ×¡×” ×©× ×™×ª ×‘××§×•× ××—×¨.");
                        }
                    });
                    return;
                }

                // PHASE 1 (×‘××™×“×” ×•×œ× ×”×™×ª×” ×—×™×“×” ××• ×›×‘×¨ × ×¢× ×ª×”)
                if (['suitcase', 'seat'].includes(id) && !shouldAsk) {
                    if (id === 'suitcase') this.collect(['MOTOR', 'BATTERY'], id, "×× ×•×¢ ×•×¡×•×œ×œ×”");
                    if (id === 'seat') this.collect(['NEEDLE'], id, "××—×˜ ××™×§×¨×•× ×™×ª");
                }

                if (id === 'vent') {
                    if (Inventory.has('DRILL')) Minigames.wave();
                    else Modal.msg("×¡×›× ×”", "× ×’×™×¢×” ×‘×“×™×–×” ×ª×¤×¢×™×œ ××ª ×”×× ×’× ×•×Ÿ. × ×“×¨×© ××§×“×— ×¨×˜×˜.");
                }

                // PHASE 2
                if (['debris', 'panel'].includes(id) && !shouldAsk) {
                    if (id === 'debris') this.collect(['LENS', 'PARTS'], id, "×¢×“×©×•×ª ×•×—×œ×§×™×");
                    if (id === 'panel') this.collect(['SENSOR'], id, "×—×™×™×©×Ÿ ×ª×¨××™");
                }
                if (id === 'door') {
                    if (Inventory.has('GOGGLES')) this.phase3();
                    else Modal.msg("×¡×›× ×”", "×—×•×©×š ××•×—×œ×˜. ××™ ××¤×©×¨ ×œ×¢×‘×•×¨ ×‘×œ×™ ×œ×¨××•×ª.");
                }

                // PHASE 3
                if (id === 'closet') this.collect(['MIC', 'HEADSET', 'WIRE'], id, "×¦×™×•×“ ×©××¢");
            },

            collect(keys, id, name) {
                keys.forEach(k => Inventory.add(DB.Items[k]));
                State.solved.push(id);
                const dom = document.querySelector(`[data-id="${id}"]`);
                if (dom) dom.style.display = 'none';
                Story.log(`××¦××ª: ${name}`);
            },

            toggleScanner() {
                State.scanner = !State.scanner;
                const btn = document.getElementById('btn-scanner');
                
                if (State.scanner) {
                    btn.style.color = '#fff';
                    btn.style.borderColor = '#fff';
                    btn.style.background = 'rgba(0, 242, 255, 0.2)';
                    document.body.classList.add('scanner-on');
                    Story.log("×¡×•×¨×§ ×ª×¨××™ ×¤×¢×™×œ.");
                } else {
                    btn.style.color = 'var(--c-cyan)';
                    btn.style.borderColor = 'var(--c-cyan)';
                    btn.style.background = 'transparent';
                    document.body.classList.remove('scanner-on');
                }
            },

            phase2() {
                State.phase = 2;
                Story.log(DB.Story.p1_done);
                
                document.getElementById('overlay-gas').style.opacity = 0;
                document.getElementById('ind-gas').classList.remove('active', 'danger');
                document.getElementById('ind-thermal').classList.add('active', 'danger');
                
                document.getElementById('layer-train').style.opacity = 0;
                document.getElementById('layer-hallway').style.opacity = 1;

                ['vent', 'suitcase', 'seat'].forEach(id => {
                    const el = document.querySelector(`[data-id="${id}"]`);
                    if(el) el.style.display = 'none';
                });
                
                ['debris', 'panel', 'door'].forEach(id => {
                    const el = document.querySelector(`[data-id="${id}"]`);
                    if (el) el.style.display = 'flex';
                });

                // ×ª×¦×•×’×ª ×“×£ ××¢×‘×¨ ×œ××—×¨ ××¢×‘×¨ ×§×¨×•×Ÿ ×¨××©×•×Ÿ
                setTimeout(() => Modal.transitionShow(), 200);
            },

            phase3() {
                State.phase = 3;
                Story.log(DB.Story.p2_done);
                
                document.getElementById('overlay-thermal').style.opacity = 1;
                setTimeout(() => document.getElementById('overlay-thermal').style.opacity = 0, 2000);
                
                document.getElementById('layer-hallway').style.opacity = 0;
                document.getElementById('layer-engine').style.opacity = 1;
                document.getElementById('overlay-dark').style.opacity = 1;

                document.getElementById('ind-thermal').classList.remove('active');
                document.getElementById('ind-audio').classList.add('active', 'danger');

                ['debris', 'panel', 'door'].forEach(id => {
                    const el = document.querySelector(`[data-id="${id}"]`);
                    if (el) el.style.display = 'none';
                });
                const closetEl = document.querySelector(`[data-id="closet"]`);
                if (closetEl) closetEl.style.display = 'flex';

                if (Inventory.has('SONAR')) Minigames.sonar();
                else Story.log("×¢×œ×™×š ×œ×‘× ×•×ª ×¡×•×¨×§ ×©××¢.");

                // ×ª×¦×•×’×ª ×“×£ ××¢×‘×¨ ×œ××—×¨ ××¢×‘×¨ ×§×¨×•×Ÿ ×©× ×™
                setTimeout(() => Modal.transitionShow(), 200);
            },

            win() {
                Modal.msg("××©×™××” ×”×•×©×œ××”!", DB.Story.win);
                
                // ×”×©××¨×ª ×”×©×—×§×Ÿ ×‘××¢×‘×“×” â€“ ×œ×œ× ×¨×™×¡×˜××¨×˜
                document.getElementById('interact-layer').style.pointerEvents = 'none';
                Story.log("×”××¢×‘×“×” × × ×¢×œ×”. ×›×œ ×”××¢×¨×›×•×ª ×©×§×˜×•×ª.");
            }
        };

        /**
         * ==========================================================================
         * INVENTORY & CRAFTING
         * ==========================================================================
         */
        const Inventory = {
            init() {
                const grid = document.getElementById('inv-grid');
                for (let i=0; i<8; i++) {
                    let div = document.createElement('div');
                    div.className = 'inv-cell';
                    div.id = `inv-${i}`;
                    div.onclick = () => this.toggle(i);
                    grid.appendChild(div);
                }
            },
            add(item) {
                if (this.has(item.id)) return;
                State.inventory.push(item);
                this.render();
            },
            has(id) { return State.inventory.some(i => i.id === id); },
            render() {
                for(let i=0; i<8; i++) {
                    const el = document.getElementById(`inv-${i}`);
                    el.innerHTML = ''; el.className = 'inv-cell';
                    if (State.inventory[i]) {
                        el.innerHTML = State.inventory[i].icon;
                        if (State.craftSlots.includes(i)) el.classList.add('selected');
                    }
                }
            },
            toggle(i) {
                if (!State.inventory[i]) return;
                if (State.craftSlots.includes(i)) {
                    State.craftSlots = State.craftSlots.filter(x => x !== i);
                } else if (State.craftSlots.length < 3) {
                    State.craftSlots.push(i);
                }
                this.render();
                Crafting.update();
            },
            consume() {
                State.craftSlots.sort((a,b) => b-a).forEach(i => State.inventory.splice(i, 1));
                State.craftSlots = [];
                this.render();
                Crafting.update();
            }
        };

        const Crafting = {
            update() {
                [0,1,2].forEach(i => document.getElementById(`slot-${i}`).innerHTML = '');
                State.craftSlots.forEach((invIdx, i) => {
                    document.getElementById(`slot-${i}`).innerHTML = State.inventory[invIdx].icon;
                });
                const btn = document.getElementById('btn-craft');
                btn.className = (State.craftSlots.length === 3) ? 'ready' : '';
            },
            craft() {
                if (State.craftSlots.length !== 3) return;
                const ids = State.craftSlots.map(i => State.inventory[i].id);
                
                if (this.check(ids, ['MOTOR','NEEDLE','BATTERY'])) {
                    Inventory.consume(); Inventory.add(DB.Items.DRILL); Story.log("×‘× ×™×ª ××§×“×— ×¨×˜×˜.");
                } else if (this.check(ids, ['LENS','SENSOR','PARTS'])) {
                    Inventory.consume(); Inventory.add(DB.Items.GOGGLES); Story.log("×‘× ×™×ª ××©×§×¤×™ ×ª×¨××™.");
                } else if (this.check(ids, ['MIC','HEADSET','WIRE'])) {
                    Inventory.consume(); Inventory.add(DB.Items.SONAR); Story.log("×‘× ×™×ª ×¡×•×¨×§ ×©××¢.");
                    if(State.phase === 3) Minigames.sonar();
                } else {
                    Modal.msg("×©×’×™××”", "×©×™×œ×•×‘ ×œ× ×ª×§×™×Ÿ.");
                }
                if (
                    ids.includes('DRILL') &&
                    ids.includes('GOGGLES') &&
                    ids.includes('SONAR')
                ) {
                    Inventory.consume();
                    Secret.launchDino();
                    return;
                }
            },
            check(sel, req) { return req.every(r => sel.includes(r)); }
        };

        const Story = {
            log(txt) {
                const d = document.createElement('div');
                d.className = 'log-item';
                d.innerHTML = `<strong>></strong> ${txt}`;
                document.getElementById('log-feed').prepend(d);
            }
        };

        const Modal = {
            msg(t, txt) {
                document.getElementById('msg-text').innerText = txt;
                document.getElementById('modal-msg').classList.add('visible');
            },
            close(id) { document.getElementById(id).classList.remove('visible'); },
            transitionShow() { // ×”×¦×’×ª ×“×£ ××¢×‘×¨ ×¢× ×”×˜×§×¡×˜ ×”× ×“×¨×©
                document.getElementById('modal-transition').classList.add('visible');
            }
        };

        /**
         * ==========================================================================
         * QUIZ HANDLER
         * ==========================================================================
         */
        const Quiz = {
            answeredFor: {}, // track which hotspot IDs already answered
            current: null,
            ask(qObj, callback) {
                // qObj: {text, choices, correctIndex}
                this.current = { qObj, callback };
                const modal = document.getElementById('modal-quiz');
                document.getElementById('quiz-text').innerText = qObj.text;
                const choicesWrap = document.getElementById('quiz-choices');
                choicesWrap.innerHTML = '';
                qObj.choices.forEach((c, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.innerText = c;
                    btn.onclick = () => this._answer(idx);
                    choicesWrap.appendChild(btn);
                });
                modal.classList.add('visible');
            },
            _answer(idx) {
                const { qObj, callback } = this.current || {};
                document.getElementById('modal-quiz').classList.remove('visible');
                if (!qObj) { if(callback) callback(false); return; }
                const ok = (idx === qObj.correctIndex);
                if (callback) callback(ok);
            },
            markAnswered(hotspotId) { this.answeredFor[hotspotId] = true; },
            isAnsweredFor(hotspotId) { return !!this.answeredFor[hotspotId]; }
        };

        /**
         * ==========================================================================
         * MINIGAMES
         * ==========================================================================
         */
        const Minigames = {
            wave() {
                document.getElementById('modal-tuner').classList.add('visible');
                setTimeout(() => {
                    const canvas = document.getElementById('wave-canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
                    
                    const slider = document.getElementById('wave-slider');
                    const status = document.getElementById('wave-status');
                    let val = 50, time = 0, win = 0;
                    slider.oninput = (e) => val = parseInt(e.target.value);

                    const loop = () => {
                        if(!document.getElementById('modal-tuner').classList.contains('visible')) return;
                        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
                        ctx.lineWidth = 3; time += 0.2;
                        
                        ctx.strokeStyle = 'rgba(0,255,100,0.5)'; ctx.beginPath();
                        for(let x=0; x<canvas.width; x++) ctx.lineTo(x, 100 + Math.sin((x+time*5)*0.1)*40);
                        ctx.stroke();

                        const diff = Math.abs(val - 72);
                        ctx.strokeStyle = diff < 5 ? '#ffb700' : '#00f2ff';
                        ctx.beginPath();
                        const freq = val / 500;
                        for(let x=0; x<canvas.width; x++) ctx.lineTo(x, 100 + Math.sin((x+time*5)*freq)*40);
                        ctx.stroke();

                        if(diff < 5) {
                            status.innerText = "× ×¢×•×œ!"; status.style.color = "#00ff9d";
                            win++;
                            if(win > 100) { Modal.close('modal-tuner'); Game.phase2(); return; }
                        } else {
                            status.innerText = "×œ× ××¡×•× ×›×¨×Ÿ"; status.style.color = "#ff2a2a"; win = 0;
                        }
                        requestAnimationFrame(loop);
                    };
                    loop();
                }, 100);
            },
            sonar() {
                document.getElementById('modal-sonar').classList.add('visible');
                const blip = document.getElementById('sonar-blip');
                
                const interval = setInterval(() => {
                    const r = 100;
                    const x = 140 + r * Math.cos(Date.now()/1000);
                    const y = 140 + r * Math.sin(Date.now()/1000);
                    blip.style.left = (x-12)+'px'; blip.style.top = (y-12)+'px';
                    blip.style.opacity = (Math.sin(Date.now()/100) > 0.8) ? 1 : 0;
                }, 50);

                blip.onclick = () => {
                    clearInterval(interval);
                    Modal.close('modal-sonar');
                    Game.win();
                };
            }
        };

        const Fx = {
            start() {
                const cvs = document.getElementById('fx-canvas');
                const ctx = cvs.getContext('2d');
                function resize(){ cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
                resize(); window.addEventListener('resize', resize);
                
                const parts = Array.from({length:50}, () => ({
                    x:Math.random()*cvs.width, y:Math.random()*cvs.height,
                    vx:(Math.random()-0.5), vy:(Math.random()-0.5), s:Math.random()*2
                }));

                const loop = () => {
                    ctx.clearRect(0,0,cvs.width,cvs.height);
                    ctx.fillStyle = 'rgba(255,255,255,0.1)';
                    parts.forEach(p => {
                        p.x+=p.vx; p.y+=p.vy;
                        if(p.x<0) p.x=cvs.width; if(p.x>cvs.width) p.x=0;
                        if(p.y<0) p.y=cvs.height; if(p.y>cvs.height) p.y=0;
                        ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill();
                    });
                    requestAnimationFrame(loop);
                };
                loop();
            }
        };

        // TIMER
        const Timer = {
            totalSec: 180,
            remaining: 180,
            intervalId: null,
            start(sec = 180) {
                this.stop();
                this.remaining = sec;
                this.updateDisplay();
                this.intervalId = setInterval(() => {
                    this.remaining--;
                    this.updateDisplay();
                    if (this.remaining <= 0) {
                        this.stop();
                        Modal.msg("×”×–××Ÿ ××–×œ", "×”×–××Ÿ × ×’××¨. ×”××©×—×§ ×”×•×©×œ× ×‘×›×™×©×œ×•×Ÿ.");
                        // ×œ×—×¡×•× ××™× ×˜×¨××§×¦×™×” ×•×œ×¨×¢× ×Ÿ ××—×¨×™ ×›××” ×©× ×™×•×ª
                        document.getElementById('interact-layer').style.pointerEvents = 'none';
                        setTimeout(() => location.reload(), 5000);
                    }
                }, 1000);
            },
            stop() {
                if (this.intervalId) clearInterval(this.intervalId);
                this.intervalId = null;
            },
            updateDisplay() {
                const mm = String(Math.floor(this.remaining/60)).padStart(2,'0');
                const ss = String(this.remaining % 60).padStart(2,'0');
                document.getElementById('timer-display').innerText = `${mm}:${ss}`;
            }
        };

        // BOOT
        window.onload = () => {
            const term = document.getElementById('term-out');
            const lines = [
                "Booting...",
                "Loading Bio-Drivers...",
                "Accessing Train OS...",
                "Target Acquired."
            ];
        
            let i = 0;
            const int = setInterval(() => {
                if (i < lines.length) {
                    const d = document.createElement('div');
                    d.className = 'boot-line';
                    d.innerText = "> " + lines[i++];
                    term.appendChild(d);
                } else {
                    clearInterval(int);
                    document.getElementById('boot-progress').style.width = '100%';
        
                    setTimeout(() => {
                        document.getElementById('boot-screen').style.display = 'none';
                        document.getElementById('main-interface').style.opacity = 1;
        
                        // â— ×œ× ××ª×—×™×œ×™× ××©×—×§ ×›××Ÿ
                        // ××—×›×™× ×œ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”×”×ª×—×œ×”
                    }, 500);
                }
            }, 500);
        };


            // ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”×”×ª×—×œ×” ×‘××•×“××œ ×”×¤×ª×™×—×”: ××ª×—×•×œ ×”××©×—×§ ×•×”×¤×¢×œ×ª ×˜×™×™××¨
            document.getElementById('start-game-btn').addEventListener('click', () => {
                document.getElementById('modal-intro').classList.remove('visible');
                // ×”×ª×—×œ×ª ×˜×™×™××¨ ×©×œ 3 ×“×§×•×ª
                // ××ª×—×•×œ ×”××©×—×§
                Game.init();
            });
            const Secret = {
        launched: false,
        launchDino() {
            if (this.launched) return;
            this.launched = true;
    
            // ××¡×š ×©×—×•×¨ ×©×§×˜
            document.body.innerHTML = `
                <iframe 
                    src="https://chromedino.com/"
                    style="position:fixed;top:0;left:0;width:100vw;height:100vh;border:none;background:black;"
                ></iframe>
            `;
        }
                document.addEventListener('DOMContentLoaded', () => {
        const startBtn = document.getElementById('start-game-btn');
        if (!startBtn) return;
    
        startBtn.addEventListener('click', () => {
            const storyModal = document.getElementById('modal-story');
            if (storyModal) storyModal.classList.remove('visible');
    
            // ×”×ª×—×œ×” ×××™×ª×™×ª ×©×œ ×”××©×—×§
            Game.init();
            Timer.start(180);
        });
    });
};
    </script>
</body>
</html>

