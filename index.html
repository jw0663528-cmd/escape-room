<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0b10">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>×¤×¨×•×˜×•×§×•×œ ×”×¢×•×§×¥ | ×’×¨×¡×” ××œ××”</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@100;300;400;700;900&family=Rubik:wght@300;400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        /* * ==========================================================================
         * 1. ×œ×™×‘×ª ×”××¢×¨×›×ª (CORE VARIABLES)
         * ========================================================================== */
        :root {
            --bg-void: #020202;
            --bg-panel: #0b0c10;
            --border-dim: #1f2833;
            --c-gold: #ffb700; 
            --c-gold-dim: rgba(255, 183, 0, 0.15);
            --c-cyan: #66fcf1;
            --status-ok: #00ff9d;
            --status-warn: #ffae00;
            --status-crit: #ff2a2a;
            --sidebar-w: 400px;
            --header-h: 70px;
            --font-ui: 'Heebo', sans-serif;
            --font-mono: 'Share Tech Mono', monospace;
        }

        * {
            box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none;
        }

        body, html {
            width: 100%; height: 100%; margin: 0; padding: 0;
            background-color: var(--bg-void); color: #e0e0e0;
            font-family: var(--font-ui); overflow: hidden; overscroll-behavior: none;
        }

        /* ××¤×§×˜ CRT */
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 9999; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        /* * ==========================================================================
         * 2. ××¡×›×™× ××™×•×—×“×™× (×¤×ª×™×—×” ×•×¡×™×•×)
         * ========================================================================== */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px); padding: 20px;
        }

        /* ××¡×š ×˜×¢×™× ×” */
        #boot-screen { font-family: var(--font-mono); direction: ltr; }
        .terminal-box { width: 90%; max-width: 800px; height: 300px; border: 1px solid #333; padding: 20px; background: #050505; color: var(--c-cyan); overflow: hidden; margin-bottom: 20px; box-shadow: 0 0 20px rgba(102, 252, 241, 0.1); }
        .loading-wrapper { width: 90%; max-width: 800px; height: 4px; background: #222; position: relative; }
        .loading-fill { height: 100%; width: 0%; background: var(--c-gold); box-shadow: 0 0 10px var(--c-gold); transition: width 0.1s linear; }

        /* ××¡×š ×”×¡×‘×¨ (Intro) */
        .info-card {
            background: #0b0c10; border: 2px solid var(--c-gold);
            box-shadow: 0 0 50px rgba(255, 183, 0, 0.2);
            padding: 40px; max-width: 700px; width: 100%;
            border-radius: 8px; text-align: center; position: relative;
            max-height: 90vh; overflow-y: auto;
        }
        .info-title { font-family: 'Rubik'; font-size: 32px; color: var(--c-gold); margin-bottom: 20px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .info-text { font-size: 18px; line-height: 1.6; color: #ccc; margin-bottom: 30px; text-align: right; }
        .info-text strong { color: #fff; }
        
        .credits-list { list-style: none; padding: 0; text-align: center; }
        .credits-list li { margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 10px; }
        .role { display: block; font-size: 14px; color: var(--c-cyan); margin-bottom: 5px; font-family: var(--font-mono); }
        .name { font-size: 20px; font-weight: bold; color: #fff; }

        .btn-start {
            background: var(--c-gold); color: #000; border: none; padding: 15px 40px;
            font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 4px;
            transition: 0.3s; font-family: 'Rubik'; width: 100%;
        }
        .btn-start:hover { background: #fff; box-shadow: 0 0 20px var(--c-gold); transform: translateY(-2px); }

        /* * ==========================================================================
         * 3. ×××©×§ ×¨××©×™ (MAIN LAYOUT)
         * ========================================================================== */
        #main-interface {
            display: grid;
            grid-template-columns: 1fr var(--sidebar-w);
            grid-template-rows: var(--header-h) 1fr;
            width: 100vw; height: 100vh; height: 100dvh;
            opacity: 0; transition: opacity 1s;
        }

        /* HEADER */
        #header {
            grid-column: 1 / -1; background: var(--bg-panel); border-bottom: 1px solid var(--border-dim);
            display: flex; justify-content: space-between; align-items: center; padding: 0 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 100;
        }
        .logo-section h1 { font-family: 'Rubik'; font-size: 24px; font-weight: 900; margin: 0; color: var(--c-gold); letter-spacing: 2px; }
        .indicators { display: flex; gap: 20px; font-size: 12px; font-family: var(--font-mono); }
        .ind { display: flex; align-items: center; gap: 8px; opacity: 0.4; transition: 0.3s; }
        .ind.active { opacity: 1; color: var(--status-ok); text-shadow: 0 0 5px var(--status-ok); }
        .ind.danger { opacity: 1; color: var(--status-crit); animation: blink 1s infinite; }
        .led { width: 6px; height: 6px; border-radius: 50%; background: currentColor; box-shadow: 0 0 8px currentColor; }

        /* VIEWPORT */
        #viewport { position: relative; background: #000; overflow: hidden; border-left: 1px solid var(--border-dim); cursor: crosshair; }
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; transition: opacity 1.5s; opacity: 0; z-index: 1; }
        
        #layer-train { background-image: url('https://i.ibb.co/7tQt5S0h/Gemini-Generated-Image-prcu4rprcu4rprcu.png'); opacity: 1; }
        #layer-hallway { background-image: url('https://i.ibb.co/svJJmvYr/Gemini-Generated-Image-l4kaehl4kaehl4ka.png'); filter: brightness(0.4) sepia(1) hue-rotate(180deg); }
        #layer-engine { background-image: url('https://i.ibb.co/d04yrgRx/Gemini-Generated-Image-j02tg6j02tg6j02t.png'); filter: brightness(0.3) contrast(1.2); }

        #fx-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        #overlay-gas { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, rgba(0,255,100,0.1), transparent 80%); z-index: 6; pointer-events: none; opacity: 0; transition: 1s; mix-blend-mode: screen; }
        #overlay-thermal { position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(180deg, rgba(0,50,0,0.2), transparent), repeating-linear-gradient(0deg, transparent, transparent 2px, #00ff00 3px); background-size: 100% 4px; filter: contrast(2) invert(1) brightness(1.2); mix-blend-mode: hard-light; z-index: 7; opacity: 0; pointer-events: none; transition: 0.5s; }
        #overlay-dark { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at 50% 50%, transparent 150px, #000 500px); z-index: 8; opacity: 0; pointer-events: none; transition: 2s; }

        /* HOTSPOTS */
        #interact-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 20; }
        .hotspot { position: absolute; width: 64px; height: 64px; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0; transition: 0.3s; border-radius: 50%; }
        .reticle { position: absolute; width: 100%; height: 100%; border: 1px dashed rgba(255, 183, 0, 0.4); border-radius: 50%; animation: spin-slow 10s linear infinite; }
        .corner-marks { position: absolute; width: 60%; height: 60%; border: 2px solid var(--c-gold); transform: rotate(45deg); transition: 0.3s; box-shadow: 0 0 10px var(--c-gold-dim); }
        .scanner-on .hotspot { opacity: 0.6; }
        .hotspot:hover, .hotspot:active { opacity: 1 !important; transform: scale(1.1); }
        .hotspot:hover .corner-marks { background: var(--c-gold-dim); box-shadow: 0 0 20px var(--c-gold); }
        .label { position: absolute; bottom: -30px; font-family: var(--font-mono); font-size: 12px; color: var(--c-gold); background: rgba(0,0,0,0.9); padding: 4px 8px; border: 1px solid var(--c-gold); opacity: 0; transition: 0.3s; white-space: nowrap; pointer-events: none; }
        .hotspot:hover .label { opacity: 1; }

        /* ××™×§×•××™× */
        #hs-case { top: 65%; left: 70%; }
        #hs-vent { top: 5%; left: 50%; width: 120px; height: 80px; }
        #hs-seat { top: 60%; left: 20%; }
        #hs-panel { top: 50%; left: 10%; display: none; }
        #hs-door { top: 30%; left: 50%; width: 100px; height: 200px; display: none; }
        #hs-note { top: 80%; left: 80%; display: none; }
        #hs-chem { top: 60%; left: 20%; display: none; }
        #hs-swarm { top: 20%; left: 60%; width: 150px; height: 150px; display: none; }

        /* SIDEBAR */
        aside { background: var(--bg-panel); border-left: 2px solid #222; display: flex; flex-direction: column; padding: 15px; gap: 15px; z-index: 50; }
        .panel { background: rgba(255,255,255,0.03); border: 1px solid #333; padding: 10px; border-radius: 4px; }
        .panel h3 { margin: 0 0 10px 0; color: var(--c-gold); font-size: 14px; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 5px; }

        #log-feed { height: 150px; overflow-y: auto; font-size: 14px; line-height: 1.5; color: #ccc; }
        .log-entry { margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed #222; animation: fadeIn 0.3s; }
        .highlight { color: var(--c-gold); font-weight: bold; }

        #btn-scanner { width: 100%; padding: 15px; background: transparent; border: 1px solid var(--c-cyan); color: var(--c-cyan); font-family: 'Rubik'; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; gap: 10px; text-transform: uppercase; }
        #btn-scanner.active { background: rgba(102, 252, 241, 0.15); box-shadow: 0 0 20px rgba(102, 252, 241, 0.2); color: #fff; border-color: #fff; }

        /* CRAFTING & INVENTORY */
        .craft-slots { display: flex; gap: 5px; margin-bottom: 10px; }
        .c-slot { flex: 1; aspect-ratio: 1; background: #000; border: 1px dashed #444; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #333; transition: 0.3s; }
        .c-slot.filled { border-color: var(--c-gold); color: #fff; box-shadow: inset 0 0 10px var(--c-gold-dim); }
        #btn-craft { width: 100%; padding: 12px; background: #222; border: none; color: #555; font-weight: bold; cursor: not-allowed; transition: 0.3s; }
        #btn-craft.ready { background: var(--c-gold); color: #000; cursor: pointer; box-shadow: 0 0 15px var(--c-gold-dim); }

        #inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .inv-slot { aspect-ratio: 1; background: #000; border: 1px solid #333; display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; position: relative; }
        .inv-slot.selected { border-color: var(--c-gold); box-shadow: inset 0 0 10px var(--c-gold); }

        /* * ==========================================================================
         * 4. MODALS
         * ========================================================================== */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 15px; }
        .modal.active { display: flex; }
        .window { width: 90%; max-width: 600px; background: #0b0c10; border: 2px solid var(--c-cyan); padding: 20px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); position: relative; border-radius: 8px; }
        .win-title { color: var(--c-cyan); font-family: var(--font-mono); margin-bottom: 20px; font-size: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .close-x { position: absolute; top: 10px; left: 15px; cursor: pointer; color: #666; font-size: 24px; }

        /* Mini Games */
        #wave-game canvas { width: 100%; height: 150px; background: #000; border: 1px solid #333; }
        #sonar-ui { width: 250px; height: 250px; background: radial-gradient(#002200, #000); border-radius: 50%; border: 2px solid var(--status-ok); margin: 0 auto; position: relative; overflow: hidden; }
        #sonar-sweep { position: absolute; width: 100%; height: 100%; background: conic-gradient(transparent 0deg, rgba(0,255,0,0.5) 30deg, transparent 30deg); border-radius: 50%; animation: spin 2s linear infinite; }
        #sonar-blip { position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px #fff; opacity: 0; cursor: pointer; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 900px) {
            #main-interface { grid-template-columns: 1fr; grid-template-rows: 50px 1fr 280px; }
            aside { border-left: none; border-top: 2px solid #222; padding: 10px; gap: 10px; }
            #log-feed { height: 80px; font-size: 12px; }
            .inv-slot { font-size: 24px; }
            .hotspot { width: 80px; height: 80px; }
            .modal { align-items: flex-start; padding-top: 50px; }
        }

        @keyframes pulse-gas { 0% { opacity: 0.6; } 50% { opacity: 0.9; } 100% { opacity: 0.6; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes blink { 50% { opacity: 0.3; } }
        @keyframes spin-slow { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="boot-screen">
        <div class="terminal-box" id="term-out"></div>
        <div class="loading-wrapper">
            <div class="loading-fill" id="boot-progress"></div>
        </div>
    </div>

    <div id="intro-screen" class="overlay-screen" style="display:none;">
        <div class="info-card">
            <h1 class="info-title">×¤×¨×•×˜×•×§×•×œ ×”×¢×•×§×¥</h1>
            <div class="info-text">
                <p>×”×“×××” ×‘×§×¨×•×Ÿ ××¡×¤×¨ 5 ×”×•×¤×¨×”. ××“×™× ×™×¨×§×¨×§×™× ×©×œ ×’×– ×¨×¢×™×œ ×–×•×œ×’×™× ××”×ª×§×¨×”. ×”×“×œ×ª×•×ª × ×¢×•×œ×•×ª.</p>
                <p><strong>×”××©×™××”:</strong> ×‘×ª×•×¨ ××”× ×“×¡ ××›×•× ×•×ª, ×¢×œ×™×š ×œ×”×©×ª××© ×‘×¨×›×™×‘×™× ××œ×§×˜×¨×•× ×™×™× ×•×‘×¢×§×¨×•× ×•×ª ××¢×•×œ× ×”×˜×‘×¢ (×”×™×ª×•×©) ×›×“×™ ×œ× ×˜×¨×œ ××ª ×”××™×•×, ×œ×¤×¨×•×¥ ×œ×§×˜×¨ ×•×œ×”×¦×™×œ ××ª ×”× ×•×¡×¢×™×.</p>
                <p><strong>×”×•×¨××•×ª:</strong><br>
                1. ×”×©×ª××© ×‘<strong>×¡×•×¨×§ ×”×ª×¨××™</strong> ×›×“×™ ×œ××¦×•× ×—×¤×¦×™× × ×¡×ª×¨×™×.<br>
                2. ××¡×•×£ ×¨×›×™×‘×™× ×œ<strong>×ª×™×§ ×”×¦×™×•×“</strong>.<br>
                3. ×©×œ×‘ 3 ×¨×›×™×‘×™× ×‘<strong>×©×•×œ×—×Ÿ ×”×¢×‘×•×“×”</strong> ×œ×™×¦×™×¨×ª ×›×œ×™× ×‘×™×•××™××˜×™×™×.<br>
                4. ×¤×ª×•×¨ ××ª ×”×—×™×“×•×ª ×›×“×™ ×œ×”×ª×§×“×.</p>
            </div>
            <button class="btn-start" onclick="Game.startGame()">×”×ª×—×œ ××©×™××”</button>
        </div>
    </div>

    <div id="credits-screen" class="overlay-screen" style="display:none;">
        <div class="info-card">
            <h1 class="info-title" style="color:var(--status-ok)">××©×™××” ×”×•×©×œ××”!</h1>
            <div style="text-align:center; color:#ccc; margin-bottom:20px;">
                ×”× ×•×’×“×Ÿ ×”×•×©×’. ×”× ×—×™×œ × ×•×˜×¨×œ. ×”×¦×œ×ª ××ª ×”×¨×›×‘×ª.
            </div>
            <ul class="credits-list">
                <li>
                    <span class="role">× ×‘× ×” ×¢×œ ×™×“×™</span>
                    <span class="name">×¢×™×“×Ÿ ××‘×¨×‘×•×š ×‘×¢×–×¨×ª Gemini</span>
                </li>
                <li>
                    <span class="role">×—×•××¨ ×•×‘× ×™×™×ª ×¡×™×¤×•×¨</span>
                    <span class="name">×™×•××‘ ×¤×œ×“××Ÿ</span>
                </li>
                <li>
                    <span class="role">×§×‘×•×¦×” ×‘××“×¢×™×</span>
                    <span class="name">×¢×™×“×Ÿ ××‘×¨×‘×•×š, ×™×•××‘ ×¤×œ×“××Ÿ, ×¡×”×¨ ×—×“×“</span>
                </li>
            </ul>
            <button class="btn-start" onclick="location.reload()">××ª×—×•×œ ××¢×¨×›×ª</button>
        </div>
    </div>

    <div id="main-interface">
        
        <header>
            <div class="brand">×¤×¨×•×˜×•×§×•×œ ×”×¢×•×§×¥</div>
            <div class="indicators">
                <div class="ind danger active" id="ind-gas"><div class="led"></div> ×’×– ×¨×¢×™×œ</div>
                <div class="ind" id="ind-thermal"><div class="led"></div> ×ª×¨××™</div>
                <div class="ind" id="ind-audio"><div class="led"></div> ×©××¢</div>
            </div>
        </header>

        <main id="viewport">
            <canvas id="fx-canvas"></canvas>
            
            <div id="gas-overlay" style="opacity:1;"></div>
            <div id="thermal-overlay"></div>
            <div id="overlay-dark"></div>

            <div class="layer" id="layer-lab"></div>
            <div class="layer" id="layer-hall"></div>
            <div class="layer" id="layer-train"></div>

            <div id="interact-layer">
                <div class="hotspot" id="hs-case" data-id="case"><div class="reticle"></div><div class="corner-marks"></div><div class="label">××–×•×•×“×”</div></div>
                <div class="hotspot" id="hs-vent" data-id="vent"><div class="reticle"></div><div class="corner-marks"></div><div class="label">×“×™×–×”</div></div>
                <div class="hotspot" id="hs-seat" data-id="seat"><div class="reticle"></div><div class="corner-marks"></div><div class="label">××•×©×‘</div></div>
                
                <div class="hotspot" id="hs-panel" data-id="panel"><div class="reticle"></div><div class="corner-marks"></div><div class="label">×¤×× ×œ</div></div>
                <div class="hotspot" id="hs-door" data-id="door"><div class="reticle"></div><div class="corner-marks"></div><div class="label">×“×œ×ª ×× ×•×¢</div></div>
                
                <div class="hotspot" id="hs-note" data-id="note"><div class="reticle"></div><div class="corner-marks"></div><div class="label">××¨×•×Ÿ</div></div>
                <div class="hotspot" id="hs-swarm" data-id="swarm"><div class="reticle"></div><div class="corner-marks"></div><div class="label">×“××•×ª ×—×©×•×“×”</div></div>
            </div>
        </main>

        <aside>
            <div class="panel" style="flex:1;">
                <h3>×™×•××Ÿ ××™×¨×•×¢×™×</h3>
                <div id="log-feed"></div>
            </div>

            <button id="btn-scanner" onclick="Game.toggleScanner()">
                ğŸ‘ï¸ ×¡×•×¨×§ ×ª×¨××™: ×›×‘×•×™
            </button>

            <div class="panel">
                <h3>×©×•×œ×—×Ÿ ×¢×‘×•×“×” (×‘×—×¨ 3)</h3>
                <div class="craft-container">
                    <div class="craft-slots">
                        <div class="c-slot" id="slot-0"></div>
                        <div class="c-slot" id="slot-1"></div>
                        <div class="c-slot" id="slot-2"></div>
                    </div>
                    <button id="btn-craft" onclick="Crafting.craft()">×‘×¦×¢ ××™× ×˜×’×¨×¦×™×”</button>
                </div>
            </div>

            <div class="panel">
                <h3>×¦×™×•×“</h3>
                <div id="inv-grid"></div>
            </div>
        </aside>

    </div>

    <div id="modal-msg" class="modal">
        <div class="window">
            <div class="close-x" onclick="Modal.close('modal-msg')">Ã—</div>
            <div class="win-title">×”×•×“×¢×ª ××¢×¨×›×ª</div>
            <p id="msg-text" style="color:#ccc; font-size:16px; margin-bottom:20px; text-align:center;"></p>
            <button class="action-btn" onclick="Modal.close('modal-msg')">××™×©×•×¨</button>
        </div>
    </div>

    <div id="modal-wave" class="modal">
        <div class="window">
            <div class="win-title">×›×™×•×œ ××§×“×— ×¨×˜×˜</div>
            <div id="wave-game">
                <p>×”×–×– ××ª ×”××—×•×•×Ÿ ×¢×“ ×©×”×’×œ×™× ××¡×•× ×›×¨× ×™× ×œ×—×œ×•×˜×™×Ÿ ×›×“×™ ×œ×—×“×•×¨ ××ª ×”×“×™×–×”.</p>
                <canvas id="cvs-wave"></canvas>
                <input type="range" id="rng-wave" style="width:100%" min="0" max="100">
                <div id="wave-status" style="margin-top:10px; color:red; font-weight:bold;">×œ× ××¡×•× ×›×¨×Ÿ</div>
            </div>
        </div>
    </div>

    <div id="modal-sonar" class="modal">
        <div class="window">
            <div class="win-title">××™×ª×•×¨ ×©××¢ ×›×™×•×•× ×™</div>
            <p>×”×§×©×‘ ×œ×¤×¢×™××•×ª ×”×œ×‘. ×œ×—×¥ ×¢×œ ×”× ×§×•×“×” ×›×©×”×™× ××•×¤×™×¢×”.</p>
            <div id="sonar-ui">
                <div id="sonar-sweep"></div>
                <div id="sonar-blip"></div>
            </div>
        </div>
    </div>

    <script>
        /** CONFIG & DATA */
        const Items = {
            MOTOR: { id: 'MOTOR', icon: 'âš™ï¸', name: '×× ×•×¢ ×¨×˜×˜' },
            NEEDLE: { id: 'NEEDLE', icon: 'ğŸ“', name: '××—×˜' },
            BATTERY: { id: 'BATTERY', icon: 'ğŸ”‹', name: '×¡×•×œ×œ×”' },
            DRILL: { id: 'DRILL', icon: 'ğŸ¦Ÿ', name: '××§×“×— ×¨×˜×˜', tool: true },
            LENS: { id: 'LENS', icon: 'ğŸ‘“', name: '×¢×“×©×•×ª' },
            SENSOR: { id: 'SENSOR', icon: 'ğŸŒ¡ï¸', name: '×—×™×™×©×Ÿ' },
            WIRES: { id: 'WIRES', icon: 'ğŸ”Œ', name: '×—×•×˜×™×' },
            GOGGLES: { id: 'GOGGLES', icon: 'ğŸ•¶ï¸', name: '××©×§×¤×™ ×ª×¨××™', tool: true },
            NOTE: { id: 'NOTE', icon: 'ğŸ™ï¸', name: '××™×§×¨×•×¤×•×Ÿ' }, // reusing logic
            HEADSET: { id: 'HEADSET', icon: 'ğŸ§', name: '××•×–× ×™×™×”' },
            CABLE: { id: 'CABLE', icon: 'ã€°ï¸', name: '×›×‘×œ' },
            SONAR: { id: 'SONAR', icon: 'ğŸ“¡', name: '×¡×•×¨×§ ×©××¢', tool: true },
            ANTIDOTE: { id: 'ANTIDOTE', icon: 'ğŸ’‰', name: '× ×•×’×“×Ÿ', tool: true }
        };

        const State = { phase: 1, inventory: [], selectedSlots: [], solved: [], scanner: false };

        /** GAME ENGINE */
        const Game = {
            init() {
                Inventory.init();
                Fx.start();
                // ×”×•×˜×¡×¤×•×˜×™×
                document.querySelectorAll('.hotspot').forEach(el => {
                    el.addEventListener('click', () => this.handleSpot(el.dataset.id));
                });
            },

            startGame() {
                document.getElementById('intro-screen').style.display = 'none';
                document.getElementById('main-interface').style.opacity = 1;
                Story.log("×”×“×××” ×”×•×¤×¨×”. ×’×– ×¨×¢×™×œ ×××œ× ××ª ×”×—×œ×œ. ××¦× ×¨×›×™×‘×™× ×œ×‘× ×™×™×ª ×›×œ×™ ×—×“×™×¨×”.");
            },

            handleSpot(id) {
                if (!State.scanner && id !== 'vent' && id !== 'door' && id !== 'swarm') {
                    Modal.msg("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª. × ×“×¨×©×ª ×¡×¨×™×§×” ×ª×¨××™×ª.");
                    return;
                }
                if (State.solved.includes(id)) return;

                // Phase 1
                if (id === 'case') this.collect(['MOTOR', 'BATTERY'], id, "×× ×•×¢ ×•×¡×•×œ×œ×”");
                if (id === 'seat') this.collect(['NEEDLE'], id, "××—×˜");
                if (id === 'vent') {
                    if (Inventory.has('DRILL')) Minigames.wave();
                    else Modal.msg("×¡×›× ×”", "× ×’×™×¢×” ×ª×¤×¢×™×œ ××œ×›×•×“. × ×“×¨×© ××§×“×— ×¨×˜×˜.");
                }

                // Phase 2
                if (id === 'panel') this.collect(['SENSOR', 'WIRES'], id, "×—×™×™×©×Ÿ ×•×—×•×˜×™×");
                if (id === 'door') {
                    if (Inventory.has('GOGGLES')) this.startPhase3();
                    else Modal.msg("×¡×›× ×”", "×—×•×©×š ×•××œ×›×•×“×•×ª. ××™ ××¤×©×¨ ×œ×¢×‘×•×¨ ×‘×œ×™ ×œ×¨××•×ª.");
                }

                // Phase 3
                if (id === 'note') this.collect(['NOTE', 'HEADSET', 'CABLE'], id, "×¦×™×•×“ ×©××¢");
                if (id === 'swarm') {
                    if (Inventory.has('SONAR')) Minigames.sonar();
                    else Modal.msg("×—×•×©×š", "××™ ××¤×©×¨ ×œ××¦×•× ××•×ª×• ×‘×œ×™ ×¡×•×¨×§ ×©××¢.");
                }
            },

            collect(keys, id, name) {
                keys.forEach(k => Inventory.add(Items[k]));
                State.solved.push(id);
                document.querySelector(`[data-id="${id}"]`).style.display = 'none';
                Story.log(`××¦××ª: ${name}`);
                // ×‘×•× ×•×¡: ×× ×‘×©×œ×‘ 2 ××¦××ª ×¤×× ×œ, ×§×‘×œ ×¢×“×©×” ××•×˜×•××˜×™×ª ×›×™ ××™×Ÿ ×”×•×˜×¡×¤×•×˜ × ×•×¡×£
                if(id==='panel') Inventory.add(Items.LENS);
            },

            toggleScanner() {
                State.scanner = !State.scanner;
                const btn = document.getElementById('btn-scanner');
                if (State.scanner) {
                    btn.classList.add('active');
                    btn.innerHTML = 'ğŸ‘ï¸ ×¡×•×¨×§ ×ª×¨××™: ×¤×¢×™×œ';
                    document.body.classList.add('scanner-on');
                    if(State.phase === 2) document.getElementById('overlay-thermal').style.opacity = 1;
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = 'ğŸ‘ï¸ ×¡×•×¨×§ ×ª×¨××™: ×›×‘×•×™';
                    document.body.classList.remove('scanner-on');
                    document.getElementById('overlay-thermal').style.opacity = 0;
                }
            },

            startPhase2() {
                State.phase = 2;
                Story.log("×”×’×– × ×¢×¦×¨. ×”×“×œ×ª × ×¤×ª×—×” ×œ××¡×“×¨×•×Ÿ ×—×©×•×š.");
                document.getElementById('gas-overlay').style.opacity = 0;
                document.getElementById('layer-train').style.opacity = 0;
                document.getElementById('layer-hall').style.opacity = 1;
                
                document.getElementById('ind-gas').classList.remove('active', 'danger');
                document.getElementById('ind-thermal').classList.add('active', 'danger');

                ['vent', 'case', 'seat'].forEach(id => document.querySelector(`[data-id="${id}"]`).style.display = 'none');
                ['panel', 'door'].forEach(id => document.querySelector(`[data-id="${id}"]`).style.display = 'flex');
            },

            startPhase3() {
                State.phase = 3;
                Story.log("×¢×‘×¨×ª ××ª ×”×œ×™×™×–×¨×™×. ×”×’×¢×ª ×œ×§×˜×¨. ×”××“×¢×Ÿ ×‘×—×•×©×š.");
                document.getElementById('layer-hall').style.opacity = 0;
                document.getElementById('layer-engine').style.opacity = 1;
                document.getElementById('overlay-dark').style.opacity = 1;
                document.getElementById('overlay-thermal').style.display = 'none';

                document.getElementById('ind-thermal').classList.remove('active');
                document.getElementById('ind-audio').classList.add('active', 'danger');

                ['panel', 'door'].forEach(id => document.querySelector(`[data-id="${id}"]`).style.display = 'none');
                ['note', 'swarm'].forEach(id => document.querySelector(`[data-id="${id}"]`).style.display = 'flex');
            },

            win() {
                document.getElementById('credits-screen').style.display = 'flex';
            }
        };

        /** INVENTORY & CRAFTING */
        const Inventory = {
            init() {
                const grid = document.getElementById('inv-grid');
                for(let i=0; i<8; i++) {
                    let div = document.createElement('div');
                    div.className = 'inv-slot'; div.id = `inv-${i}`;
                    div.onclick = () => this.toggle(i);
                    grid.appendChild(div);
                }
            },
            add(item) {
                if(State.inventory.some(i=>i.id===item.id)) return;
                State.inventory.push(item);
                this.render();
            },
            has(id) { return State.inventory.some(i => i.id === id); },
            render() {
                for(let i=0; i<8; i++) {
                    const el = document.getElementById(`inv-${i}`);
                    el.innerHTML = ''; el.className = 'inv-slot';
                    if(State.inventory[i]) {
                        el.innerHTML = State.inventory[i].icon;
                        if(State.selectedSlots.includes(i)) el.classList.add('selected');
                    }
                }
            },
            toggle(i) {
                if(!State.inventory[i]) return;
                if(State.selectedSlots.includes(i)) State.selectedSlots = State.selectedSlots.filter(x=>x!==i);
                else if(State.selectedSlots.length < 3) State.selectedSlots.push(i);
                this.render(); Crafting.update();
            },
            consume() {
                State.selectedSlots.sort((a,b)=>b-a).forEach(i => State.inventory.splice(i,1));
                State.selectedSlots = []; this.render(); Crafting.update();
            }
        };

        const Crafting = {
            update() {
                [0,1,2].forEach(i => document.getElementById(`slot-${i}`).innerHTML = '');
                State.selectedSlots.forEach((idx, i) => document.getElementById(`slot-${i}`).innerHTML = State.inventory[idx].icon);
                document.getElementById('btn-craft').className = (State.selectedSlots.length === 3) ? 'action-btn ready' : 'action-btn';
            },
            craft() {
                if(State.selectedSlots.length !== 3) return;
                const ids = State.selectedSlots.map(i => State.inventory[i].id);
                
                if(this.check(ids, ['MOTOR','NEEDLE','BATTERY'])) {
                    Inventory.consume(); Inventory.add(Items.DRILL); Story.log("×‘× ×™×ª ××§×“×— ×¨×˜×˜.");
                } else if(this.check(ids, ['LENS','SENSOR','WIRES'])) {
                    Inventory.consume(); Inventory.add(Items.GOGGLES); Story.log("×‘× ×™×ª ××©×§×¤×™×™× ×ª×¨××™×™×.");
                } else if(this.check(ids, ['NOTE','HEADSET','CABLE'])) {
                    Inventory.consume(); Inventory.add(Items.SONAR); Story.log("×‘× ×™×ª ×¡×•×¨×§ ×©××¢.");
                } else {
                    Modal.msg("×©×’×™××”", "×©×™×œ×•×‘ ×¨×›×™×‘×™× ×œ× ×ª×§×™×Ÿ.");
                }
            },
            check(sel, req) { return req.every(r => sel.includes(r)); }
        };

        /** UTILS */
        const Story = { log(txt) { const d=document.createElement('div'); d.className='log-entry'; d.innerHTML=`<span class="highlight">></span> ${txt}`; document.getElementById('log-feed').prepend(d); } };
        const Modal = { msg(t, txt) { document.getElementById('msg-text').innerText=txt; document.getElementById('modal-msg').classList.add('active'); }, close(id) { document.getElementById(id).classList.remove('active'); } };

        const Minigames = {
            wave() {
                document.getElementById('modal-wave').classList.add('active');
                setTimeout(() => {
                    const cvs = document.getElementById('cvs-wave');
                    const ctx = cvs.getContext('2d');
                    cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
                    const rng = document.getElementById('rng-wave');
                    let val = 50, t = 0;
                    rng.oninput = (e) => val = parseInt(e.target.value);

                    function loop() {
                        if(!document.getElementById('modal-wave').classList.contains('active')) return;
                        ctx.fillStyle = '#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
                        ctx.lineWidth = 3; t += 0.2;
                        
                        ctx.strokeStyle = 'rgba(0,255,100,0.5)'; ctx.beginPath();
                        for(let x=0; x<cvs.width; x++) ctx.lineTo(x, 75 + Math.sin((x+t*5)*0.1)*40);
                        ctx.stroke();

                        const diff = Math.abs(val - 72);
                        ctx.strokeStyle = diff < 5 ? '#ffb700' : '#00f2ff';
                        ctx.beginPath();
                        for(let x=0; x<cvs.width; x++) ctx.lineTo(x, 75 + Math.sin((x+t*5)*(val/500))*40);
                        ctx.stroke();

                        if (diff < 5) {
                            setTimeout(() => { Modal.close('modal-wave'); Game.startPhase2(); }, 1000);
                        }
                        requestAnimationFrame(loop);
                    }
                    loop();
                }, 100);
            },
            sonar() {
                document.getElementById('modal-sonar').classList.add('active');
                const blip = document.getElementById('sonar-blip');
                setInterval(() => {
                    const x = 125 + 80 * Math.cos(Date.now()/1000);
                    const y = 125 + 80 * Math.sin(Date.now()/1000);
                    blip.style.left = (x-5)+'px'; blip.style.top = (y-5)+'px';
                    blip.style.opacity = (Math.sin(Date.now()/100) > 0.8) ? 1 : 0;
                }, 50);
                blip.onclick = () => { Modal.close('modal-sonar'); Game.win(); };
            }
        };

        const Fx = {
            start() {
                const cvs = document.getElementById('fx-canvas'); const ctx = cvs.getContext('2d');
                cvs.width = window.innerWidth; cvs.height = window.innerHeight;
                const p = Array(50).fill().map(()=>({x:Math.random()*cvs.width, y:Math.random()*cvs.height, v:Math.random()}));
                function loop() {
                    ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle = 'rgba(255,255,255,0.1)';
                    p.forEach(d=>{ d.y-=d.v; if(d.y<0)d.y=cvs.height; ctx.beginPath(); ctx.arc(d.x,d.y,1,0,Math.PI*2); ctx.fill(); });
                    requestAnimationFrame(loop);
                }
                loop();
            }
        };

        // BOOT
        window.onload = () => {
            const log = document.getElementById('term-out');
            const lines = ["×××ª×—×œ ××¢×¨×›×ª...", "×˜×•×¢×Ÿ ×“×¨×™×™×‘×¨×™× ×‘×™×•××™××˜×™×™×...", "×—×™×‘×•×¨ ×××•×‘×˜×—...", "××•×›×Ÿ."];
            let i = 0;
            const int = setInterval(() => {
                if (i < lines.length) {
                    const p = document.createElement('div'); p.innerText = "> " + lines[i++];
                    log.appendChild(p);
                } else {
                    clearInterval(int);
                    document.getElementById('boot-progress').style.width = '100%';
                    setTimeout(() => {
                        document.getElementById('boot-screen').style.display = 'none';
                        document.getElementById('intro-screen').style.display = 'flex';
                        Game.init();
                    }, 800);
                }
            }, 600);
        };
    </script>
</body>
</html>
