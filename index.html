<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פרויקט קולקס | חוויה ויזואלית</title>
    <style>
        :root {
            --main-bg: #111;
            --hud-bg: #222;
            --accent: #00ff55;
            --danger: #ff3300;
        }
        body {
            margin: 0;
            background: var(--main-bg);
            color: #eee;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- HUD --- */
        #hud {
            background: var(--hud-bg);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #444;
            z-index: 100;
        }
        .hud-item { font-size: 1.2rem; font-weight: bold; }
        .antidote-icon { color: var(--accent); margin-right: 5px; }
        .antidote-lost { color: #555; }

        /* --- GAME VIEW CONTAINER --- */
        #game-view {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
            overflow: hidden;
        }

        /* --- GENERIC SCENE STYLES --- */
        .scene {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Default Carriage Background */
            background: linear-gradient(to bottom, #2c3e50, #1a252f);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        }
        
        /* Dialog Box for Context */
        .dialog-box {
            position: absolute;
            bottom: 20px;
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--accent);
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            text-align: center;
            z-index: 90;
        }

        /* --- LEVEL 1: THE NEEDLE (DRAG & DROP) --- */
        #l1-arm {
            width: 300px; height: 100px; background: #dca; border-radius: 50px; position: relative;
            box-shadow: inset 0 -10px rgba(0,0,0,0.2);
        }
        #l1-target-zone {
            width: 60px; height: 60px; background: rgba(255,0,0,0.3); border-radius: 50%;
            position: absolute; top: 20px; left: 120px; border: 2px dashed #f00;
        }
        #l1-needle-device {
            width: 150px; height: 40px; background: #555; position: absolute; bottom: 150px; left: 50px;
            border-radius: 5px; display: flex; align-items: center;
        }
        #l1-needle-tip {
            width: 50px; height: 4px; background: silver; position: absolute; right: -50px;
        }
        .draggable-cover {
            width: 60px; height: 20px; background: var(--accent); border-radius: 10px;
            position: absolute; bottom: 150px; right: 50px; cursor: grab;
            box-shadow: 0 0 10px var(--accent);
            display: flex; justify-content: center; align-items: center; font-size: 0.7rem; color:black; font-weight:bold;
        }

        /* --- LEVEL 2: THERMAL (FLASHLIGHT HOVER) --- */
        #l2-container {
            width: 100%; height: 100%; background: #000; position: relative; cursor: none;
        }
        .heat-hazard {
            position: absolute; width: 100px; height: 100px; background: red; border-radius: 50%;
            filter: blur(30px); opacity: 0; transition: opacity 0.2s;
        }
        .safe-path {
            position: absolute; width: 80px; height: 80px; background: blue; border-radius: 50%;
            filter: blur(20px); opacity: 0; transition: opacity 0.2s; cursor: pointer;
        }
        #flashlight {
            position: absolute; width: 200px; height: 200px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0) 70%);
            pointer-events: none; transform: translate(-50%, -50%); z-index: 10;
        }

        /* --- LEVEL 3: FOG (CANVAS WIPE) --- */
        #l3-door {
            width: 300px; height: 400px; background: #34495e; border: 5px solid #2c3e50; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        #l3-keypad {
            font-size: 3rem; color: var(--accent); letter-spacing: 10px; font-family: monospace;
        }
        #fog-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair;
        }
        #l3-input-area {
            position: absolute; bottom: -60px; display: flex; gap: 10px;
        }
        #l3-code-input { background: #111; color: var(--accent); border: 1px solid var(--accent); padding: 5px; font-size: 1.2rem; width: 100px;}

        /* --- LEVEL 4: DRONE (SLIDER BALANCE) --- */
        #l4-wind-tunnel {
            width: 80%; height: 300px; background: linear-gradient(90deg, #333, #444, #333);
            position: relative; overflow: hidden; border-top: 5px solid #222; border-bottom: 5px solid #222;
        }
        .wind-particle {
            position: absolute; width: 50px; height: 2px; background: rgba(255,255,255,0.5);
            animation: windMove 1s linear infinite;
        }
        #l4-drone {
            width: 60px; height: 20px; background: #888; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); border-radius: 10px; transition: all 0.3s ease-out;
        }
        #l4-drone::before, #l4-drone::after { /* Propellers */
            content: ''; position: absolute; width: 30px; height: 4px; background: #aaa; top: -10px;
            animation: spin 0.1s linear infinite;
        }
        #l4-drone::before { left: 0; } #l4-drone::after { right: 0; }
        
        #l4-controls { position: absolute; bottom: 100px; width: 300px; text-align: center;}
        input[type=range] { width: 100%; cursor: pointer; }

        /* Animations */
        @keyframes windMove { from { left: -50px; } to { left: 100%; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .shake-hard { animation: shake 0.2s infinite; background: var(--danger) !important; }
        @keyframes shake { 0% { transform: translate(-50%, -50%) rotate(5deg); } 50% { transform: translate(-50%, -50%) rotate(-5deg); } 100% { transform: translate(-50%, -50%) rotate(5deg); } }

        /* --- END SCREEN --- */
        .end-screen { text-align: center; }
        .end-screen h1 { font-size: 3rem; }
        button { background: var(--accent); border: none; padding: 10px 30px; font-size: 1.2rem; cursor: pointer; color: #000; font-weight: bold; margin-top: 20px;}

    </style>
</head>
<body>

    <div id="hud">
        <div class="hud-item">מיקום: <span id="loc-text">מעבדה</span></div>
        <div class="hud-item">
            נוגדנים: <span id="antidotes-container">
                <span class="antidote-icon">■</span><span class="antidote-icon">■</span><span class="antidote-icon">■</span><span class="antidote-icon">■</span><span class="antidote-icon">■</span><span class="antidote-icon">■</span>
            </span>
        </div>
    </div>

    <div id="game-view">
        </div>

<script>
    // --- STATE ---
    let gameState = {
        level: 0,
        antidotes: 6
    };
    const gameView = document.getElementById('game-view');
    const locText = document.getElementById('loc-text');
    const antidotesContainer = document.getElementById('antidotes-container');

    // --- CORE FUNCTIONS ---
    function updateHUD() {
        const icons = antidotesContainer.children;
        for (let i = 0; i < 6; i++) {
            if (i < gameState.antidotes) {
                icons[i].classList.remove('antidote-lost');
                icons[i].classList.add('antidote-icon');
            } else {
                icons[i].classList.remove('antidote-icon');
                icons[i].classList.add('antidote-lost');
            }
        }
        if (gameState.antidotes <= 0) loadLevel('lose');
    }

    function fail() {
        gameState.antidotes--;
        updateHUD();
        // Visual feedback flash
        gameView.style.boxShadow = "inset 0 0 100px var(--danger)";
        setTimeout(() => gameView.style.boxShadow = "none", 500);
    }

    function nextLevel() {
        gameState.level++;
        loadLevel(gameState.level);
    }

    function setDialog(text) {
        const dialog = document.querySelector('.dialog-box');
        if(dialog) dialog.innerText = text;
    }

    // --- LEVEL RENDERERS ---

    const levels = {
        0: () => { // INTRO
            locText.innerText = "מעבדה";
            gameView.innerHTML = `
                <div class="scene" style="background: #ccc;">
                    <h1 style="color:#111">פרויקט CULEX</h1>
                    <div class="dialog-box">ברוך הבא לניסוי. עליך לשרוד את הרכבת באמצעות עקרונות הביומימיקרי של היתוש. הכל כאן ויזואלי. אל תחשוב - תפעל.</div>
                    <button onclick="nextLevel()" style="position:absolute; top:60%;">התחל</button>
                </div>
            `;
        },
        1: () => { // NEEDLE DRAG
            locText.innerText = "קרון 1";
            gameView.innerHTML = `
                <div class="scene">
                    <div id="l1-arm"><div id="l1-target-zone"></div></div>
                    <div id="l1-needle-device">
                        <div id="l1-needle-tip"></div>
                    </div>
                    <div class="draggable-cover" draggable="true" id="bio-cover">כיסוי רוטט</div>
                    <div class="dialog-box">הילדה מפחדת מהמחט החשופה. גרור את הכיסוי הביומימטי (הרוטט) אל קצה המחט כדי להסוות אותה לפני ההזרקה.</div>
                </div>
            `;
            
            const cover = document.getElementById('bio-cover');
            const target = document.getElementById('l1-needle-tip');
            const device = document.getElementById('l1-needle-device');
            const armTarget = document.getElementById('l1-target-zone');

            cover.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', null); // Required for Firefox
                setTimeout(() => cover.style.display = 'none', 0);
            });

            cover.addEventListener('dragend', () => cover.style.display = 'flex');

            target.addEventListener('dragover', e => e.preventDefault());
            target.addEventListener('drop', e => {
                e.preventDefault();
                // Success visualization: Cover attaches to needle
                target.style.background = 'var(--accent)';
                target.style.width = '60px';
                target.style.borderRadius = '10px';
                cover.remove();
                setDialog("המחט מוסווית. כעת לחץ על המכשיר כדי להזריק.");

                // Phase 2: Click to inject
                device.style.cursor = 'pointer';
                device.onclick = () => {
                    device.style.transform = "translate(70px, -130px)";
                    setTimeout(() => {
                        if(target.style.background === 'var(--accent)') {
                            nextLevel();
                        }
                    }, 500);
                };
            });

            // Trap: clicking needle without cover
            device.onclick = () => {
                 device.style.transform = "translate(70px, -130px)";
                 setTimeout(() => {
                     fail();
                     setDialog("טעות! הזרקת עם מחט חשופה. הילדה זזה והמחט נשברה.");
                     device.style.transform = "translate(0, 0)"; // Reset
                 }, 500);
            };
        },
        2: () => { // THERMAL FLASHLIGHT
            locText.innerText = "קרון 4 (תרמי)";
            gameView.innerHTML = `
                <div class="scene" id="l2-container">
                    <div id="flashlight"></div>
                    <div class="heat-hazard" style="top:20%; left:30%"></div>
                    <div class="heat-hazard" style="top:60%; left:70%"></div>
                    <div class="heat-hazard" style="top:80%; left:20%"></div>
                    <div class="safe-path" id="l2-goal" style="top:40%; left:50%"></div>
                    <div class="dialog-box" style="pointer-events:none;">הקרון חשוך ומלא בקיטור רותח. הזז את העכבר כדי להשתמש בראייה התרמית. מצא את האזור הקר (הכחול) ולחץ עליו. האדום יהרוג אותך.</div>
                </div>
            `;

            const container = document.getElementById('l2-container');
            const flashlight = document.getElementById('flashlight');
            const hazards = document.querySelectorAll('.heat-hazard');
            const safe = document.querySelector('.safe-path');

            container.addEventListener('mousemove', e => {
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                flashlight.style.left = x + 'px';
                flashlight.style.top = y + 'px';

                // Reveal elements near flashlight
                [...hazards, safe].forEach(el => {
                    const elRect = el.getBoundingClientRect();
                    const elX = elRect.left + elRect.width/2 - rect.left;
                    const elY = elRect.top + elRect.height/2 - rect.top;
                    const dist = Math.sqrt((x-elX)**2 + (y-elY)**2);
                    el.style.opacity = dist < 100 ? 1 : 0;
                });
            });

            hazards.forEach(h => h.addEventListener('click', () => {
                fail();
                setDialog("נכנסת לזרם קיטור רותח! נסה שוב.");
            }));

            safe.addEventListener('click', nextLevel);
        },
        3: () => { // FOG WIPE
            locText.innerText = "קרון 7 (ערפל)";
            gameView.innerHTML = `
                <div class="scene">
                    <div id="l3-door">
                        <div id="l3-keypad">4921</div>
                        <canvas id="fog-canvas" width="300" height="400"></canvas>
                    </div>
                    <div id="l3-input-area">
                        <input type="text" id="l3-code-input" placeholder="קוד" maxlength="4">
                        <button onclick="checkCodeL3()">פתח</button>
                    </div>
                    <div class="dialog-box">הדלת נעולה והקוד מכוסה אדים. גרור את העכבר על הזכוכית כדי לנגב את האדים ולגלות את הקוד. מהר, הם חוזרים!</div>
                </div>
            `;

            const canvas = document.getElementById('fog-canvas');
            const ctx = canvas.getContext('2d');
            
            // Fill with fog
            ctx.fillStyle = 'rgba(200, 210, 220, 0.95)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let isDrawing = false;

            canvas.onmousedown = () => isDrawing = true;
            canvas.onmouseup = () => isDrawing = false;
            canvas.onmousemove = (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.fill();
            };

            // Regenerate fog (challenge mechanic)
            setInterval(() => {
                 ctx.globalCompositeOperation = 'source-over';
                 ctx.fillStyle = 'rgba(200, 210, 220, 0.05)';
                 ctx.fillRect(0, 0, canvas.width, canvas.height);
            }, 100);

            window.checkCodeL3 = () => {
                const input = document.getElementById('l3-code-input');
                if (input.value === '4921') nextLevel();
                else {
                    fail(); input.value=''; setDialog("קוד שגוי.");
                }
            };
        },
        4: () => { // DRONE STABILIZER
            locText.innerText = "קרון 9 (רוח)";
            gameView.innerHTML = `
                <div class="scene">
                    <div id="l4-wind-tunnel">
                        ${Array(10).fill('<div class="wind-particle" style="top:'+Math.random()*100+'%; animation-delay:-'+Math.random()+'s"></div>').join('')}
                        <div id="l4-drone"></div>
                    </div>
                    <div id="l4-controls">
                        <input type="range" id="l4-slider" min="0" max="100" value="0">
                        <p>תדר ייצוב: <span id="freq-val">0</span>Hz</p>
                    </div>
                     <div class="dialog-box" style="bottom: 150px;">יש רוח חזקה. הרחפן לא יציב. הזז את הסליידר כדי למצוא את תדר הרטט (כמו של היתוש) שייצב אותו במרכז.</div>
                </div>
            `;
            
            const slider = document.getElementById('l4-slider');
            const drone = document.getElementById('l4-drone');
            const freqVal = document.getElementById('freq-val');
            let stableTimer;

            slider.oninput = (e) => {
                const val = parseInt(e.target.value);
                freqVal.innerText = val * 10; // Simulate Hz
                
                // Target range: 55-65 on slider (550-650Hz)
                if (val > 55 && val < 65) {
                    drone.style.top = '50%';
                    drone.classList.remove('shake-hard');
                    drone.style.background = 'var(--accent)';
                    
                    clearTimeout(stableTimer);
                    stableTimer = setTimeout(() => {
                        setDialog("הרחפן יציב! עובר לקרון הבא...");
                        setTimeout(nextLevel, 1500);
                    }, 1000); // Must hold stable for 1s

                } else {
                    // Unstable visualization
                    const offset = (val - 60) * 2; // Calculate offset from center
                    drone.style.top = `${50 + offset}%`;
                    drone.classList.add('shake-hard');
                    drone.style.background = 'var(--danger)';
                    clearTimeout(stableTimer);
                }
            };
            // Trigger initial shake
            slider.dispatchEvent(new Event('input'));
        },
        'win': () => {
             gameView.innerHTML = `
                <div class="scene end-screen" style="background: #002200;">
                    <h1 style="color:var(--accent)">ניצחון!</h1>
                    <p>שרדת את הרכבת באמצעות עקרונות הביומימיקרי.</p>
                    <p>נוגדנים שנותרו: ${gameState.antidotes}</p>
                    <button onclick="location.reload()">שחק שוב</button>
                </div>
            `;
        },
        'lose': () => {
             gameView.innerHTML = `
                <div class="scene end-screen" style="background: #220000;">
                    <h1 style="color:var(--danger)">נכשלת</h1>
                    <p>אזלו הנוגדנים.</p>
                    <button onclick="location.reload()">נסה שוב</button>
                </div>
            `;
        }
    };

    function loadLevel(lvl) {
        if (levels[lvl]) levels[lvl]();
        else if (lvl > 4) loadLevel('win');
    }

    // START GAME
    loadLevel(0);

</script>
</body>
</html>
