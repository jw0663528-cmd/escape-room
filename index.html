<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×¤×¨×•×˜×•×§×•×œ ×”×¢×•×§×¥ | ×’×¨×¡×ª ××•×‘×™×™×œ ××œ××”</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@100;300;400;700;900&family=Rubik:wght@300;400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        /* * ==========================================================================
         * 1. ×”×’×“×¨×•×ª ×œ×™×‘×” (CORE VARIABLES)
         * ==========================================================================
         */
        :root {
            /* ×¤×œ×˜×ª ×¦×‘×¢×™× */
            --bg-deep: #050505;
            --bg-panel: #0f1012;
            
            --border-dim: #2a2a2a;
            --border-active: #ffb700;

            /* ×˜×§×¡×˜ */
            --text-main: #d0d0d0;
            --text-highlight: #ffb700; /* ×–×”×‘ ×”× ×“×¡×™ */
            
            /* ×¡×˜×˜×•×¡×™× */
            --status-ok: #00ff9d;   
            --status-warn: #ffae00; 
            --status-crit: #ff2a2a; 
            --status-tech: #00d9ff; 

            /* ××™×“×•×ª ×“×¡×§×˜×•×¤ */
            --sidebar-width: 400px;
            --header-height: 80px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            outline: none;
            /* ×× ×™×¢×ª ×”×“×’×©×” ×‘×œ×—×™×¦×” ×‘××•×‘×™×™×œ */
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Heebo', sans-serif;
            overflow: hidden;
            /* ×× ×™×¢×ª ×’×œ×™×œ×ª ×’×•××™ ×‘××™×™×¤×•×Ÿ */
            overscroll-behavior: none;
        }

        /* * ==========================================================================
         * 2. ××¡×š ××ª×—×•×œ (BOOT SEQUENCE)
         * ==========================================================================
         */
        #boot-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Share Tech Mono', monospace; direction: ltr;
            padding: 20px;
        }

        .terminal-window {
            width: 100%; max-width: 700px; height: 400px;
            border: 1px solid #333;
            padding: 20px;
            background: #020202;
            box-shadow: 0 0 50px rgba(255, 183, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .terminal-text { color: var(--text-highlight); font-size: 14px; line-height: 1.6; white-space: pre-wrap; }
        .scanline {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(255,255,255,0.1); animation: scan 3s linear infinite; pointer-events: none;
        }
        .loading-bar-container {
            width: 100%; max-width: 700px; height: 4px; background: #222;
            margin-top: 10px; position: relative;
        }
        .loading-bar {
            height: 100%; width: 0%; background: var(--text-highlight);
            box-shadow: 0 0 10px var(--text-highlight); transition: width 0.1s;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        /* * ==========================================================================
         * 3. ××‘× ×” ×¨××©×™ (MAIN LAYOUT)
         * ==========================================================================
         */
        #app-wrapper {
            display: grid;
            /* ×“×¡×§×˜×•×¤ ×›×‘×¨×™×¨×ª ××—×“×œ */
            grid-template-columns: 1fr var(--sidebar-width);
            grid-template-rows: var(--header-height) 1fr;
            width: 100vw; height: 100vh;
            /* ×©×™××•×© ×‘-dvh ×œ××•×‘×™×™×œ */
            height: 100dvh; 
            opacity: 0; transition: opacity 2s ease;
        }

        /* --- ×›×•×ª×¨×ª --- */
        #header-bar {
            grid-column: 1 / -1;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--border-dim);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
            z-index: 100;
        }

        .project-title {
            font-family: 'Rubik', sans-serif; font-size: 24px; font-weight: 900;
            letter-spacing: 1px; text-transform: uppercase; color: var(--text-highlight);
            text-shadow: 0 0 10px rgba(255, 183, 0, 0.4);
            display: flex; align-items: center; gap: 10px;
        }
        
        .sys-indicators { display: flex; gap: 20px; font-family: 'Share Tech Mono'; font-size: 12px; }
        .indicator { display: flex; align-items: center; gap: 8px; color: #888; white-space: nowrap;}
        .indicator.active { color: var(--text-highlight); }
        .led { width: 6px; height: 6px; background: #333; border-radius: 50%; }
        .active .led { background: var(--text-highlight); box-shadow: 0 0 8px var(--text-highlight); }
        .active.danger .led { background: var(--status-crit); box-shadow: 0 0 8px var(--status-crit); }
        .active.danger { color: var(--status-crit); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* --- ××–×•×¨ ×ª×¦×•×’×” (VIEWPORT) --- */
        #viewport {
            position: relative;
            background: #000;
            overflow: hidden;
            border-left: 1px solid var(--border-dim);
            /* ××•×‘×™×™×œ: ××¤×©×¨ ×’×œ×™×œ×” ×¤× ×™××™×ª ×× ×¦×¨×™×š, ××‘×œ ×¢×“×™×£ ×©×œ× */
            touch-action: none; 
        }

        /* ×©×›×‘×•×ª ×¨×§×¢ */
        .layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: opacity 1.5s; z-index: 1; opacity: 0;
        }
        #layer-train { background-image: url('https://i.ibb.co/7tQt5S0h/Gemini-Generated-Image-prcu4rprcu4rprcu.png'); }
        #layer-hallway { background-image: url('https://i.ibb.co/svJJmvYr/Gemini-Generated-Image-l4kaehl4kaehl4ka.png'); filter: brightness(0.4) sepia(1) hue-rotate(180deg); }
        #layer-engine { background-image: url('https://i.ibb.co/d04yrgRx/Gemini-Generated-Image-j02tg6j02tg6j02t.png'); filter: brightness(0.2) contrast(1.2); }

        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; mix-blend-mode: screen; }

        /* ××¤×§×˜×™× */
        #overlay-gas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, transparent 30%, rgba(0, 255, 100, 0.15)); z-index: 6; pointer-events: none; opacity: 0; transition: opacity 2s; }
        #overlay-thermal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, rgba(0,50,0,0.2) 50%, rgba(0,50,0,0.2) 50%), repeating-linear-gradient(0deg, transparent, transparent 2px, #00ff00 3px); background-size: 100% 4px; filter: contrast(2) brightness(1.5) grayscale(1) invert(1); mix-blend-mode: hard-light; z-index: 7; pointer-events: none; opacity: 0; display: none; }
        #overlay-darkness { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, transparent 100px, #000 300px); z-index: 8; pointer-events: none; opacity: 0; transition: opacity 2s; }

        /* --- ×”×•×˜×¡×¤×•×˜×™× --- */
        #hotspots-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; }

        .hotspot {
            position: absolute; width: 60px; height: 60px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0.8; transition: all 0.3s;
            /* ××•×ª×× ×œ××’×¢ */
            tap-highlight-color: transparent;
        }

        .reticle {
            position: absolute; width: 100%; height: 100%;
            border: 1px solid rgba(255, 183, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 183, 0, 0.1);
            animation: breathe 3s infinite;
        }
        .reticle::before, .reticle::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            border-color: var(--text-highlight); border-style: solid; transition: all 0.3s;
        }
        .reticle::before { top: 0; left: 0; border-width: 2px 0 0 2px; }
        .reticle::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; }

        .hotspot:active .reticle, .hotspot:hover .reticle { border-color: #fff; transform: scale(1.1); }

        .hs-label {
            position: absolute; bottom: -30px; 
            font-family: 'Share Tech Mono'; font-size: 14px; color: var(--text-highlight);
            background: rgba(0,0,0,0.9); padding: 4px 8px; border: 1px solid var(--text-highlight);
            opacity: 0; transition: 0.3s; white-space: nowrap; pointer-events: none;
            z-index: 100;
        }
        .hotspot:active .hs-label, .hotspot:hover .hs-label { opacity: 1; }

        /* ××™×§×•××™× */
        #hs-suitcase { top: 70%; left: 75%; }
        #hs-seat { top: 60%; left: 20%; }
        #hs-vent { top: 10%; left: 50%; width: 120px; height: 80px; }
        #hs-debris { top: 80%; left: 30%; }
        #hs-panel { top: 50%; left: 10%; }
        #hs-door-lock { top: 40%; left: 50%; width: 80px; height: 120px; }
        #hs-cabinet { top: 60%; left: 15%; }
        #hs-arcadius { top: 40%; left: 60%; width: 100px; height: 200px; opacity: 0; }

        @keyframes breathe { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.5; transform: scale(1); } }

        /* --- ×¡×¨×’×œ ×¦×“ (SIDEBAR) --- */
        #sidebar {
            background: var(--bg-panel);
            border-left: 2px solid var(--border-dim);
            display: flex; flex-direction: column;
            padding: 20px; box-shadow: -10px 0 40px rgba(0,0,0,0.8);
            z-index: 50; gap: 15px;
            overflow-y: auto; /* ×’×œ×™×œ×” ×¤× ×™××™×ª ×× ×¦×¨×™×š */
        }

        .panel-box {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-dim);
            padding: 12px; border-radius: 4px;
            position: relative;
        }
        .panel-title {
            font-family: 'Rubik'; font-weight: 700; font-size: 13px;
            color: var(--text-highlight); text-transform: uppercase;
            margin-bottom: 10px; display: block; border-bottom: 1px solid #333; padding-bottom: 5px;
        }

        #story-display {
            font-size: 14px; line-height: 1.5; color: #ddd;
            height: 120px; overflow-y: auto; padding-right: 5px;
        }
        .story-update { margin-bottom: 8px; border-bottom: 1px dashed #333; padding-bottom: 8px; }
        .highlight { color: var(--text-highlight); font-weight: bold; }

        /* ×©×•×œ×—×Ÿ ×¢×‘×•×“×” */
        #crafting-area { display: flex; flex-direction: column; gap: 10px; }
        #craft-slots { display: flex; justify-content: space-between; gap: 5px; }
        .craft-slot {
            width: 100%; aspect-ratio: 1; border: 1px dashed #555; background: #000;
            display: flex; justify-content: center; align-items: center; font-size: 24px;
            color: #333; transition: 0.3s;
        }
        .craft-slot.filled { border-color: var(--text-highlight); color: #fff; box-shadow: inset 0 0 10px rgba(255,183,0,0.2); }

        #btn-craft {
            width: 100%; padding: 12px; background: #222; color: #555;
            border: 1px solid #333; font-weight: bold; font-family: 'Rubik';
            cursor: not-allowed; transition: 0.3s; text-transform: uppercase;
        }
        #btn-craft.ready {
            background: var(--text-highlight); color: #000; cursor: pointer;
            box-shadow: 0 0 15px rgba(255,183,0,0.4); border: none;
        }

        /* ×ª×™×§ ×¦×™×•×“ */
        #inventory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .inv-item {
            aspect-ratio: 1; background: #080808; border: 1px solid #333;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer; transition: 0.2s; position: relative;
        }
        .inv-item.selected { border-color: var(--status-ok); box-shadow: 0 0 10px var(--status-ok); }

        /* * ==========================================================================
         * 4. ××•×“××œ×™× (MODALS)
         * ==========================================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(5px);
            padding: 20px; /* ××¨×•×•×— ×‘×˜×•×— ×œ××•×‘×™×™×œ */
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-box {
            background: #0a0a0a; border: 2px solid var(--text-highlight);
            box-shadow: 0 0 30px rgba(255, 183, 0, 0.2);
            padding: 20px; width: 600px; max-width: 100%; max-height: 90vh;
            position: relative; text-align: center;
            overflow-y: auto;
        }
        
        .modal-header { font-family: 'Rubik'; font-size: 20px; color: var(--text-highlight); margin-bottom: 15px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .modal-close { position: absolute; top: 10px; left: 15px; font-size: 24px; color: #666; cursor: pointer; padding: 10px; }

        /* ××™× ×™-××©×—×§×™× */
        #game-wave-container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        #wave-canvas { width: 100%; height: 150px; background: #000; border: 1px solid #333; margin-bottom: 15px; touch-action: none; }
        .slider-control { width: 100%; height: 30px; cursor: pointer; }
        
        #sonar-container { position: relative; width: 250px; height: 250px; border-radius: 50%; border: 2px solid var(--status-ok); background: radial-gradient(circle, #002200 0%, #000 100%); margin: 0 auto; overflow: hidden; touch-action: none; }
        #sonar-sweep {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0,255,157,0.5) 20deg, transparent 20deg);
            border-radius: 50%; animation: sweep 3s linear infinite;
        }
        #sonar-dot {
            position: absolute; width: 20px; height: 20px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 15px #fff; opacity: 0; transition: opacity 0.2s; cursor: pointer;
            z-index: 10;
        }
        
        @keyframes sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* * ==========================================================================
         * 5. RESPONSIVE / MOBILE STYLES (×”×ª×××” ×œ×˜×œ×¤×•×Ÿ)
         * ==========================================================================
         */
        @media (max-width: 900px) {
            #app-wrapper {
                /* ×©×™× ×•×™ ×¤×¨×™×¡×” ×œ×× ×›×™ */
                grid-template-columns: 1fr;
                grid-template-rows: 60px 50vh 1fr; /* ×›×•×ª×¨×ª, ××©×—×§, ×¡×¨×’×œ */
            }

            /* ×›×•×ª×¨×ª ×§×•××¤×§×˜×™×ª */
            #header-bar { padding: 0 15px; }
            .project-title { font-size: 18px; }
            .project-subtitle { display: none; } /* ×”×¡×ª×¨×ª ×›×™×ª×•×‘ ××©× ×™ */
            .sys-indicators { gap: 10px; font-size: 10px; }

            /* ××–×•×¨ ××©×—×§ */
            #viewport {
                border-left: none;
                border-bottom: 1px solid var(--border-active);
            }

            /* ×¡×¨×’×œ ×¦×“ ×œ××˜×” */
            #sidebar {
                border-left: none;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
                padding: 10px;
                gap: 10px;
            }

            /* ×”×§×˜× ×ª ×’×•×¤× ×™× ×•×¨×™×•×•×—×™× ×‘×¡×¨×’×œ */
            .panel-box { padding: 8px; margin-bottom: 5px; }
            #story-display { height: 80px; font-size: 13px; }
            .craft-slot { font-size: 18px; width: 50px; height: 50px; }
            
            /* ×”×ª×××ª ×ª×™×§ ×”×¦×™×•×“ ×œ×’×œ×™×œ×” ××•×¤×§×™×ª ×× ×¦×¨×™×š */
            #inventory-grid {
                grid-template-columns: repeat(6, 1fr); /* ×™×•×ª×¨ ×¤×¨×™×˜×™× ×‘×©×•×¨×” */
            }
            .inv-item { font-size: 18px; }

            /* ×”×’×“×œ×ª × ×§×•×“×•×ª ××’×¢ */
            .hotspot { width: 70px; height: 70px; }
            .hs-label { font-size: 12px; bottom: -25px; background: rgba(0,0,0,0.9); }

            /* ××•×“××œ×™× ××•×ª×××™× */
            .modal-box { width: 95%; padding: 15px; }
            .modal-header { font-size: 18px; }
            
            /* ×”×ª×××ª ××™× ×™-××©×—×§×™× */
            #sonar-container { width: 200px; height: 200px; }
        }

    </style>
</head>
<body>

    <div id="boot-layer">
        <div class="terminal-window">
            <div id="boot-text" class="terminal-text"></div>
            <div class="scanline"></div>
        </div>
        <div class="loading-bar-container">
            <div id="boot-bar" class="loading-bar"></div>
        </div>
    </div>

    <div id="app-wrapper">
        
        <header id="header-bar">
            <div class="project-title">
                <span>âš ï¸</span> ×¤×¨×•×˜×•×§×•×œ ×”×¢×•×§×¥
                <div class="project-subtitle">×××©×§ ×”×™×©×¨×“×•×ª ×‘×™×•××™××˜×™</div>
            </div>
            
            <div class="sys-indicators">
                <div id="ind-gas" class="indicator active danger"><div class="led"></div> ×’×– ×¨×¢×™×œ</div>
                <div id="ind-vision" class="indicator"><div class="led"></div> ×¨××™×™×” ×ª×¨××™×ª</div>
                <div id="ind-audio" class="indicator"><div class="led"></div> ×©××¢</div>
            </div>
        </header>

        <main id="viewport">
            <canvas id="particle-canvas"></canvas>
            
            <div id="overlay-gas"></div>
            <div id="overlay-darkness"></div>
            <div id="overlay-thermal"></div>

            <div id="layer-engine" class="layer"></div>
            <div id="layer-hallway" class="layer"></div>
            <div id="layer-train" class="layer"></div>

            <div id="hotspots-layer">
                <div id="hs-suitcase" class="hotspot" data-ref="suitcase">
                    <div class="reticle"></div><div class="hs-label">××–×•×•×“×”</div>
                </div>
                <div id="hs-seat" class="hotspot" data-ref="seat">
                    <div class="reticle"></div><div class="hs-label">××•×©×‘</div>
                </div>
                <div id="hs-vent" class="hotspot" data-ref="vent">
                    <div class="reticle"></div><div class="hs-label">×“×™×–×”</div>
                </div>

                <div id="hs-debris" class="hotspot" data-ref="debris" style="display:none;">
                    <div class="reticle"></div><div class="hs-label">×’×¨×•×˜××•×ª</div>
                </div>
                <div id="hs-panel" class="hotspot" data-ref="panel" style="display:none;">
                    <div class="reticle"></div><div class="hs-label">×¤×× ×œ</div>
                </div>
                <div id="hs-door-lock" class="hotspot" data-ref="door" style="display:none;">
                    <div class="reticle"></div><div class="hs-label">×“×œ×ª</div>
                </div>

                <div id="hs-cabinet" class="hotspot" data-ref="cabinet" style="display:none;">
                    <div class="reticle"></div><div class="hs-label">××¨×•×Ÿ</div>
                </div>
                <div id="hs-arcadius" class="hotspot" data-ref="arcadius" style="display:none;">
                    </div>
            </div>
        </main>

        <aside id="sidebar">
            <div class="panel-box" style="flex-grow: 1; display:flex; flex-direction:column;">
                <span class="panel-title">×™×•××Ÿ ××‘×¦×¢×™</span>
                <div id="story-display">
                    </div>
            </div>

            <div class="panel-box">
                <span class="panel-title">××™× ×˜×’×¨×¦×™×” (×‘×—×¨ 3)</span>
                <div id="crafting-area">
                    <div id="craft-slots">
                        <div class="craft-slot" id="craft-1"></div>
                        <div class="craft-slot" id="craft-2"></div>
                        <div class="craft-slot" id="craft-3"></div>
                    </div>
                    <button id="btn-craft" onclick="Crafting.execute()">×”×ª×—×œ ×‘× ×™×™×”</button>
                </div>
            </div>

            <div class="panel-box">
                <span class="panel-title">×¦×™×•×“ ×–××™×Ÿ</span>
                <div id="inventory-grid">
                    </div>
            </div>
        </aside>
    </div>

    <div id="modal-game" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-close" onclick="Modal.close()">Ã—</div>
            <div class="modal-header" id="modal-title">××ª×’×¨ ×”× ×“×¡×™</div>
            <div id="modal-content">
                </div>
        </div>
    </div>

    <div id="modal-msg" class="modal-overlay">
        <div class="modal-box" style="width: 400px; border-color: #fff;">
            <div class="modal-header" id="msg-title" style="color:#fff;">×”×•×“×¢×”</div>
            <p id="msg-text" style="color:#ccc; font-size:16px; margin-bottom:20px;"></p>
            <button onclick="Modal.closeMsg()" style="width:100%; background:#333; color:#fff; border:1px solid #666; padding:15px; cursor:pointer;">××™×©×•×¨</button>
        </div>
    </div>

    <script>
        /**
         * ==========================================================================
         * 1. ××¢×¨×›×ª × ×ª×•× ×™× (DATA)
         * ==========================================================================
         */
        const Items = {
            // ×©×œ×‘ 1
            MOTOR: { id: 'motor', icon: 'âš™ï¸', name: '×× ×•×¢ ×¨×˜×˜' },
            NEEDLE: { id: 'needle', icon: 'ğŸ“', name: '××—×˜' },
            BATTERY: { id: 'battery', icon: 'ğŸ”‹', name: '×¡×•×œ×œ×”' },
            DRILL: { id: 'drill', icon: 'ğŸ¦Ÿ', name: '××§×“×— ×‘×™×•××™××˜×™', isTool: true },
            
            // ×©×œ×‘ 2
            LENS: { id: 'lens', icon: 'ğŸ‘“', name: '×¢×“×©×•×ª' },
            SENSOR: { id: 'sensor', icon: 'ğŸŒ¡ï¸', name: '×—×™×™×©×Ÿ' },
            DRONE_PARTS: { id: 'drone_parts', icon: 'ğŸš', name: '×—×œ×§×™×' },
            GLASSES: { id: 'glasses', icon: 'ğŸ•¶ï¸', name: '××©×§×¤×™×™× ×ª×¨××™×™×', isTool: true },

            // ×©×œ×‘ 3
            MIC: { id: 'mic', icon: 'ğŸ™ï¸', name: '××™×§×¨×•×¤×•×Ÿ' },
            HEADSET: { id: 'headset', icon: 'ğŸ§', name: '××•×–× ×™×™×”' }, // × ×™×ª×Ÿ ×œ××¦×•× ××• ×œ×”×ª×—×™×œ ××™×ª×•
            WIRE: { id: 'wire', icon: 'ğŸ”Œ', name: '×—×•×˜' }, // ×¤×¨×™×˜ ×“××” ×œ×”×©×œ××ª ×©×œ×™×©×™×™×”
            SONAR: { id: 'sonar', icon: 'ğŸ“¡', name: '×¡×•×¨×§ ×§×•×œ×™', isTool: true }
        };

        const Story = {
            intro: "××“×™× ×™×¨×§×¨×§×™× ×××œ××™× ××ª ×”×§×¨×•×Ÿ. ×”×“×œ×ª×•×ª × ×¢×•×œ×•×ª. ×”×“×™×–×” ××•×’× ×ª ×‘×—×™×™×©× ×™ ×œ×—×¥. <br><br><b>×”××©×™××”:</b> ××¦× ×‘××–×•×•×“×” ×•××ª×—×ª ×œ××•×©×‘×™× ×—×œ×§×™× ×œ×‘× ×™×™×ª ×›×œ×™ ×©×™×—×“×•×¨ ××ª ×”×“×™×–×” ×œ×œ× ×œ×—×¥ (×›××• ×™×ª×•×©).",
            phase1_done: "×”×“×™×–×” × ×•×˜×¨×œ×”! ×”×’×– × ×¤×¡×§. ×”×“×œ×ª ×œ×§×¨×•×Ÿ ×”×‘× × ×¤×ª×—×” ×œ×ª×•×š ×—×•×©×š ××•×—×œ×˜ ×•××œ×›×•×“×•×ª ×œ×™×™×–×¨.",
            phase2_done: "×”××©×§×¤×™×™× ×—×•×©×¤×™× ××ª ×”×œ×™×™×–×¨×™×. ×¢×‘×¨×ª ×‘×‘×˜×—×”. ×”×’×¢×ª ×œ×§×¨×•×Ÿ ×”×× ×•×¢ ×”×—×©×•×š. ×”××“×¢×Ÿ ×‘×¤× ×™×.",
            win: "×ª×¤×¡×ª ××•×ª×•! ×”× ×•×’×“×Ÿ ×‘×™×“×š. ×”×©×™×œ×•×‘ ×©×œ ×§×•×¨ ×¨×•×— ×•×”×‘× ×ª ×”×˜×‘×¢ ×”×¦×™×œ ××ª ×›×•×œ×."
        };

        const State = {
            phase: 1,
            inventory: [],
            craftingSlots: [],
            solved: []
        };

        /**
         * ==========================================================================
         * 2. ×× ×”×œ ×”××©×—×§ (GAME MANAGER)
         * ==========================================================================
         */
        const Game = {
            init() {
                // ××ª×—×•×œ UI
                Inventory.initGrid();
                this.log(Story.intro);
                
                // ××¤×§×˜×™×
                Fx.initParticles();
                document.getElementById('overlay-gas').style.opacity = 1;

                // ××™×¨×•×¢×™×
                document.querySelectorAll('.hotspot').forEach(el => {
                    el.addEventListener('click', () => this.handleInteraction(el.dataset.ref));
                });
            },

            log(html) {
                const display = document.getElementById('story-display');
                const div = document.createElement('div');
                div.className = 'story-update';
                div.innerHTML = html;
                display.prepend(div);
            },

            handleInteraction(ref) {
                // ×©×œ×‘ 1: ××™×¡×•×£
                if(['suitcase', 'seat'].includes(ref)) {
                    if(ref === 'suitcase' && !State.solved.includes('suitcase')) {
                        Inventory.add(Items.MOTOR);
                        Inventory.add(Items.BATTERY);
                        this.log("> ××¦××ª ×× ×•×¢ ×•×¡×•×œ×œ×”.");
                        State.solved.push('suitcase');
                        document.getElementById('hs-suitcase').style.display = 'none';
                    }
                    if(ref === 'seat' && !State.solved.includes('seat')) {
                        Inventory.add(Items.NEEDLE);
                        this.log("> ××¦××ª ××—×˜ ××™×§×¨×•× ×™×ª.");
                        State.solved.push('seat');
                        document.getElementById('hs-seat').style.display = 'none';
                    }
                }
                
                // ××™× ×˜×¨××§×¦×™×” ×¢× ××˜×¨×•×ª
                if(ref === 'vent') {
                    if(Inventory.has(Items.DRILL.id)) {
                        Minigames.startDrill();
                    } else {
                        Modal.msg("×©×’×™××”", "× ×’×™×¢×” ×‘×“×™×–×” ×ª×¤×¢×™×œ ××ª ×”××œ×›×•×“. ×¢×œ×™×š ×œ×‘× ×•×ª ×›×œ×™ ×—×“×™×¨×” ×¢×“×™×Ÿ.");
                    }
                }

                // ×©×œ×‘ 2 ××™×¡×•×£
                if(['debris', 'panel'].includes(ref)) {
                    if(ref === 'debris' && !State.solved.includes('debris')) {
                        Inventory.add(Items.LENS);
                        Inventory.add(Items.DRONE_PARTS);
                        this.log("> ××¦××ª ×¢×“×©×•×ª ×•×—×œ×§×™×.");
                        State.solved.push('debris');
                        document.getElementById('hs-debris').style.display = 'none';
                    }
                    if(ref === 'panel' && !State.solved.includes('panel')) {
                        Inventory.add(Items.SENSOR);
                        this.log("> ×¤×™×¨×§×ª ×—×™×™×©×Ÿ ×ª×¨××™.");
                        State.solved.push('panel');
                        document.getElementById('hs-panel').style.display = 'none';
                    }
                }

                if(ref === 'door') {
                    if(Inventory.has(Items.GLASSES.id)) {
                        this.startPhase3Transition();
                    } else {
                        Modal.msg("×¡×›× ×”", "×—×•×©×š ××•×—×œ×˜. ×™×© ×œ×™×™×–×¨×™×. ××™ ××¤×©×¨ ×œ×¢×‘×•×¨ ×‘×œ×™ ×œ×¨××•×ª ××•×ª×.");
                    }
                }

                // ×©×œ×‘ 3
                if(ref === 'cabinet' && !State.solved.includes('cabinet')) {
                    Inventory.add(Items.MIC);
                    Inventory.add(Items.HEADSET); 
                    Inventory.add(Items.WIRE); // ×¡×ª× ×œ×”×©×œ××”
                    this.log("> ××¦××ª ×¦×™×•×“ ×”××–× ×”.");
                    State.solved.push('cabinet');
                    document.getElementById('hs-cabinet').style.display = 'none';
                }

                if(ref === 'arcadius') {
                    // ×œ×—×™×¦×” ×¢×•×‘×“×ª ×¨×§ ×“×¨×š ×”××™× ×™ ××©×—×§
                }
            },

            completePhase1() {
                State.phase = 2;
                this.log(Story.phase1_done);
                document.getElementById('overlay-gas').style.opacity = 0;
                
                // ××¢×‘×¨ ×•×™×–×•××œ×™
                setTimeout(() => {
                    document.getElementById('layer-train').style.opacity = 0;
                    document.getElementById('layer-hallway').style.opacity = 1;
                    
                    document.getElementById('ind-gas').classList.remove('active', 'danger');
                    document.getElementById('ind-vision').classList.add('active');

                    // ×—×©×™×¤×ª ×”×•×˜×¡×¤×•×˜×™×
                    document.getElementById('hs-vent').style.display = 'none';
                    document.getElementById('hs-debris').style.display = 'flex';
                    document.getElementById('hs-panel').style.display = 'flex';
                    document.getElementById('hs-door-lock').style.display = 'flex';
                }, 2000);
            },

            startPhase3Transition() {
                // ××¤×§×˜ ×¨××™×™×” ×ª×¨××™×ª
                document.getElementById('overlay-thermal').style.display = 'block';
                document.getElementById('overlay-thermal').style.opacity = 1;
                
                setTimeout(() => {
                    this.completePhase2();
                }, 3000);
            },

            completePhase2() {
                State.phase = 3;
                this.log(Story.phase2_done);
                
                document.getElementById('overlay-thermal').style.display = 'none';
                document.getElementById('layer-hallway').style.opacity = 0;
                document.getElementById('layer-engine').style.opacity = 1;
                document.getElementById('overlay-darkness').style.opacity = 1; // ×—×•×©×š ××•×—×œ×˜

                document.getElementById('ind-vision').classList.remove('active');
                document.getElementById('ind-audio').classList.add('active');

                document.getElementById('hs-debris').style.display = 'none';
                document.getElementById('hs-panel').style.display = 'none';
                document.getElementById('hs-door-lock').style.display = 'none';
                
                document.getElementById('hs-cabinet').style.display = 'flex';
                
                // ×‘×“×™×§×” ×× ×™×© ×¡×•×¨×§ ××•×›×Ÿ
                if(Inventory.has(Items.SONAR.id)) {
                    Minigames.startSonar();
                } else {
                    this.log("> ×‘× ×” ×’×œ××™ ×©××¢ ×›×“×™ ×œ××¦×•× ××•×ª×•.");
                }
            }
        };

        /**
         * ==========================================================================
         * 3. ××¢×¨×›×ª ××œ××™ ×•×”×¨×›×‘×” (INVENTORY & CRAFTING)
         * ==========================================================================
         */
        const Inventory = {
            items: [],
            
            initGrid() {
                const grid = document.getElementById('inventory-grid');
                grid.innerHTML = '';
                for(let i=0; i<12; i++) {
                    const div = document.createElement('div');
                    div.className = 'inv-item';
                    div.id = `inv-${i}`;
                    div.onclick = () => this.selectItem(i);
                    grid.appendChild(div);
                }
            },

            add(itemObj) {
                this.items.push(itemObj);
                this.render();
            },

            has(id) {
                return this.items.some(i => i.id === id);
            },

            render() {
                // × ×§×” ×”×›×œ
                document.querySelectorAll('.inv-item').forEach(el => {
                    el.innerHTML = '';
                    el.classList.remove('selected');
                });

                this.items.forEach((item, idx) => {
                    const el = document.getElementById(`inv-${idx}`);
                    el.innerHTML = item.icon;
                    if(State.craftingSlots.includes(idx)) el.classList.add('selected');
                });
            },

            selectItem(idx) {
                if(!this.items[idx]) return;
                
                // ×× ×›×‘×¨ × ×‘×—×¨, ×‘×˜×œ ×‘×—×™×¨×”
                if(State.craftingSlots.includes(idx)) {
                    State.craftingSlots = State.craftingSlots.filter(i => i !== idx);
                } else {
                    // ×”×’×‘×œ×” ×œ-3 ×¤×¨×™×˜×™×
                    if(State.craftingSlots.length < 3) {
                        State.craftingSlots.push(idx);
                    }
                }
                this.render();
                Crafting.updateUI();
            },

            removeUsedItems() {
                State.craftingSlots.sort((a,b) => b-a);
                State.craftingSlots.forEach(idx => {
                    this.items.splice(idx, 1);
                });
                State.craftingSlots = [];
                this.render();
                Crafting.updateUI();
            }
        };

        const Crafting = {
            updateUI() {
                // ×¢×“×›×•×Ÿ ×”×¡×œ×•×˜×™× ×”×¢×œ×™×•× ×™×
                [1,2,3].forEach(i => {
                    const el = document.getElementById(`craft-${i}`);
                    el.innerHTML = '';
                    el.classList.remove('filled');
                });

                State.craftingSlots.forEach((invIdx, i) => {
                    const el = document.getElementById(`craft-${i+1}`);
                    const item = Inventory.items[invIdx];
                    el.innerHTML = item.icon;
                    el.classList.add('filled');
                });

                const btn = document.getElementById('btn-craft');
                if(State.craftingSlots.length === 3) {
                    btn.classList.add('ready');
                } else {
                    btn.classList.remove('ready');
                }
            },

            execute() {
                if(State.craftingSlots.length !== 3) return;

                const selected = State.craftingSlots.map(i => Inventory.items[i].id);
                
                // ××ª×›×•× ×™×
                if(this.checkRecipe(selected, ['motor', 'needle', 'battery'])) {
                    Inventory.removeUsedItems();
                    Inventory.add(Items.DRILL);
                    Game.log("<span class='highlight'>×”×¦×œ×—×”:</span> ×‘× ×™×ª ××§×“×— ×¨×˜×˜.");
                    return;
                }

                if(this.checkRecipe(selected, ['lens', 'sensor', 'drone_parts'])) {
                    Inventory.removeUsedItems();
                    Inventory.add(Items.GLASSES);
                    Game.log("<span class='highlight'>×”×¦×œ×—×”:</span> ×‘× ×™×ª ××©×§×¤×™×™× ×ª×¨××™×™×.");
                    return;
                }

                if(this.checkRecipe(selected, ['mic', 'headset', 'wire'])) {
                    Inventory.removeUsedItems();
                    Inventory.add(Items.SONAR);
                    Game.log("<span class='highlight'>×”×¦×œ×—×”:</span> ×”×¨×›×‘×ª ×¡×•×¨×§ ×©××¢.");
                    
                    if(State.phase === 3) Minigames.startSonar();
                    return;
                }

                Modal.msg("×©×’×™××”", "×©×™×œ×•×‘ ×¨×›×™×‘×™× ×œ× ×ª×§×™×Ÿ. × ×¡×” ×©×™×œ×•×‘ ××—×¨.");
            },

            checkRecipe(selectedIds, recipeIds) {
                if(selectedIds.length !== recipeIds.length) return false;
                return recipeIds.every(id => selectedIds.includes(id));
            }
        };

        /**
         * ==========================================================================
         * 4. ××™× ×™-××©×—×§×™× (MINIGAMES)
         * ==========================================================================
         */
        const Minigames = {
            // ××©×—×§ 1: ×™×™×¦×•×‘ ×ª×“×¨ (×œ×“×™×–×”)
            startDrill() {
                const html = `
                    <p style="color:#ddd">×›×•×•×Ÿ ××ª ×ª×“×¨ ×”×¨×˜×˜ (×›×—×•×œ) ×©×™×ª××™× ×œ××˜×¨×” (×™×¨×•×§).</p>
                    <div id="game-wave-container">
                        <canvas id="wave-canvas"></canvas>
                        <input type="range" id="wave-slider" class="slider-control" min="1" max="100" value="50">
                        <div id="wave-status">×œ× ××¡×•× ×›×¨×Ÿ</div>
                    </div>
                `;
                Modal.show("×›×™×•×œ ××§×“×— ×¨×˜×˜", html);
                
                setTimeout(() => {
                    const cvs = document.getElementById('wave-canvas');
                    const ctx = cvs.getContext('2d');
                    cvs.width = 600; cvs.height = 200;
                    
                    const slider = document.getElementById('wave-slider');
                    const status = document.getElementById('wave-status');
                    
                    let userVal = 50;
                    let targetVal = 72; // ×”××¡×¤×¨ ×”×¡×•×“×™
                    let time = 0;
                    let successTime = 0;

                    slider.oninput = (e) => userVal = parseInt(e.target.value);

                    const loop = () => {
                        if(!document.getElementById('wave-canvas')) return;
                        
                        ctx.fillStyle = '#000'; ctx.fillRect(0,0,600,200);
                        ctx.lineWidth = 2;
                        time += 0.2;

                        // ××˜×¨×”
                        ctx.strokeStyle = 'rgba(0, 255, 157, 0.3)'; 
                        ctx.beginPath();
                        for(let x=0; x<600; x++) {
                            const y = 100 + Math.sin((x + time*5) * (targetVal/500)) * 50;
                            if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                        }
                        ctx.stroke();

                        // ××©×ª××©
                        const diff = Math.abs(userVal - targetVal);
                        const isSynced = diff < 5;
                        
                        ctx.strokeStyle = isSynced ? '#ffb700' : '#00d9ff';
                        ctx.beginPath();
                        for(let x=0; x<600; x++) {
                            const freq = (userVal / 500); 
                            const y = 100 + Math.sin((x + time*5) * freq) * 50;
                            if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                        }
                        ctx.stroke();

                        if(isSynced) {
                            status.innerText = "× ×¢×•×œ! ×—×•×“×¨...";
                            status.style.color = "var(--status-ok)";
                            successTime++;
                            if(successTime > 100) {
                                Modal.close();
                                Game.completePhase1();
                                return;
                            }
                        } else {
                            status.innerText = "×œ× ××¡×•× ×›×¨×Ÿ";
                            status.style.color = "var(--status-crit)";
                            successTime = 0;
                        }
                        requestAnimationFrame(loop);
                    };
                    loop();
                }, 100);
            },

            // ××©×—×§ 3: ×¡×•× ××¨
            startSonar() {
                const html = `
                    <p>×”×§×©×‘ ×œ×¤×¢×™××•×ª ×”×œ×‘. ×œ×—×¥ ×¢×œ ×”× ×§×•×“×” ×”×œ×‘× ×” ×›×©×”×™× ××•×¤×™×¢×”.</p>
                    <div id="sonar-container">
                        <div id="sonar-sweep"></div>
                        <div id="sonar-dot"></div>
                    </div>
                `;
                Modal.show("×¡×•×¨×§ ×©××¢ ×›×™×•×•× ×™", html);

                setTimeout(() => {
                    const dot = document.getElementById('sonar-dot');
                    
                    setInterval(() => {
                        // ×ª× ×•×¢×” ×¨× ×“×•××œ×™×ª ×‘×ª×•×š ×”×¨×“××¨
                        const r = 80; 
                        const x = 125 + r * Math.cos(Date.now()/1000);
                        const y = 125 + r * Math.sin(Date.now()/1000);
                        dot.style.left = (x-10) + 'px';
                        dot.style.top = (y-10) + 'px';
                        
                        // ×”×‘×”×•×‘
                        dot.style.opacity = (Math.sin(Date.now()/100) > 0.8) ? 1 : 0; 
                    }, 50);

                    dot.onclick = () => {
                        Modal.close();
                        Modal.msg("× ×™×¦×—×•×Ÿ!", Story.win);
                        // ×¡×™×•× ×”××©×—×§
                    };

                }, 100);
            }
        };

        /**
         * ==========================================================================
         * 5. ×× ×•×¢ ×’×¨×¤×™ (FX)
         * ==========================================================================
         */
        const Fx = {
            initParticles() {
                const cvs = document.getElementById('particle-canvas');
                const ctx = cvs.getContext('2d');
                
                const resize = () => { cvs.width = window.innerWidth; cvs.height = window.innerHeight; };
                window.addEventListener('resize', resize);
                resize();

                const particles = Array.from({length: 50}, () => ({
                    x: Math.random() * cvs.width,
                    y: Math.random() * cvs.height,
                    size: Math.random() * 2,
                    speedY: Math.random() * 0.5 - 0.2
                }));

                const loop = () => {
                    ctx.clearRect(0,0,cvs.width,cvs.height);
                    ctx.fillStyle = "rgba(200, 255, 200, 0.3)";
                    
                    particles.forEach(p => {
                        p.y -= p.speedY; 
                        p.x += (Math.random()-0.5)*0.5;
                        if(p.y < 0) p.y = cvs.height;
                        if(p.y > cvs.height) p.y = 0;
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                        ctx.fill();
                    });
                    requestAnimationFrame(loop);
                };
                loop();
            }
        };

        /**
         * ==========================================================================
         * 6. × ×™×”×•×œ ×—×œ×•× ×•×ª (MODAL MANAGER)
         * ==========================================================================
         */
        const Modal = {
            show(title, html) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content').innerHTML = html;
                document.getElementById('modal-game').classList.add('active');
            },
            close() {
                document.getElementById('modal-game').classList.remove('active');
            },
            msg(title, text) {
                document.getElementById('msg-title').innerText = title;
                document.getElementById('msg-text').innerHTML = text;
                document.getElementById('modal-msg').classList.add('active');
            },
            closeMsg() {
                document.getElementById('modal-msg').classList.remove('active');
            }
        };

        /**
         * ==========================================================================
         * 7. ××ª×—×•×œ (BOOT SEQUENCE)
         * ==========================================================================
         */
        window.onload = () => {
            const bootText = document.getElementById('boot-text');
            const lines = [
                "INITIALIZING NEURAL LINK...",
                "LOADING BIOMIMETIC DRIVERS...",
                "CONNECTING TO TRAIN SYSTEM...",
                "USER: ADAM (ENGINEER)",
                "ACCESS GRANTED."
            ];
            
            let i = 0;
            const interval = setInterval(() => {
                if(i < lines.length) {
                    bootText.innerHTML += lines[i] + "\n";
                    i++;
                } else {
                    clearInterval(interval);
                    document.getElementById('boot-bar').style.width = "100%";
                    setTimeout(() => {
                        document.getElementById('boot-layer').style.display = 'none';
                        document.getElementById('app-wrapper').style.opacity = 1;
                        Game.init();
                    }, 1000);
                }
            }, 600);
        };

    </script>
</body>
</html>
