<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××‘×¦×¢ ×§×•×œ×§×¡: ×××©×§ ××—×§×¨ ×‘×™×•××™××˜×™ - ×’×¨×¡×” ××•×œ×˜×™××˜×™×‘×™×ª</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&family=Assistant:wght@300;400;600;800&family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* * ==========================================================================
         * 1. ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×•××™×¤×•×¡ (CSS VARIABLES & RESET)
         * ==========================================================================
         */
        :root {
            /* ×¤×œ×˜×ª ×¦×‘×¢×™× ×¨××©×™×ª */
            --bg-deep: #020202;
            --bg-panel: #0b0c10;
            --bg-panel-trans: rgba(11, 12, 16, 0.95);
            
            --border-dim: #1f2833;
            --border-bright: #45a29e;

            /* ×¦×‘×¢×™ ×˜×§×¡×˜ ×•×××©×§ */
            --text-main: #c5c6c7;
            --text-highlight: #66fcf1;
            --text-header: #ffffff;

            /* ×¦×‘×¢×™ ×¡×˜×˜×•×¡ */
            --status-ok: #00ff9d;   /* ×™×¨×•×§ - ×ª×§×™×Ÿ/×‘×™×• */
            --status-warn: #ffae00; /* ×›×ª×•× - ××–×”×¨×” */
            --status-crit: #ff2a2a; /* ××“×•× - ×©×’×™××”/×¡×›× ×” */
            --status-tech: #00f2ff; /* ×ª×›×œ×ª - ×˜×›× ×•×œ×•×’×™×” */

            /* ××™×“×•×ª */
            --sidebar-width: 380px;
            --header-height: 70px;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* ×× ×™×¢×ª ×‘×—×™×¨×ª ×˜×§×¡×˜ ×œ×—×•×•×™×ª "××¤×œ×™×§×¦×™×”" */
            outline: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Assistant', sans-serif;
            overflow: hidden; /* ×× ×™×¢×ª ×’×œ×™×œ×” ×©×œ ×”×¢××•×“ ×›×•×œ×• */
        }

        /* * ==========================================================================
         * 2. ××¡×š ×˜×¢×™× ×” (BOOT SEQUENCE UI)
         * ==========================================================================
         */
        #boot-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Heebo', monospace;
            direction: ltr; /* ×œ×•×’ ×˜×¢×™× ×” ×‘×× ×’×œ×™×ª */
        }

        .boot-terminal {
            width: 600px;
            height: 300px;
            background: #050505;
            border: 1px solid #333;
            padding: 20px;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.1);
            margin-bottom: 20px;
            color: var(--status-tech);
            font-size: 14px;
            line-height: 1.6;
        }

        .progress-container {
            width: 600px;
            height: 6px;
            background: #222;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: var(--status-ok);
            box-shadow: 0 0 15px var(--status-ok);
            transition: width 0.2s linear;
        }

        /* * ==========================================================================
         * 3. ×¤×¨×™×¡×ª ×¢××•×“ ×¨××©×™×ª (MAIN GRID LAYOUT)
         * ==========================================================================
         */
        #app-container {
            display: grid;
            grid-template-columns: 1fr var(--sidebar-width); /* ×ª××•× ×” ××©×××œ, ×¡×¨×’×œ ××™××™×Ÿ */
            grid-template-rows: var(--header-height) 1fr;
            width: 100vw;
            height: 100vh;
            opacity: 0; /* ××•×¡×ª×¨ ×‘×”×ª×—×œ×” */
            transition: opacity 1.5s ease-in;
        }

        /* --- ×›×•×ª×¨×ª ×¢×œ×™×•× ×” --- */
        #top-header {
            grid-column: 1 / -1;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--border-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-text {
            font-family: 'Rubik', sans-serif;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--text-highlight);
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(102, 252, 241, 0.4);
        }

        .version-tag {
            background: var(--border-dim);
            color: #888;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        .system-indicators {
            display: flex;
            gap: 20px;
            font-size: 14px;
            font-family: 'Heebo', monospace;
        }

        .indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--status-ok);
        }
        
        .blink-dot {
            width: 8px; height: 8px;
            background: var(--status-ok);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--status-ok);
            animation: pulse-dot 2s infinite;
        }

        /* --- ××–×•×¨ ×”××©×—×§ (VIEWPORT) --- */
        #game-viewport {
            position: relative;
            background: #000;
            overflow: hidden;
            border-left: 1px solid var(--border-dim); /* ×”×¤×¨×“×” ××”×¡×¨×’×œ */
            cursor: default;
        }

        /* ×©×›×‘×•×ª ×¨×§×¢ (Layers) */
        .scene-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 2s ease-in-out;
            opacity: 0;
            z-index: 1;
        }

        /* ×”×’×“×¨×ª ×ª××•× ×•×ª ×¨×§×¢ */
        #layer-day { background-image: url('https://i.ibb.co/7tQt5S0h/Gemini-Generated-Image-prcu4rprcu4rprcu.png'); opacity: 1; }
        #layer-night { background-image: url('https://i.ibb.co/svJJmvYr/Gemini-Generated-Image-l4kaehl4kaehl4ka.png'); opacity: 0; }
        #layer-lab { background-image: url('https://i.ibb.co/d04yrgRx/Gemini-Generated-Image-j02tg6j02tg6j02t.png'); opacity: 0; }

        /* ×§× ×‘×¡ ×œ××¤×§×˜×™× (×—×œ×§×™×§×™×) */
        #fx-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; pointer-events: none;
        }

        /* ×©×›×‘×ª ×¡×•×¨×§ (Scanner Overlay) */
        #scan-fx {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 242, 255, 0.03),
                rgba(0, 242, 255, 0.03) 1px,
                transparent 1px,
                transparent 3px
            );
            pointer-events: none; z-index: 10;
            opacity: 0; transition: opacity 0.5s;
        }
        .scanner-active #scan-fx { opacity: 1; }

        /* --- × ×§×•×“×•×ª ×œ×—×™×¦×” (HOTSPOTS) --- */
        #hotspots-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
        }

        .hotspot {
            position: absolute;
            z-index: 30;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
            opacity: 0; /* × ×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ */
            border: 1px dashed rgba(255, 255, 255, 0.3);
        }

        /* ×‘××¦×‘ ×¡×•×¨×§ - ×”× ×§×•×“×•×ª ××”×‘×”×‘×•×ª */
        .scanner-active .hotspot {
            opacity: 0.5;
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--status-tech);
            animation: scan-pulse 2s infinite;
        }

        .hotspot:hover {
            opacity: 1 !important;
            background: rgba(0, 242, 255, 0.2);
            border: 2px solid #fff;
            box-shadow: 0 0 25px var(--status-tech);
            transform: scale(1.1);
        }

        /* ××™×§×•××™ ×”××•×‘×™×™×§×˜×™× (×‘××—×•×–×™× ×œ×˜×•×‘×ª ×¨×¡×¤×•× ×¡×™×‘×™×•×ª) */
        /* ×¨×›×‘×ª */
        #spot-cat { top: 14%; left: 20%; width: 12%; height: 14%; }
        #spot-map { top: 35%; left: 9%;  width: 18%; height: 23%; }
        #spot-window { top: 22%; left: 35%; width: 28%; height: 38%; }
        #spot-hat { top: 26%; left: 67%; width: 10%; height: 16%; }
        #spot-door { top: 18%; left: 78%; width: 20%; height: 75%; }
        
        /* ××¢×‘×“×” */
        #spot-flask { top: 55%; left: 25%; width: 15%; height: 25%; }
        #spot-jar { top: 15%; left: 60%; width: 25%; height: 55%; }
        #spot-notes { top: 70%; left: 45%; width: 20%; height: 15%; }

        .hidden { display: none !important; }

        /* --- ×¡×¨×’×œ ×¦×“ (SIDEBAR) --- */
        #sidebar {
            background: var(--bg-panel);
            border-right: 2px solid var(--border-dim);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: -5px 0 30px rgba(0,0,0,0.8);
            z-index: 50;
            gap: 20px;
        }

        /* ×¤×× ×œ×™× ×‘×¡×¨×’×œ */
        .side-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-dim);
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .side-title {
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            color: var(--text-highlight);
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        /* ×›×¤×ª×•×¨ ×¡×•×¨×§ */
        #btn-scanner {
            width: 100%;
            padding: 15px;
            background: transparent;
            border: 1px solid var(--status-tech);
            color: var(--status-tech);
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }

        #btn-scanner:hover {
            background: rgba(0, 242, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }

        #btn-scanner.active {
            background: var(--status-tech);
            color: #000;
            box-shadow: 0 0 20px var(--status-tech);
        }

        /* ×ª×™×‘×ª ××©×™××•×ª */
        #mission-text {
            font-size: 15px;
            line-height: 1.5;
            color: #ddd;
        }

        /* ×œ×•×’ ××¢×¨×›×ª */
        #sys-log {
            height: 180px;
            overflow-y: auto;
            font-family: 'Heebo', monospace;
            font-size: 13px;
            color: #888;
            border-top: 1px solid #222;
            padding-top: 5px;
        }

        .log-line {
            margin-bottom: 6px;
            border-right: 2px solid #333;
            padding-right: 8px;
        }
        .log-line.new { color: var(--status-ok); border-color: var(--status-ok); }
        .log-line.err { color: var(--status-crit); border-color: var(--status-crit); }

        /* ×›×¤×ª×•×¨ ×ª×™×§ */
        #btn-inventory {
            margin-top: auto; /* ×“×•×—×£ ×œ×ª×—×ª×™×ª */
            height: 70px;
            background: #111;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        #btn-inventory:hover {
            border-color: var(--status-ok);
            background: rgba(0, 255, 157, 0.05);
        }

        .bag-icon { font-size: 30px; margin-left: 10px; }
        .bag-text { font-weight: bold; color: #aaa; }

        /* * ==========================================================================
         * 4. ×—×œ×•× ×•×ª ×§×•×¤×¦×™× (MODALS & OVERLAYS)
         * ==========================================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-frame {
            background: #0f1015;
            border: 2px solid var(--text-highlight);
            box-shadow: 0 0 40px rgba(102, 252, 241, 0.2);
            padding: 30px;
            width: 700px;
            max-width: 90%;
            border-radius: 12px;
            position: relative;
            display: flex; flex-direction: column;
        }

        .modal-close {
            position: absolute; top: 15px; left: 20px;
            font-size: 24px; color: #666; cursor: pointer;
            transition: 0.2s;
        }
        .modal-close:hover { color: #fff; }

        .modal-header {
            font-family: 'Heebo'; font-size: 22px; color: var(--text-highlight);
            margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;
            text-align: center; letter-spacing: 1px;
        }

        /* ×¢×™×¦×•×‘ ×”×ª×™×§ (Inventory Grid) */
        #inv-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
            min-height: 200px;
        }

        .inv-slot {
            aspect-ratio: 1;
            background: #050505;
            border: 1px solid #333;
            border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.2s;
            position: relative;
        }
        .inv-slot:hover { border-color: var(--status-ok); background: #0a100d; }
        .inv-slot.selected { border-color: var(--status-ok); box-shadow: 0 0 15px rgba(0,255,157,0.3); }

        .inv-icon { font-size: 40px; margin-bottom: 5px; }
        .inv-name { font-size: 13px; color: #888; text-align: center; }

        /* ××–×•×¨ ×¤×¨×˜×™ ×—×¤×¥ */
        #inv-details {
            margin-top: 20px; padding: 15px; background: #181818;
            border-radius: 6px; display: none; border: 1px solid #333;
        }
        .btn-action {
            background: var(--text-highlight); color: #000; border: none;
            padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px;
            margin-top: 10px; font-size: 16px; transition: 0.2s;
        }
        .btn-action:hover { background: #fff; transform: scale(1.05); }

        /* --- ××™× ×™-××©×—×§ ×ª×“×¨×™× (Wave Tuner) --- */
        #tuner-container {
            display: flex; flex-direction: column; align-items: center; width: 100%;
        }
        #wave-canvas {
            width: 100%; height: 200px;
            background: #000; border: 2px solid #333; border-radius: 6px;
            margin-bottom: 20px;
        }
        #wave-controls {
            width: 80%; display: flex; align-items: center; gap: 15px;
        }
        input[type=range] { flex-grow: 1; cursor: pointer; }
        #tuner-status { font-size: 20px; font-weight: bold; margin-top: 15px; min-height: 30px; }

        /* --- ××™× ×™-××©×—×§ ×›×™××™×” (Chemistry) --- */
        #chem-container {
            display: flex; justify-content: center; align-items: flex-end; gap: 30px;
            height: 250px; padding-bottom: 20px;
        }
        .test-tube {
            width: 50px; height: 120px; border: 2px solid rgba(255,255,255,0.5);
            border-radius: 0 0 25px 25px; position: relative; cursor: pointer; overflow: hidden;
            transition: transform 0.2s;
        }
        .test-tube:hover { transform: translateY(-10px); }
        .liquid { position: absolute; bottom: 0; width: 100%; height: 60%; opacity: 0.8; }
        
        .flask-main {
            width: 100px; height: 160px; border: 3px solid #fff;
            border-radius: 0 0 50px 50px; position: relative; overflow: hidden;
        }
        .flask-liquid {
            position: absolute; bottom: 0; width: 100%; height: 0%;
            background: #222; transition: all 0.5s ease;
        }

        /* ×× ×™××¦×™×•×ª */
        @keyframes pulse-dot { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        @keyframes scan-pulse { 0% { opacity: 0.3; } 50% { opacity: 0.7; } 100% { opacity: 0.3; } }

    </style>
</head>
<body>

    <div id="boot-layer">
        <div class="boot-terminal" id="boot-log"></div>
        <div class="progress-container">
            <div class="progress-bar" id="boot-bar"></div>
        </div>
        <div style="margin-top:10px; color:#666; font-size:12px;">×××ª×—×œ ××¢×¨×›×ª ×‘×™×•××™××˜×™×ª BSF-v3.0...</div>
    </div>

    <div id="app-container">
        
        <header id="top-header">
            <div class="logo-area">
                <div class="logo-text">MIVTZA CULEX</div>
                <div class="version-tag">ULTIMATE EDITION</div>
            </div>
            <div class="system-indicators">
                <div class="indicator" id="ind-time">12:00:00</div>
                <div class="indicator" id="ind-status"><div class="blink-dot"></div> ××¢×¨×›×•×ª ××§×•×•× ×•×ª</div>
            </div>
        </header>

        <main id="game-viewport">
            <div id="scan-fx"></div>
            <canvas id="fx-canvas"></canvas>

            <div id="layer-lab" class="scene-layer"></div>
            <div id="layer-night" class="scene-layer"></div>
            <div id="layer-day" class="scene-layer"></div>

            <div id="hotspots-container">
                <div id="spot-cat" class="hotspot train-obj" data-id="cat"></div>
                <div id="spot-map" class="hotspot train-obj" data-id="map"></div>
                <div id="spot-window" class="hotspot train-obj" data-id="window"></div>
                <div id="spot-hat" class="hotspot train-obj" data-id="hat"></div>
                <div id="spot-door" class="hotspot train-obj" data-id="door"></div>

                <div id="spot-flask" class="hotspot lab-obj hidden" data-id="flask"></div>
                <div id="spot-jar" class="hotspot lab-obj hidden" data-id="jar"></div>
                <div id="spot-notes" class="hotspot lab-obj hidden" data-id="notes"></div>
            </div>
        </main>

        <aside id="sidebar">
            <button id="btn-scanner" onclick="Game.toggleScanner()">
                <span>ğŸ‘ï¸</span> ×¡×•×¨×§ ×ª×¨××™ [×›×‘×•×™]
            </button>

            <div class="side-panel">
                <div class="side-title">×”× ×—×™×•×ª ××©×™××”</div>
                <div id="mission-text">×××ª×™×Ÿ ×œ×¤×§×•×“×•×ª...</div>
            </div>

            <div class="side-panel" style="flex-grow: 1; display: flex; flex-direction: column;">
                <div class="side-title">×™×•××Ÿ ××™×¨×•×¢×™×</div>
                <div id="sys-log"></div>
            </div>

            <div id="btn-inventory" onclick="Inventory.openUI()">
                <div class="bag-icon">ğŸ’</div>
                <div class="bag-text">×ª×™×§ ×¦×™×•×“ <span id="inv-count" style="font-size:12px; color:#666;">(1)</span></div>
            </div>
        </aside>

    </div>

    <div id="mdl-inventory" class="modal-overlay">
        <div class="modal-frame">
            <div class="modal-close" onclick="Modal.close('mdl-inventory')">Ã—</div>
            <div class="modal-header">×××’×¨ ×¦×™×•×“ ×•×¨××™×•×ª</div>
            
            <div id="inv-grid"></div>

            <div id="inv-details">
                <h3 id="inv-item-name" style="margin:0 0 10px 0; color:var(--text-highlight);"></h3>
                <p id="inv-item-desc" style="color:#ccc; font-size:14px; line-height:1.5;"></p>
                <button id="inv-use-btn" class="btn-action">×”×©×ª××© ×‘×¤×¨×™×˜</button>
            </div>
        </div>
    </div>

    <div id="mdl-game" class="modal-overlay">
        <div class="modal-frame">
            <div class="modal-close" onclick="Modal.close('mdl-game')">Ã—</div>
            <div class="modal-header" id="game-title">××ª×’×¨ ××‘×˜×—×”</div>
            <div id="game-content"></div>
        </div>
    </div>

    <script>
        /**
         * ==========================================================================
         * × ×™×”×•×œ × ×ª×•× ×™× (DATA & CONFIG)
         * ==========================================================================
         */
        const Config = {
            dayDuration: 60, // ×©× ×™×•×ª ×œ×™×•× ×©×œ× ×‘××©×—×§
            nightThreshold: 30
        };

        const Items = {
            DRONE: { id: 'drone', icon: '<img src="https://i.ibb.co/hRjbfw3Q/Gemini-Generated-Image-d7ptmd7ptmd7ptmd.png" style="width:80%; height:80%; object-fit:contain;">', name: '×¨×—×¤×Ÿ ×™×ª×•×©', desc: '×¨×—×¤×Ÿ ×‘×™×•××™××˜×™ ×–×¢×™×¨ ×”××¡×•×’×œ ×œ×©××ª ××˜×¢×Ÿ × ×•×–×œ×™. ××¦×•×™×“ ×‘××¢×¨×›×•×ª ×™×™×¦×•×‘.' },
            NEEDLE: { id: 'needle', icon: 'ğŸ’‰', name: '××—×˜ ××™×§×¨×•× ×™×ª', desc: '×˜×›× ×•×œ×•×’×™×™×ª ×”×–×¨×§×” ×œ×œ× ×›××‘ ×‘×”×©×¨××ª ×—×“×§ ×”×™×ª×•×©.' },
            SENSOR: { id: 'sensor', icon: 'ğŸŒ¡ï¸', name: '×—×™×™×©×Ÿ ×ª×¨××™', desc: '××¢×¨×›×ª ×–×™×”×•×™ ×—×•× ××¨×—×•×§. ×—×™×•× ×™×ª ×œ× ×™×•×•×˜.' },
            GYRO: { id: 'gyro', icon: 'âš–ï¸', name: '××™×™×¦×‘ ×’×™×¨×•×¡×§×•×¤×™', desc: '×¨×›×™×‘ ×™×™×¦×•×‘ ×˜×™×¡×” ××‘×•×¡×¡ ×‘×•×›× ×™×•×ª (Halteres) ×©×œ ×™×ª×•×©.' },
            CHEM: { id: 'chem', icon: 'ğŸ‘ƒ', name: '×—×™×™×©×Ÿ ×›×™××™', desc: '×—×™×™×©×Ÿ ×¨×’×™×© ×œ×¤×—××Ÿ ×“×•-×—××¦× ×™ ×•×¨×™×—×•×ª ×’×•×£.' },
            FORMULA: { id: 'formula', icon: 'ğŸ“œ', name: '× ×•×¡×—×ª ×”×¨×¢×œ', desc: '×“×¤×™× ××™×•×× ×• ×©×œ ×”××“×¢×Ÿ ×”××¤×¨×˜×™× ××ª ×”×¨×›×‘ ×”×¨×¢×œ×Ÿ.' },
            ANTIDOTE: { id: 'antidote', icon: 'ğŸ§ª', name: '×”× ×•×’×“×Ÿ', desc: '× ×•×–×œ ×›×—×•×œ ×–×•×”×¨ ×”××¡×•×’×œ ×œ× ×˜×¨×œ ××ª ×”×©×¤×¢×ª ×”×¨×¢×œ.' }
        };

        const State = {
            phase: 'TRAIN', // TRAIN -> LAB
            inventory: [],
            isScannerOn: false,
            isNight: false,
            time: 0,
            solved: [], // ×¨×©×™××ª ××©×™××•×ª ×©× ×¤×ª×¨×•
            selectedItem: null // ×¤×¨×™×˜ ×©× ×‘×—×¨ ×‘×ª×™×§
        };

        /**
         * ==========================================================================
         * ×× ×•×¢ ×”××©×—×§ (GAME ENGINE)
         * ==========================================================================
         */
        const Game = {
            init() {
                Inventory.add(Items.DRONE);
                Log.add("×©×œ×‘ 1: ××™×¡×•×£ ×¨×›×™×‘×™× ×‘×™×•××™××˜×™×™× ×‘×¨×›×‘×ª.", true);
                this.updateObjective();
                
                // ×”×¤×¢×œ×ª ××¤×§×˜×™× ×•×©×¢×•×Ÿ
                Fx.start();
                setInterval(this.gameLoop, 1000);

                // ×”×’×“×¨×ª ×œ×—×™×¦×•×ª
                document.querySelectorAll('.hotspot').forEach(el => {
                    el.addEventListener('click', (e) => this.handleHotspot(e.target));
                });
            },

            gameLoop() {
                State.time++;
                // ×©×¢×•×Ÿ ×•×™×–×•××œ×™
                const now = new Date();
                document.getElementById('ind-time').innerText = now.toLocaleTimeString('he-IL');

                // ××—×–×•×¨ ×™×•×/×œ×™×œ×” ×¤×©×•×˜ (×œ×¦×•×¨×š ×”××•×•×™×¨×”)
                if (State.phase === 'TRAIN') {
                    const cycle = State.time % Config.dayDuration;
                    const nightMode = cycle > Config.nightThreshold;
                    
                    if (nightMode !== State.isNight) {
                        State.isNight = nightMode;
                        Game.toggleNightVisuals(nightMode);
                    }
                }
            },

            toggleNightVisuals(isNight) {
                const dayLayer = document.getElementById('layer-day');
                const nightLayer = document.getElementById('layer-night');
                const status = document.getElementById('ind-status');

                if (isNight) {
                    dayLayer.style.opacity = 0;
                    nightLayer.style.opacity = 1;
                    status.innerHTML = '<div class="blink-dot" style="background:orange; box-shadow:0 0 5px orange"></div> ×ª××•×¨×” × ××•×›×”';
                    status.style.color = "orange";
                    Log.add("× ×›× ×¡ ×œ××¦×‘ ×œ×™×œ×”. ×¨××•×ª ××•×’×‘×œ×ª.");
                    Fx.mode = 'fireflies';
                } else {
                    dayLayer.style.opacity = 1;
                    nightLayer.style.opacity = 0;
                    status.innerHTML = '<div class="blink-dot"></div> ××¢×¨×›×•×ª ××§×•×•× ×•×ª';
                    status.style.color = "var(--status-ok)";
                    Log.add("×–×¨×™×—×” ×–×•×”×ª×”. ××¢×¨×›×•×ª ×¡×•×œ××¨×™×•×ª ×‘×˜×¢×™× ×”.");
                    Fx.mode = 'dust';
                }
            },

            toggleScanner() {
                State.isScannerOn = !State.isScannerOn;
                const btn = document.getElementById('btn-scanner');
                const overlay = document.getElementById('scan-fx');
                
                if (State.isScannerOn) {
                    btn.innerHTML = "<span>ğŸ‘ï¸</span> ×¡×•×¨×§ ×ª×¨××™ [×¤×¢×™×œ]";
                    btn.classList.add('active');
                    overlay.classList.add('active');
                    document.body.classList.add('scanner-active');
                    Log.add("×¡×•×¨×§ ×”×•×¤×¢×œ. ×—×ª×™××•×ª ×—×•× ×’×œ×•×™×•×ª.");
                } else {
                    btn.innerHTML = "<span>ğŸ‘ï¸</span> ×¡×•×¨×§ ×ª×¨××™ [×›×‘×•×™]";
                    btn.classList.remove('active');
                    overlay.classList.remove('active');
                    document.body.classList.remove('scanner-active');
                }
            },

            updateObjective() {
                const txt = document.getElementById('mission-text');
                if (State.phase === 'TRAIN') {
                    const req = ['needle', 'sensor', 'gyro', 'chem'];
                    const count = req.filter(id => Inventory.has(id)).length;
                    
                    if (count < 4) {
                        txt.innerText = `××¦× 4 ×¨×›×™×‘×™× ×‘×™×•××™××˜×™×™× ×‘×§×¨×•×Ÿ ×›×“×™ ×œ×©×“×¨×’ ××ª ×”×¨×—×¤×Ÿ ×•×œ×¤×¨×•×¥ ×œ××¢×‘×“×”. (${count}/4)`;
                    } else {
                        txt.innerText = "×›×œ ×”×¨×›×™×‘×™× × ××¡×¤×•! ×’×© ×œ×“×œ×ª ×”××¢×‘×“×” ×•×¤×¨×•×¥ ××ª ×”×× ×¢×•×œ.";
                        document.getElementById('spot-door').style.borderColor = "var(--status-ok)";
                    }
                } else {
                    if (!Inventory.has('formula')) txt.innerText = "××ª×¨ ××ª ×™×•××Ÿ ×”××—×§×¨ ×›×“×™ ×œ××¦×•× ××ª ×”× ×•×¡×—×”.";
                    else if (!Inventory.has('antidote')) txt.innerText = "×”×©×ª××© ×‘× ×•×¡×—×” ×‘×¢××“×ª ×”×›×™××™×” ×›×“×™ ×œ×™×™×¦×¨ × ×•×’×“×Ÿ.";
                    else txt.innerText = "×”×©×ª××© ×‘×¨×—×¤×Ÿ (××”×ª×™×§) ×¢×œ ×¦× ×¦× ×ª ×”× ×—×™×œ ×›×“×™ ×œ×¡×™×™×.";
                }
            },

            handleHotspot(target) {
                const id = target.dataset.id;
                
                // ×—×•×§×™×•×ª ×¡×•×¨×§ (×—×•×‘×” ×œ×”×¤×¢×™×œ ×¡×•×¨×§ ×œ×¨×•×‘ ×”×—×¤×¦×™×)
                if (!State.isScannerOn && id !== 'door' && id !== 'jar') {
                    Log.add("×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××•×‘×™×™×§×˜. × ×“×¨×©×ª ×¡×¨×™×§×” ×ª×¨××™×ª.", true);
                    return;
                }

                if (State.solved.includes(id)) {
                    Log.add("××•×‘×™×™×§×˜ ×–×” ×›×‘×¨ × ×—×§×¨.");
                    return;
                }

                switch(id) {
                    case 'cat':
                        Minigames.riddle("×˜×›× ×•×œ×•×’×™×™×ª ×—××§× ×•×ª", "×× ×™ ×“×•×§×¨ ×‘×œ×™ ×œ×”×¢×™×¨, × ×™×–×•×Ÿ ×‘×œ×™ ×œ×”×›××™×‘. ×”×¢×™×¦×•×‘ ×©×œ×™ ×××–×¢×¨ ×—×™×›×•×š. ××™×–×” ×—×¨×§ ×× ×™ ××—×§×”?", "×™×ª×•×©", Items.NEEDLE, id);
                        break;
                    case 'map':
                        Minigames.riddle("××¢×¨×›×ª ××¢×§×‘", "×™×© ×œ×™ ×”×¨×™× ×‘×œ×™ ×¡×œ×¢×™× ×•×™××™× ×‘×œ×™ ××™×. ×× ×™ ×¢×•×–×¨ ×œ×š ×œ××¦×•× ×—×•× ×××¨×—×§.", "××¤×”", Items.SENSOR, id);
                        break;
                    case 'hat':
                        Minigames.riddle("×—×™×™×©× ×™ ×›×™××™×”", "×× ×™ ×™×•×©×‘ ××¢×œ ×”×¢×™× ×™×™× ×•××¡××œ ×¡××›×•×ª. ×× ×™ ××›×•×•×Ÿ ××ª ×”×“×¨×š ×›××• ××—×•×©×™×.", "×›×•×‘×¢", Items.CHEM, id);
                        break;
                    case 'window':
                        // ××ª×’×¨ ×”-Wave Tuner ×”××•×¨×›×‘
                        Minigames.tuner(id);
                        break;
                    case 'door':
                        const req = ['needle', 'sensor', 'gyro', 'chem'];
                        if (req.every(i => Inventory.has(i))) {
                            Minigames.keypad();
                        } else {
                            Log.add("×’×™×©×” × ×“×—×ª×”. ×—×¡×¨×™× ×¨×›×™×‘×™ ×¤×¨×™×¦×”.", true);
                        }
                        break;
                    
                    // --- ×©×œ×‘ ××¢×‘×“×” ---
                    case 'notes':
                        Minigames.riddle("×¤×¢× ×•×— ×™×•××Ÿ", "×›×“×™ ×œ××¦×•× ××ª ×”× ×•×¡×—×”, ×¢×œ×™×š ×œ×¢×¨×‘×‘ ××ª ×¦×‘×¢ ×”×˜×‘×¢ ×¢× ×¦×‘×¢ ×”×©××™×™×.", "×™×¨×•×§", Items.FORMULA, id);
                        break;
                    case 'flask':
                        Log.add("×¢××“×ª ×›×™××™×”. ×‘×—×¨ ××ª '× ×•×¡×—×ª ×”×¨×¢×œ' ×‘×ª×™×§ ×•×”×©×ª××© ×‘×” ×›××Ÿ.");
                        break;
                    case 'jar':
                        Log.add("××˜×¨×” ×–×•×”×ª×”: × ×—×™×œ ×§×˜×œ× ×™. × ×“×¨×© × ×•×’×“×Ÿ.", true);
                        break;
                }
            },

            // ××¢×‘×¨ ×©×œ×‘
            transitionToLab() {
                State.phase = 'LAB';
                document.getElementById('game-viewport').style.opacity = 0;
                
                setTimeout(() => {
                    // ×”×—×œ×¤×ª ×ª×¤××•×¨×”
                    document.querySelectorAll('.train-obj').forEach(e => e.classList.add('hidden'));
                    document.querySelectorAll('.lab-obj').forEach(e => e.classList.remove('hidden'));
                    document.getElementById('layer-lab').style.opacity = 1;
                    
                    document.getElementById('game-viewport').style.opacity = 1;
                    Log.add("×¤×¨×™×¦×” ×”×•×©×œ××”. × ×›× ×¡ ×œ××¢×‘×“×”.", true);
                    this.updateObjective();
                }, 1500);
            }
        };

        /**
         * ==========================================================================
         * × ×™×”×•×œ ××œ××™ (INVENTORY SYSTEM)
         * ==========================================================================
         */
        const Inventory = {
            add(item) {
                if (this.has(item.id)) return;
                State.inventory.push(item);
                Log.add(`×¤×¨×™×˜ × ××¡×£: ${item.name}`, true);
                Game.updateObjective();
                
                // ×¢×“×›×•×Ÿ ××•× ×”
                document.getElementById('inv-count').innerText = `(${State.inventory.length})`;
            },
            
            has(id) { return State.inventory.some(i => i.id === id); },

            openUI() {
                const grid = document.getElementById('inv-grid');
                grid.innerHTML = '';
                document.getElementById('inv-details').style.display = 'none';
                State.selectedItem = null;

                State.inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'inv-slot';
                    el.innerHTML = `<div class="inv-icon">${item.icon}</div><div class="inv-name">${item.name}</div>`;
                    el.onclick = () => this.selectItem(item, el);
                    grid.appendChild(el);
                });

                Modal.open('mdl-inventory');
            },

            selectItem(item, el) {
                document.querySelectorAll('.inv-slot').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                State.selectedItem = item;

                document.getElementById('inv-details').style.display = 'block';
                document.getElementById('inv-item-name').innerText = item.name;
                document.getElementById('inv-item-desc').innerText = item.desc;
                
                const btn = document.getElementById('inv-use-btn');
                btn.onclick = () => this.useItem(item);
            },

            useItem(item) {
                Modal.close('mdl-inventory');
                
                // ×œ×•×’×™×§×ª ×©×™××•×© ×‘×—×¤×¦×™×
                if (State.phase === 'LAB') {
                    if (item.id === 'formula') {
                        // ×¤×ª×™×—×ª ××©×—×§ ×”×›×™××™×”
                        Minigames.chemistry();
                        return;
                    }
                    if (item.id === 'drone' && Inventory.has('antidote')) {
                        // ×¡×™×•× ×”××©×—×§
                        Minigames.victory();
                        return;
                    }
                }
                
                Log.add(`×œ× × ×™×ª×Ÿ ×œ×”×©×ª××© ×‘-${item.name} ×›×¨×’×¢.`, true);
            }
        };

        /**
         * ==========================================================================
         * ××™× ×™-××©×—×§×™× (MINIGAMES)
         * ==========================================================================
         */
        const Minigames = {
            // 1. ×—×™×“×ª ×˜×§×¡×˜
            riddle(title, text, key, reward, refId) {
                const html = `
                    <p style="color:#ccc; margin-bottom:20px;">${text}</p>
                    <input type="text" id="riddle-inp" class="riddle-input" placeholder="×”×›× ×¡ ×ª×©×•×‘×”...">
                    <button class="action-btn" onclick="Minigames.checkRiddle('${key}', '${reward.id}', '${refId}')">×××ª × ×ª×•× ×™×</button>
                    <p id="riddle-msg" style="color:var(--status-crit); height:20px; margin-top:10px;"></p>
                `;
                document.getElementById('game-title').innerText = title;
                document.getElementById('game-content').innerHTML = html;
                Modal.open('mdl-game');
            },

            checkRiddle(key, rewardId, refId) {
                const val = document.getElementById('riddle-inp').value.trim();
                if (val.includes(key)) {
                    Modal.close('mdl-game');
                    Inventory.add(Items[rewardId.toUpperCase()]);
                    State.solved.push(refId);
                    document.querySelector(`[data-id="${refId}"]`).style.display = 'none';
                } else {
                    document.getElementById('riddle-msg').innerText = "×©×’×™××”: × ×ª×•× ×™× ×œ× ×ª×•×××™×.";
                }
            },

            // 2. ×›×™×•×œ ×ª×“×¨ (Wave Tuner) - ××©×•×¤×¨ ×¢× Canvas ×•-Animation Loop
            tuner(refId) {
                const html = `
                    <p style="color:#aaa;">×¡× ×›×¨×Ÿ ××ª ×”×’×œ ×”×›×—×•×œ (×©×œ×š) ×¢× ×”×’×œ ×”×™×¨×•×§ (×”××˜×¨×”) ×‘×××¦×¢×•×ª ×”××—×•×•×Ÿ:</p>
                    <div id="tuner-container">
                        <canvas id="wave-canvas" width="600" height="200"></canvas>
                        <div id="wave-controls">
                            <span>×ª×“×¨:</span>
                            <input type="range" id="wave-slider" min="1" max="100" value="50">
                        </div>
                        <div id="tuner-status" style="color:var(--status-crit)">×œ× ××¡×•× ×›×¨×Ÿ</div>
                    </div>
                `;
                document.getElementById('game-title').innerText = "×™×™×¦×•×‘ ×’×™×¨×•×¡×§×•×¤×™";
                document.getElementById('game-content').innerHTML = html;
                Modal.open('mdl-game');

                // ×œ×•×’×™×§×ª ×§× ×‘×¡
                setTimeout(() => {
                    const canvas = document.getElementById('wave-canvas');
                    const ctx = canvas.getContext('2d');
                    const slider = document.getElementById('wave-slider');
                    const status = document.getElementById('tuner-status');
                    
                    let userFreq = 50;
                    slider.oninput = (e) => userFreq = parseInt(e.target.value);
                    
                    let offset = 0;
                    let animationFrame;

                    function draw() {
                        if (!document.getElementById('wave-canvas')) return; // ×™×¦×™××” ×× ×”×—×œ×•×Ÿ × ×¡×’×¨
                        
                        ctx.fillStyle = '#000';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.lineWidth = 3;
                        
                        offset += 0.2; // ×× ×™××¦×™×™×ª ×ª×–×•×–×”

                        // ×’×œ ××˜×¨×” (×™×¨×•×§) - ×ª×“×¨ ×§×‘×•×¢ (× × ×™×— 45 ×‘×¡×§××œ×” ×©×œ× ×•)
                        ctx.strokeStyle = 'rgba(0, 255, 157, 0.4)';
                        ctx.beginPath();
                        for (let x = 0; x < canvas.width; x++) {
                            const y = 100 + Math.sin((x + offset * 10) * 0.05) * 40;
                            if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                        }
                        ctx.stroke();

                        // ×’×œ ××©×ª××© (×›×—×•×œ)
                        // × ×•×¡×—×ª ×”××¨×”: ×”××˜×¨×” ×”×™× ×œ×”×’×™×¢ ×œ-0.05. ×”×¡×œ×™×™×“×¨ ×”×•× 1-100.
                        // × × ×™×— ×©×”××˜×¨×” ×”×™× ×‘×¢×¨×š 45 ×‘×¡×œ×™×™×“×¨.
                        const freq = 0.01 + (userFreq / 1000); 
                        // ×›×“×™ ×©×–×” ×™×”×™×” ××©×—×§×™, ×”××˜×¨×” ×”×™× ×¡×‘×™×‘ ×¢×¨×š ×¡×¤×¦×™×¤×™
                        // × ×’×™×“ ×”××˜×¨×” ×”×™× 0.05. ×”×¡×œ×™×™×“×¨ ×¦×¨×™×š ×œ×”×™×•×ª ×‘××–×•×¨ 40.
                        const targetFreq = 0.05;
                        const currentFreq = 0.03 + (userFreq / 2000); // ×›×™×•×•× ×•×Ÿ ×¢×“×™×Ÿ

                        const displayFreq = 0.03 + (userFreq * 0.0005);

                        ctx.strokeStyle = '#00f2ff';
                        ctx.beginPath();
                        for (let x = 0; x < canvas.width; x++) {
                            const y = 100 + Math.sin((x + offset * 10) * displayFreq) * 40;
                            if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                        }
                        ctx.stroke();

                        // ×‘×“×™×§×ª × ×™×¦×—×•×Ÿ (×˜×•×•×— 38-42)
                        if (userFreq >= 38 && userFreq <= 42) {
                            status.innerText = "××•×ª ×™×¦×™×‘ - × ×¢×™×œ×” ××ª×‘×¦×¢×ª...";
                            status.style.color = "var(--status-ok)";
                            ctx.strokeStyle = '#fff'; // ×”×‘×”×•×‘ ×œ×‘×Ÿ
                            
                            if (!this.winTimeout) {
                                this.winTimeout = setTimeout(() => {
                                    cancelAnimationFrame(animationFrame);
                                    Modal.close('mdl-game');
                                    Inventory.add(Items.GYRO);
                                    State.solved.push(refId);
                                    document.querySelector(`[data-id="${refId}"]`).style.display = 'none';
                                    this.winTimeout = null;
                                }, 1500);
                            }
                        } else {
                            status.innerText = "××•×ª ×—×œ×© / ×œ× ××¡×•× ×›×¨×Ÿ";
                            status.style.color = "var(--status-crit)";
                            if (this.winTimeout) { clearTimeout(this.winTimeout); this.winTimeout = null; }
                        }

                        animationFrame = requestAnimationFrame(draw);
                    }
                    draw();

                }, 100);
            },

            // 3. ×œ×•×— ××§×©×™× (Keypad)
            keypad() {
                const html = `
                    <div id="keypad-game">
                        <div id="keypad-display">_ _ _ _</div>
                        ${[1,2,3,4,5,6,7,8,9].map(n => `<div class="key-btn" onclick="Minigames.keyPress(${n})">${n}</div>`).join('')}
                    </div>
                    <p style="text-align:center; color:#666; margin-top:10px;">×¨××–: ×§×•×“ ×’× ×¨×™ (1234)</p>
                `;
                document.getElementById('game-title').innerText = "×‘×§×¨×ª ×›× ×™×¡×”";
                document.getElementById('game-content').innerHTML = html;
                Modal.open('mdl-game');
                this.codeBuffer = "";
            },

            keyPress(n) {
                this.codeBuffer += n;
                document.getElementById('keypad-display').innerText = this.codeBuffer;
                if (this.codeBuffer.length === 4) {
                    if (this.codeBuffer === "1234") {
                        Modal.close('mdl-game');
                        Game.transitionToLab();
                    } else {
                        document.getElementById('keypad-display').innerText = "×©×’×™××”";
                        this.codeBuffer = "";
                        setTimeout(() => document.getElementById('keypad-display').innerText = "_ _ _ _", 500);
                    }
                }
            },

            // 4. ×›×™××™×” (Chemistry)
            chemistry() {
                const html = `
                    <p style="text-align:center;">×¢×¨×‘×‘: ×™×¨×•×§ (×˜×‘×¢) + ×›×—×•×œ (×˜×›× ×•×œ×•×’×™×”) ×œ×™×¦×™×¨×ª × ×•×’×“×Ÿ.</p>
                    <div id="chem-container">
                        <div class="test-tube" style="border-color:#ff2a2a" onclick="Minigames.mix('red')"><div class="liquid" style="background:#ff2a2a"></div></div>
                        <div class="flask-main"><div class="flask-liquid" id="flask-fill"></div></div>
                        <div class="test-tube" style="border-color:#00ff9d" onclick="Minigames.mix('green')"><div class="liquid" style="background:#00ff9d"></div></div>
                        <div class="test-tube" style="border-color:#00f2ff" onclick="Minigames.mix('blue')"><div class="liquid" style="background:#00f2ff"></div></div>
                    </div>
                `;
                document.getElementById('game-title').innerText = "×¡×™× ×ª×–×ª ×—×•××¨×™×";
                document.getElementById('game-content').innerHTML = html;
                Modal.open('mdl-game');
                this.chemMix = [];
            },

            mix(color) {
                this.chemMix.push(color);
                const fill = document.getElementById('flask-fill');
                fill.style.height = (this.chemMix.length * 50) + "%";
                
                // ×¦×‘×¢ ×”×¢×¨×‘×•×‘
                fill.style.background = this.chemMix.length === 1 ? color : `linear-gradient(to top, ${this.chemMix.join(',')})`;

                if (this.chemMix.length === 2) {
                    if (this.chemMix.includes('green') && this.chemMix.includes('blue') && !this.chemMix.includes('red')) {
                        setTimeout(() => {
                            Modal.close('mdl-game');
                            Inventory.add(Items.ANTIDOTE);
                            Log.add("× ×•×’×“×Ÿ ×¡×•× ×ª×– ×‘×”×¦×œ×—×”!", true);
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            this.chemMix = [];
                            fill.style.height = "0%";
                            Log.add("×ª×¢×¨×•×‘×ª ×œ× ×™×¦×™×‘×”. × ×¡×” ×©×•×‘.", true);
                        }, 1000);
                    }
                }
            },

            // 5. × ×™×¦×—×•×Ÿ
            victory() {
                const html = `
                    <h1 style="color:var(--status-ok); font-size:40px; margin-bottom:10px;">××©×™××” ×”×•×©×œ××”!</h1>
                    <p style="font-size:18px;">×”× ×—×™×œ × ×•×˜×¨×œ ×‘×”×¦×œ×—×” ×‘×××¦×¢×•×ª ×”×˜×›× ×•×œ×•×’×™×” ×”×‘×™×•××™××˜×™×ª.</p>
                    <div style="font-size:60px; margin:20px 0;">ğŸ†</div>
                    <button class="action-btn green" onclick="location.reload()">××ª×—×•×œ ×¡×™××•×œ×¦×™×”</button>
                `;
                document.getElementById('game-title').innerText = "×“×™×•×•×— ×¡×™×•×";
                document.getElementById('game-content').innerHTML = html;
                Modal.open('mdl-game');
            }
        };

        // --- ×¢×–×¨×™× ---
        const Log = {
            add(msg, isGood=false) {
                const d = document.createElement('div');
                d.className = 'log-line' + (isGood ? ' new' : '');
                d.innerText = `> ${msg}`;
                document.getElementById('sys-log').prepend(d);
            }
        };

        const Modal = {
            open(id) { document.getElementById(id).classList.add('active'); },
            close(id) { document.getElementById(id).classList.remove('active'); }
        };

        // ××¤×§×˜×™ ×¨×§×¢ (Canvas Particles)
        const Fx = {
            mode: 'dust',
            start() {
                const cvs = document.getElementById('fx-canvas');
                const ctx = cvs.getContext('2d');
                
                const resize = () => { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; };
                window.onresize = resize; resize();

                const parts = Array.from({length: 60}, () => ({
                    x: Math.random()*cvs.width, y: Math.random()*cvs.height,
                    vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5,
                    size: Math.random()*2
                }));

                const loop = () => {
                    ctx.clearRect(0,0,cvs.width,cvs.height);
                    ctx.fillStyle = this.mode === 'fireflies' ? 'rgba(255,200,50,0.6)' : 'rgba(255,255,255,0.2)';
                    
                    parts.forEach(p => {
                        p.x += p.vx; p.y += p.vy;
                        if(p.x<0) p.x=cvs.width; if(p.x>cvs.width) p.x=0;
                        if(p.y<0) p.y=cvs.height; if(p.y>cvs.height) p.y=0;
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                        ctx.fill();
                    });
                    requestAnimationFrame(loop);
                };
                loop();
            }
        };

        // --- ××ª×—×•×œ (BOOT) ---
        window.onload = () => {
            const lines = [
                "×˜×•×¢×Ÿ ×œ×™×‘×” ×‘×™×•××™××˜×™×ª...",
                "×××ª×—×œ ×“×¨×™×™×‘×¨×™× ×’×¨×¤×™×™×...",
                "××ª×—×‘×¨ ×œ×œ×•×•×™×™×Ÿ BSF-01...",
                "×˜×¢×™× ×” ×”×•×©×œ××”."
            ];
            let i = 0;
            const logEl = document.getElementById('boot-log');
            
            const interval = setInterval(() => {
                if(i >= lines.length) {
                    clearInterval(interval);
                    document.getElementById('boot-bar').style.width = "100%";
                    setTimeout(() => {
                        document.getElementById('boot-layer').style.display = 'none';
                        document.getElementById('app-container').style.opacity = 1;
                        Game.init();
                    }, 800);
                } else {
                    const line = document.createElement('div');
                    line.innerText = "> " + lines[i++];
                    logEl.appendChild(line);
                }
            }, 400);
        };

    </script>
</body>
</html>
