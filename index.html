<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××‘×¦×¢ ×§×•×œ×§×¡: ×××©×§ ××—×§×¨ ×‘×™×•××™××˜×™</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;700&family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* * ==========================================================================
         * 1. ×”×’×“×¨×•×ª ×‘×¡×™×¡ ×•××©×ª× ×™× (CORE VARIABLES)
         * ==========================================================================
         */
        :root {
            /* ×¦×‘×¢×™× */
            --bg-dark: #050505;
            --panel-bg: rgba(18, 20, 25, 0.95);
            --panel-border: #333;
            
            --text-main: #a8b2d1;
            --text-dim: #5a6070;
            --text-bright: #ffffff;

            /* ×¦×‘×¢×™ ×××©×§ */
            --c-cyan: #00f2ff;   /* ×˜×›× ×•×œ×•×’×™×” */
            --c-green: #00ff9d;  /* ×‘×™×• */
            --c-orange: #ffae00; /* ××–×”×¨×” */
            --c-red: #ff2a2a;    /* ×§×¨×™×˜×™ */
            --c-purple: #b300ff; /* ××™×•×—×“ */

            /* ×’×“×œ×™× */
            --sidebar-width: 350px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* ×× ×™×¢×ª ×‘×—×™×¨×ª ×˜×§×¡×˜ ×œ×—×•×•×™×ª ××©×—×§ */
        }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Rubik', sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* * ==========================================================================
         * 2. ××¡×š ×˜×¢×™× ×” (BOOT SCREEN)
         * ==========================================================================
         */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Heebo', monospace;
            color: var(--c-cyan);
            direction: ltr; /* ×§×•×“ ×˜×¢×™× ×” ×‘×× ×’×œ×™×ª × ×¨××” ××’× ×™×‘ ×™×•×ª×¨ */
        }

        .boot-log { 
            width: 600px; height: 300px; overflow: hidden; 
            font-size: 14px; line-height: 1.5; opacity: 0.8; 
            text-align: left; border-left: 2px solid var(--c-cyan);
            padding-left: 20px;
        }
        .boot-loader {
            width: 300px; height: 4px; background: #333; margin-top: 20px; position: relative;
        }
        .boot-bar {
            width: 0%; height: 100%; background: var(--c-green);
            transition: width 3s ease-out;
            box-shadow: 0 0 10px var(--c-green);
        }

        /* * ==========================================================================
         * 3. ××‘× ×” ×¨××©×™ (MAIN LAYOUT)
         * ==========================================================================
         */
        #game-wrapper {
            width: 100%; height: 100%;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr; /* ×¡×¨×’×œ ×¦×“ ××™××™×Ÿ, ××©×—×§ ××©×××œ */
            grid-template-rows: var(--header-height) 1fr;
            opacity: 0; transition: opacity 1s;
        }

        /* ×¡×¨×’×œ ×¢×œ×™×•×Ÿ */
        #top-bar {
            grid-column: 1 / -1;
            background: rgba(10, 10, 10, 0.9);
            border-bottom: 1px solid var(--panel-border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
            z-index: 50;
        }

        .brand-title {
            font-family: 'Heebo', sans-serif; font-size: 24px; font-weight: 700; letter-spacing: 2px;
            color: var(--c-cyan);
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        .sys-status { 
            font-family: 'Rubik'; font-size: 14px; color: var(--c-green); 
            display: flex; align-items: center; gap: 10px;
        }
        .status-dot { width: 10px; height: 10px; background: var(--c-green); border-radius: 50%; box-shadow: 0 0 5px var(--c-green); }
        .sys-status.alert .status-dot { background: var(--c-red); box-shadow: 0 0 5px var(--c-red); animation: blink 0.5s infinite; }
        .sys-status.alert { color: var(--c-red); }

        /* * ==========================================================================
         * 4. ××–×•×¨ ×”××©×—×§ (VIEWPORT)
         * ==========================================================================
         */
        #viewport {
            position: relative;
            background: #000;
            overflow: hidden;
            border-right: 1px solid var(--panel-border);
            cursor: default;
        }

        /* ×©×›×‘×•×ª ×¨×§×¢ */
        .layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background-size: cover; background-position: center; 
            transition: opacity 1.5s ease-in-out; opacity: 0; z-index: 1;
        }
        
        #bg-day { background-image: url('https://i.ibb.co/7tQt5S0h/Gemini-Generated-Image-prcu4rprcu4rprcu.png'); opacity: 1; }
        #bg-night { background-image: url('https://i.ibb.co/svJJmvYr/Gemini-Generated-Image-l4kaehl4kaehl4ka.png'); opacity: 0; }
        #bg-lab { background-image: url('https://i.ibb.co/d04yrgRx/Gemini-Generated-Image-j02tg6j02tg6j02t.png'); opacity: 0; }

        /* ××¤×§×˜×™× ×•×¡×•×¨×§ */
        #fx-canvas { pointer-events: none; z-index: 5; opacity: 0.8; position: absolute; top:0; left:0; width:100%; height:100%; }
        
        #scan-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 242, 255, 0.05),
                rgba(0, 242, 255, 0.05) 1px,
                transparent 1px,
                transparent 4px
            );
            pointer-events: none; z-index: 6; opacity: 0; transition: opacity 0.3s;
        }
        #scan-overlay.active { opacity: 1; }
        
        /* ××¤×§×˜ ×•×™× ×™×™×˜ (Vignette) ×œ×§×¦×•×•×ª */
        #viewport::after {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
            pointer-events: none; z-index: 7;
        }

        /* * ==========================================================================
         * 5. × ×§×•×“×•×ª ×¢× ×™×™×Ÿ (HOTSPOTS)
         * ==========================================================================
         */
        #hotspot-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; }

        .hotspot {
            position: absolute;
            z-index: 25;
            cursor: pointer;
            opacity: 0; /* ××•×¡×ª×¨ ×¢×“ ×©×¢×•×‘×¨×™× ×¢× ×”×¢×›×‘×¨ ××• ××¤×¢×™×œ×™× ×¡×•×¨×§ */
            transition: all 0.3s;
            border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        /* ×œ×•×’×™×§×” ×œ×ª×¦×•×’×ª × ×§×•×“×•×ª ×¢× ×™×™×Ÿ */
        .scanner-active .hotspot { 
            opacity: 0.4; 
            background: rgba(0, 242, 255, 0.1); 
            border-color: var(--c-cyan); 
            animation: pulse 2s infinite;
        }
        
        .hotspot:hover { 
            opacity: 1 !important; 
            box-shadow: 0 0 20px var(--c-cyan), inset 0 0 10px var(--c-cyan); 
            border: 2px solid #fff; 
            background: rgba(0, 242, 255, 0.2); 
            transform: scale(1.05);
        }

        /* ××™×§×•××™× ×‘××—×•×–×™× */
        /* ×©×œ×‘ ×”×¨×›×‘×ª */
        #spot-cat { top: 14%; left: 20%; width: 12%; height: 14%; }
        #spot-map { top: 35%; left: 9%; width: 18%; height: 23%; }
        #spot-window { top: 22%; left: 35%; width: 28%; height: 38%; }
        #spot-hat { top: 26%; left: 67%; width: 10%; height: 16%; }
        #spot-door { top: 18%; left: 78%; width: 20%; height: 75%; }
        /* ×©×œ×‘ ×”××¢×‘×“×” */
        #spot-flask { top: 55%; left: 25%; width: 15%; height: 25%; }
        #spot-jar { top: 15%; left: 60%; width: 25%; height: 55%; }
        #spot-notes { top: 70%; left: 45%; width: 20%; height: 15%; }

        .hidden { display: none !important; }

        /* * ==========================================================================
         * 6. ×¡×¨×’×œ ×¦×“ (SIDEBAR)
         * ==========================================================================
         */
        #sidebar {
            background: rgba(10, 12, 16, 0.98);
            display: flex; flex-direction: column;
            border-left: 2px solid var(--panel-border);
            padding: 20px;
            z-index: 40;
            box-shadow: -5px 0 20px rgba(0,0,0,0.5);
        }

        .panel { 
            background: rgba(255,255,255,0.03); 
            border: 1px solid var(--panel-border); 
            padding: 15px; margin-bottom: 15px; border-radius: 6px; 
            position: relative;
        }
        .panel h3 { 
            margin: 0 0 10px 0; font-family: 'Heebo'; font-size: 16px; 
            color: var(--c-cyan); border-bottom: 1px solid #333; padding-bottom: 5px; 
        }

        /* ×›×¤×ª×•×¨ ×¡×•×¨×§ */
        #scanner-btn {
            width: 100%; padding: 12px;
            background: transparent; border: 1px solid var(--c-cyan); color: var(--c-cyan);
            font-family: 'Rubik'; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: 0.3s; margin-bottom: 20px; text-transform: uppercase;
        }
        #scanner-btn:hover, #scanner-btn.active { 
            background: var(--c-cyan); color: #000; box-shadow: 0 0 15px var(--c-cyan); 
        }

        /* ××–×•×¨ ×”××©×™××” ×”× ×•×›×—×™×ª */
        #objective-text { font-size: 14px; line-height: 1.4; color: #fff; }

        /* ×›×¤×ª×•×¨ ×”×ª×™×§ */
        #bag-btn {
            width: 100%; height: 80px;
            background: #111; border: 2px solid #444; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s; margin-top: auto;
            position: relative; overflow: hidden;
        }
        #bag-btn::before { content: 'ğŸ’'; font-size: 40px; }
        #bag-btn:hover { border-color: var(--c-green); background: rgba(0, 255, 157, 0.1); }
        #bag-label { position: absolute; bottom: 5px; font-size: 12px; color: #aaa; }

        /* ×œ×•×’ ××¢×¨×›×ª */
        #system-log { 
            height: 200px; overflow-y: auto; font-family: 'Heebo'; font-size: 12px; color: #888; 
            border-top: 1px solid #333; padding-top: 10px;
        }
        .log-entry { margin-bottom: 8px; border-right: 2px solid #333; padding-right: 8px; }
        .log-entry.new { border-color: var(--c-green); color: var(--c-green); }
        .log-entry.err { border-color: var(--c-red); color: var(--c-red); }

        /* * ==========================================================================
         * 7. ×—×œ×•× ×•×ª ×§×•×¤×¦×™× (MODALS)
         * ==========================================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(8px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        /* ×§×•×¤×¡×” ×›×œ×œ×™×ª */
        .modal-box {
            background: #111; border: 2px solid var(--c-cyan);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
            padding: 30px; width: 600px; max-width: 90%;
            border-radius: 12px; position: relative; text-align: center;
        }
        .close-modal { 
            position: absolute; top: 10px; left: 15px; cursor: pointer; 
            color: #666; font-size: 24px; font-weight: bold;
        }
        .close-modal:hover { color: #fff; }

        /* ×›×•×ª×¨×•×ª */
        .modal-title { font-family: 'Heebo'; color: var(--c-cyan); font-size: 24px; margin-bottom: 20px; }
        .modal-desc { margin-bottom: 25px; font-size: 16px; color: #ddd; line-height: 1.6; }

        /* ×¢×™×¦×•×‘ ×”×ª×™×§ (INVENTORY MODAL) */
        #inventory-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; 
        }
        .inv-item {
            aspect-ratio: 1; background: #050505; border: 1px solid #333;
            border-radius: 8px; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; cursor: pointer;
            transition: 0.2s; position: relative;
        }
        .inv-item:hover { border-color: var(--c-green); background: #0a150f; }
        .inv-item.selected { border-color: var(--c-green); box-shadow: 0 0 15px var(--c-green); }
        .inv-icon { font-size: 32px; margin-bottom: 5px; }
        .inv-name { font-size: 12px; color: #aaa; text-align: center; }

        #item-details { 
            margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; 
            display: none; border: 1px solid #444;
        }
        #item-desc { font-size: 14px; color: #ccc; margin-bottom: 10px; }
        
        .action-btn {
            background: var(--c-cyan); color: #000; border: none; padding: 10px 25px;
            font-family: 'Rubik'; font-weight: bold; cursor: pointer; border-radius: 4px;
            transition: 0.2s; font-size: 16px;
        }
        .action-btn:hover { background: #fff; transform: scale(1.05); }
        .action-btn.green { background: var(--c-green); }

        /* ××™× ×™-××©×—×§×™× */
        #tuner-game { display: flex; flex-direction: column; align-items: center; }
        #wave-canvas { width: 100%; height: 150px; background: #000; border: 1px solid #333; margin-bottom: 15px; }
        
        #keypad-game { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 200px; margin: 0 auto; }
        .key-btn { padding: 15px; background: #222; border: 1px solid #444; color: #fff; font-size: 18px; cursor: pointer; }
        .key-btn:hover { background: var(--c-cyan); color: #000; }
        #keypad-display { grid-column: 1 / -1; background: #000; color: var(--c-cyan); font-family: monospace; font-size: 24px; padding: 10px; margin-bottom: 10px; border: 1px solid #444; text-align: center; letter-spacing: 5px; }

        #chem-game { display: flex; justify-content: center; gap: 20px; align-items: flex-end; height: 200px; }
        .chem-tube { width: 60px; height: 150px; border: 2px solid #fff; position: relative; cursor: pointer; border-radius: 0 0 20px 20px; overflow: hidden; }
        .chem-liquid { position: absolute; bottom: 0; width: 100%; height: 50%; opacity: 0.7; transition: height 0.3s; }
        #flask-mix { width: 100px; height: 180px; border: 3px solid #fff; border-radius: 0 0 40px 40px; position: relative; overflow: hidden; }
        #flask-liquid { position: absolute; bottom: 0; width: 100%; height: 0%; background: #222; transition: all 0.5s; }

        /* ×§×œ×˜×™× ×œ×—×™×“×•×ª */
        input.riddle-input {
            width: 80%; padding: 10px; margin-bottom: 15px; background: #000; 
            border: 1px solid var(--c-cyan); color: #fff; text-align: center; font-size: 18px;
        }

        /* ×× ×™××¦×™×•×ª */
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 0.6; } 100% { opacity: 0.3; } }

    </style>
</head>
<body>

    <div id="boot-screen">
        <div class="boot-log" id="boot-log"></div>
        <div class="boot-loader"><div class="boot-bar" id="boot-bar"></div></div>
    </div>

    <div id="game-wrapper">
        
        <header id="top-bar">
            <div class="brand-title">MIVTZA CULEX <span style="font-size:12px;">v2.0</span></div>
            <div id="sys-status" class="sys-status"><span class="status-dot"></span> ××¢×¨×›×•×ª ×ª×§×™× ×•×ª</div>
        </header>

        <main id="viewport">
            <canvas id="fx-canvas"></canvas>
            <div id="scan-overlay"></div>
            
            <div id="bg-lab" class="layer"></div>
            <div id="bg-night" class="layer"></div>
            <div id="bg-day" class="layer"></div>

            <div id="hotspot-layer">
                <div id="spot-cat" class="hotspot train-obj" data-id="cat"></div>
                <div id="spot-map" class="hotspot train-obj" data-id="map"></div>
                <div id="spot-window" class="hotspot train-obj" data-id="window"></div>
                <div id="spot-hat" class="hotspot train-obj" data-id="hat"></div>
                <div id="spot-door" class="hotspot train-obj" data-id="door"></div>

                <div id="spot-flask" class="hotspot lab-obj hidden" data-id="flask"></div>
                <div id="spot-jar" class="hotspot lab-obj hidden" data-id="jar"></div>
                <div id="spot-notes" class="hotspot lab-obj hidden" data-id="notes"></div>
            </div>
        </main>

        <aside id="sidebar">
            <button id="scanner-btn" onclick="Game.toggleScanner()">×¡×•×¨×§ ×ª×¨××™ [×›×‘×•×™]</button>

            <div class="panel">
                <h3>××©×™××” × ×•×›×—×™×ª</h3>
                <div id="objective-text">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
            </div>

            <div class="panel" style="flex-grow:1;">
                <h3>×™×•××Ÿ ××¢×¨×›×ª</h3>
                <div id="system-log"></div>
            </div>

            <div class="panel">
                <div id="bag-btn" onclick="Inventory.openUI()">
                    <div id="bag-label">×œ×—×¥ ×œ×¤×ª×™×—×ª ×”×ª×™×§</div>
                </div>
            </div>
            
            <div style="text-align: center; color: #666; font-size: 12px; margin-top: 10px;">
                ×–××Ÿ ××©×™××”: <span id="game-clock">00:00</span>
            </div>
        </aside>
    </div>

    <div id="modal-inventory" class="modal-overlay">
        <div class="modal-box">
            <div class="close-modal" onclick="Modal.close('modal-inventory')">Ã—</div>
            <h2 class="modal-title">×ª×™×§ ×¦×™×•×“</h2>
            <div id="inventory-grid"></div>
            
            <div id="item-details">
                <h3 id="item-title" style="color:var(--c-cyan); margin:0 0 10px 0;"></h3>
                <p id="item-desc"></p>
                <button id="use-item-btn" class="action-btn">×”×©×ª××©</button>
            </div>
        </div>
    </div>

    <div id="modal-game" class="modal-overlay">
        <div class="modal-box">
            <div class="close-modal" onclick="Modal.close('modal-game')">Ã—</div>
            <h2 class="modal-title" id="game-title">××ª×’×¨ ××‘×˜×—×”</h2>
            
            <div id="game-content"></div>
        </div>
    </div>

    <script>
        /**
         * ==========================================================================
         * × ×ª×•× ×™× ×•×§×•× ×¤×™×’×•×¨×¦×™×”
         * ==========================================================================
         */
        
        // ×¨×©×™××ª ×—×¤×¦×™×
        const Items = {
            DRONE: { id: 'drone', icon: 'ğŸ¦Ÿ', name: '×¨×—×¤×Ÿ ×™×ª×•×©', desc: '×¨×—×¤×Ÿ ×‘×™×•××™××˜×™ ×–×¢×™×¨. ××ª××™× ×œ×—×“×™×¨×” ×œ××§×•××•×ª ×¦×¤×•×¤×™×.' },
            NEEDLE: { id: 'needle', icon: 'ğŸ’‰', name: '××—×˜ ××™×§×¨×•× ×™×ª', desc: '×‘×”×©×¨××ª ×—×“×§ ×”×™×ª×•×©. ×××¤×©×¨×ª ×”×–×¨×§×” ×œ×œ× ×›××‘.' },
            SENSOR: { id: 'sensor', icon: 'ğŸŒ¡ï¸', name: '×—×™×™×©×Ÿ ×ª×¨××™', desc: '××–×”×” ×—×•× ×’×•×£ ×××¨×—×§ ×¨×‘.' },
            GYRO: { id: 'gyro', icon: 'âš–ï¸', name: '××™×™×¦×‘ ×’×™×¨×•×¡×§×•×¤×™', desc: '××‘×•×¡×¡ ×¢×œ ×‘×•×›× ×™×•×ª ×”××™×–×•×Ÿ ×©×œ ×”×™×ª×•×©. ×œ×™×™×¦×•×‘ ×‘×ª× ××™ ×¨×•×—.' },
            CHEM: { id: 'chem', icon: 'ğŸ‘ƒ', name: '×—×™×™×©×Ÿ ×›×™××™', desc: '××–×”×” ×¤×—××Ÿ ×“×•-×—××¦× ×™ ×•×¨×™×—×•×ª.' },
            FORMULA: { id: 'formula', icon: 'ğŸ“œ', name: '× ×•×¡×—×ª ×”×¨×¢×œ', desc: '×“×¤×™× ×§×¨×•×¢×™× ××™×•×× ×• ×©×œ ××¨×§×“×™×•×¡.' },
            ANTIDOTE: { id: 'antidote', icon: 'ğŸ§ª', name: '×”× ×•×’×“×Ÿ', desc: '×”×ª×¨×•×¤×” ×”××¡×•× ×ª×–×ª ×œ× ×™×˜×¨×•×œ ×”× ×—×™×œ.' }
        };

        // × ×™×”×•×œ ××¦×‘ ××©×—×§
        const State = {
            phase: 'TRAIN', // ××• 'LAB'
            inventory: [],
            isScannerOn: false,
            isNight: false,
            gameTime: 0,
            solvedPuzzles: [],
            selectedItem: null // ×”×—×¤×¥ ×©× ×‘×—×¨ ×‘×ª×™×§ ×œ×©×™××•×©
        };

        /**
         * ==========================================================================
         * ×× ×•×¢ ×”××©×—×§ (GAME ENGINE)
         * ==========================================================================
         */
        const Game = {
            init() {
                // ×”×•×¡×¤×ª ×¤×¨×™×˜ ×”×ª×—×œ×ª×™
                Inventory.add(Items.DRONE);
                Log.add("×”××¢×¨×›×ª ××•×ª×—×œ×”. ×©×œ×‘ 1: ×—×“×™×¨×”.", true);
                this.updateObjective();
                
                // ×”×ª×—×œ×ª ×©×¢×•×Ÿ ×•××¤×§×˜×™×
                Fx.start();
                setInterval(this.tick, 1000);

                // ×××–×™× ×™× ×œ×œ×—×™×¦×•×ª
                document.querySelectorAll('.hotspot').forEach(el => {
                    el.addEventListener('click', (e) => this.handleHotspot(e.target));
                });
            },

            tick() {
                State.gameTime++;
                
                // ×¢×“×›×•×Ÿ ×©×¢×•×Ÿ
                const mins = Math.floor(State.gameTime / 60).toString().padStart(2, '0');
                const secs = (State.gameTime % 60).toString().padStart(2, '0');
                document.getElementById('game-clock').innerText = `${mins}:${secs}`;

                // ××—×–×•×¨ ×™×•×/×œ×™×œ×” ×¤×©×•×˜ (×›×œ 30 ×©× ×™×•×ª)
                if (State.phase === 'TRAIN') {
                    const cycle = State.gameTime % 60;
                    if (cycle > 30 && !State.isNight) {
                        State.isNight = true;
                        Game.setNightMode(true);
                    } else if (cycle <= 30 && State.isNight) {
                        State.isNight = false;
                        Game.setNightMode(false);
                    }
                }
            },

            setNightMode(isNight) {
                document.getElementById('bg-day').style.opacity = isNight ? 0 : 1;
                document.getElementById('bg-night').style.opacity = isNight ? 1 : 0;
                
                const status = document.getElementById('sys-status');
                if(isNight) {
                    status.innerHTML = '<span class="status-dot"></span> ××¦×‘ ×œ×™×œ×” ×¤×¢×™×œ';
                    status.classList.add('alert');
                    Fx.mode = 'fireflies';
                } else {
                    status.innerHTML = '<span class="status-dot"></span> ××¢×¨×›×•×ª ×ª×§×™× ×•×ª';
                    status.classList.remove('alert');
                    Fx.mode = 'dust';
                }
            },

            toggleScanner() {
                State.isScannerOn = !State.isScannerOn;
                const btn = document.getElementById('scanner-btn');
                const overlay = document.getElementById('scan-overlay');

                if (State.isScannerOn) {
                    btn.innerText = "×¡×•×¨×§ ×ª×¨××™ [×¤×¢×™×œ]";
                    btn.classList.add('active');
                    overlay.classList.add('active');
                    document.body.classList.add('scanner-active');
                    Log.add("×¡×•×¨×§ ×”×•×¤×¢×œ. ×—×ª×™××•×ª ×—×•× ×’×œ×•×™×•×ª.");
                } else {
                    btn.innerText = "×¡×•×¨×§ ×ª×¨××™ [×›×‘×•×™]";
                    btn.classList.remove('active');
                    overlay.classList.remove('active');
                    document.body.classList.remove('scanner-active');
                }
            },

            updateObjective() {
                const txt = document.getElementById('objective-text');
                if (State.phase === 'TRAIN') {
                    const needed = ['needle', 'sensor', 'gyro', 'chem'];
                    const have = needed.filter(id => Inventory.has(id)).length;
                    
                    if (have < 4) {
                        txt.innerText = `×× ×• ×–×§×•×§×™× ×œ×¨×›×™×‘×™× ×‘×™×•××™××˜×™×™× ×œ×¤×¨×™×¦×ª ×”××¢×‘×“×”. ××¦××• ××•×ª× ×‘×§×¨×•×Ÿ. (${have}/4)`;
                    } else {
                        txt.innerText = "×›×œ ×”×¨×›×™×‘×™× × ××¡×¤×•. ×’×© ×œ×“×œ×ª ×”××¢×‘×“×” ×•×¤×¨×•×¥ ××•×ª×”.";
                        document.getElementById('spot-door').style.border = "2px solid var(--c-green)";
                    }
                } else {
                    if (!Inventory.has('formula')) txt.innerText = "××¦× ××ª ×™×•××Ÿ ×”××—×§×¨ ×©×œ ××¨×§×“×™×•×¡.";
                    else if (!Inventory.has('antidote')) txt.innerText = "×”×©×ª××© ×‘× ×•×¡×—×” ×‘××‘×—× ×•×ª ×›×“×™ ×œ×™×¦×•×¨ × ×•×’×“×Ÿ.";
                    else txt.innerText = "×”×©×ª××© ×‘×¨×—×¤×Ÿ ×¢× ×”× ×•×’×“×Ÿ ×¢×œ ×¦× ×¦× ×ª ×”× ×—×™×œ ×›×“×™ ×œ×¡×™×™×.";
                }
            },

            handleHotspot(target) {
                const id = target.dataset.id;
                
                // ×‘×“×™×§×ª ×¡×•×¨×§ (×—×•×‘×” ×œ×—×¤×¦×™× × ×¡×ª×¨×™×)
                if (!State.isScannerOn && id !== 'door' && id !== 'jar') {
                    Log.add("×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××•×‘×™×™×§×˜. ×”×¤×¢×œ ×¡×•×¨×§.", true); // true = ×©×’×™××”
                    return;
                }

                // ×× ×›×‘×¨ × ×¤×ª×¨
                if (State.solvedPuzzles.includes(id)) {
                    Log.add("××–×•×¨ ×–×” ×›×‘×¨ × ×¡×¨×§.", false);
                    return;
                }

                // × ×™×ª×•×‘ ×œ×•×’×™×§×” ×œ×¤×™ ××•×‘×™×™×§×˜
                switch(id) {
                    case 'cat':
                        Minigames.riddle("×˜×›× ×•×œ×•×’×™×™×ª ×—××§× ×•×ª", "×× ×™ ×“×•×§×¨ ×‘×œ×™ ×œ×”×¢×™×¨, × ×™×–×•×Ÿ ×‘×œ×™ ×œ×”×›××™×‘. ××™ ×× ×™?", "×™×ª×•×©", Items.NEEDLE, id);
                        break;
                    case 'map':
                        Minigames.riddle("××¢×¨×›×ª × ×™×•×•×˜", "×™×© ×œ×™ ×™×¢×¨×•×ª ×‘×œ×™ ×¢×¦×™× ×•×™××™× ×‘×œ×™ ×“×’×™×. ×× ×™ ×¢×•×–×¨ ×œ××¦×•× ×—×•× ××¨×—×•×§.", "××¤×”", Items.SENSOR, id);
                        break;
                    case 'window':
                        Minigames.tuner(id); // ×”×¤×¢×œ×ª ××™× ×™-××©×—×§ ×ª×“×¨×™×
                        break;
                    case 'hat':
                        Minigames.riddle("×—×™×™×©× ×™ ×›×™××™×”", "×× ×™ ×™×•×©×‘ ××¢×œ ×”×¢×™× ×™×™×, ××¡××œ ×¡××›×•×ª, ×•××›×•×•×Ÿ ××ª ×”×“×¨×š.", "×›×•×‘×¢", Items.CHEM, id);
                        break;
                    case 'door':
                        // ×“×•×¨×© 4 ×—×¤×¦×™×
                        const needed = ['needle', 'sensor', 'gyro', 'chem'];
                        if (needed.every(i => Inventory.has(i))) {
                            Minigames.keypad();
                        } else {
                            Log.add("×”×“×œ×ª × ×¢×•×œ×”. ×—×¡×¨×™× ×¨×›×™×‘×™×.", true);
                        }
                        break;
                    
                    // ×©×œ×‘ 2
                    case 'notes':
                        Minigames.riddle("×¤×¢× ×•×— ×™×•××Ÿ", "×”××¤×ª×— ×”×•× ×”×¦×‘×¢ ×©×œ ×”×˜×‘×¢ ××¢×•×¨×‘×‘ ×‘×¦×‘×¢ ×”×©××™×™×.", "×™×¨×•×§", Items.FORMULA, id);
                        break;
                    case 'flask':
                        // ×“×•×¨×© ×©×™××•×© ×‘× ×•×¡×—×”
                        Log.add("×¢××“×ª ×›×™××™×”. ×‘×—×¨ ××ª '× ×•×¡×—×ª ×”×¨×¢×œ' ×‘×ª×™×§ ×•×”×©×ª××© ×‘×” ×›××Ÿ.", false);
                        break;
                    case 'jar':
                        Log.add("× ×—×™×œ ×™×ª×•×©×™× ×§×˜×œ× ×™. ×¦×¨×™×š × ×•×’×“×Ÿ ×•×¨×—×¤×Ÿ.", true);
                        break;
                }
            },

            useItem(itemId) {
                // ×¤×•× ×§×¦×™×” ×–×• × ×§×¨××ª ×›×©×”××©×ª××© ×œ×•×—×¥ "×”×©×ª××©" ×‘×ª×™×§
                Modal.close('modal-inventory');
                
                if (State.phase === 'LAB') {
                    if (itemId === 'formula') {
                        // ×‘×“×™×§×” ×”×× ×¡×•×¨×§ ×¤×•×¢×œ ×•×œ×•×—×¦×™× ×¢×œ Flask? × ×¢×©×” ×¤×©×•×˜ ×™×•×ª×¨:
                        // ×©×™××•×© ×‘× ×•×¡×—×” ×¤×•×ª×— ××ª ××©×—×§ ×”×›×™××™×”
                        Minigames.chemistry();
                        return;
                    }
                    if (itemId === 'drone' && Inventory.has('antidote')) {
                        // × ×™×¦×—×•×Ÿ
                        Minigames.victory();
                        return;
                    }
                }
                
                Log.add(`×œ× × ×™×ª×Ÿ ×œ×”×©×ª××© ×‘-${Items[itemId.toUpperCase()]?.name || itemId} ×›×¨×’×¢.`, true);
            },

            transitionToLab() {
                State.phase = 'LAB';
                document.getElementById('viewport').style.opacity = 0;
                
                setTimeout(() => {
                    // ×”×—×œ×¤×ª ×¨×§×¢×™× ×•××•×‘×™×™×§×˜×™×
                    document.querySelectorAll('.train-obj').forEach(e => e.classList.add('hidden'));
                    document.querySelectorAll('.lab-obj').forEach(e => e.classList.remove('hidden'));
                    document.getElementById('bg-lab').style.opacity = 1;
                    
                    document.getElementById('viewport').style.opacity = 1;
                    Log.add("×¤×¨×™×¦×” ×”×•×©×œ××”. × ×›× ×¡ ×œ××¢×‘×“×”.", true);
                    this.updateObjective();
                }, 1000);
            }
        };

        /**
         * ==========================================================================
         * × ×™×”×•×œ ××œ××™ (INVENTORY)
         * ==========================================================================
         */
        const Inventory = {
            add(item) {
                if (this.has(item.id)) return;
                State.inventory.push(item);
                Log.add(`× ××¡×£: ${item.name}`, true);
                Game.updateObjective();
                
                // ×”×‘×”×•×‘ ×›×¤×ª×•×¨ ×”×ª×™×§
                const btn = document.getElementById('bag-btn');
                btn.style.borderColor = 'var(--c-green)';
                setTimeout(() => btn.style.borderColor = '#444', 1000);
            },

            has(id) {
                return State.inventory.some(i => i.id === id);
            },

            openUI() {
                const grid = document.getElementById('inventory-grid');
                grid.innerHTML = '';
                document.getElementById('item-details').style.display = 'none';

                State.inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'inv-item';
                    el.innerHTML = `<div class="inv-icon">${item.icon}</div><div class="inv-name">${item.name}</div>`;
                    el.onclick = () => this.selectItem(item, el);
                    grid.appendChild(el);
                });

                Modal.open('modal-inventory');
            },

            selectItem(item, el) {
                // ×¡×™××•×Ÿ ×•×™×–×•××œ×™
                document.querySelectorAll('.inv-item').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');

                // ×”×¦×’×ª ×¤×¨×˜×™×
                const details = document.getElementById('item-details');
                details.style.display = 'block';
                document.getElementById('item-title').innerText = item.name;
                document.getElementById('item-desc').innerText = item.desc;
                
                // ×›×¤×ª×•×¨ ×©×™××•×©
                const btn = document.getElementById('use-item-btn');
                btn.onclick = () => Game.useItem(item.id);
            }
        };

        /**
         * ==========================================================================
         * ××™× ×™-××©×—×§×™× ×•×—×™×“×•×ª (MINIGAMES)
         * ==========================================================================
         */
        const Minigames = {
            
            // 1. ×—×™×“×ª ×˜×§×¡×˜
            riddle(title, text, answerKey, reward, refId) {
                const html = `
                    <p style="color:#ccc; margin-bottom:20px;">${text}</p>
                    <input type="text" id="riddle-input" class="riddle-input" placeholder="×”×›× ×¡ ×ª×©×•×‘×”...">
                    <button class="action-btn" onclick="Minigames.checkRiddle('${answerKey}', '${reward.id}', '${refId}')">××™×©×•×¨</button>
                    <p id="riddle-feedback" style="height:20px; color:var(--c-red); margin-top:10px;"></p>
                `;
                document.getElementById('game-title').innerText = title;
                document.getElementById('game-content').innerHTML = html;
                Modal.open('modal-game');
            },

            checkRiddle(key, rewardId, refId) {
                const val = document.getElementById('riddle-input').value.trim();
                const fb = document.getElementById('riddle-feedback');
                
                if (val.includes(key)) {
                    Modal.close('modal-game');
                    Inventory.add(Items[rewardId.toUpperCase()]);
                    State.solvedPuzzles.push(refId);
                    document.querySelector(`[data-id="${refId}"]`).style.display = 'none';
                } else {
                    fb.innerText = "×ª×©×•×‘×” ×©×’×•×™×”. × ×¡×” ×©×•×‘.";
                }
            },

            // 2. ×›×™×•×œ ×ª×“×¨ (Canvas)
            tuner(refId) {
                const html = `
                    <p>×›×™×™×œ ××ª ×”×ª×“×¨ ×œ×™×™×¦×•×‘ ×”×¨×—×¤×Ÿ:</p>
                    <div id="tuner-game">
                        <canvas id="wave-canvas"></canvas>
                        <input type="range" min="1" max="100" value="50" id="wave-slider" style="width:80%;">
                        <div id="tuner-status" style="margin-top:10px; font-weight:bold; color:var(--c-red);">××•×ª ×—×œ×©</div>
                    </div>
                `;
                document.getElementById('game-title').innerText = "×™×™×¦×•×‘ ×’×™×¨×•×¡×§×•×¤×™";
                document.getElementById('game-content').innerHTML = html;
                Modal.open('modal-game');

                // ×œ×•×’×™×§×” ×¤× ×™××™×ª ×œ×¦×™×•×¨ ×”×’×œ
                setTimeout(() => {
                    const canvas = document.getElementById('wave-canvas');
                    const ctx = canvas.getContext('2d');
                    const slider = document.getElementById('wave-slider');
                    const status = document.getElementById('tuner-status');
                    
                    let val = 50;
                    slider.oninput = (e) => val = e.target.value;
                    
                    const loop = setInterval(() => {
                        if(!document.getElementById('wave-canvas')) { clearInterval(loop); return; }
                        
                        ctx.fillStyle = '#000'; ctx.fillRect(0,0,300,150);
                        ctx.lineWidth = 2;
                        
                        // ×’×œ ××˜×¨×” (×™×¨×•×§)
                        ctx.strokeStyle = '#0f0'; ctx.beginPath();
                        for(let x=0; x<300; x++) {
                            let y = 75 + Math.sin(x*0.1) * 30;
                            if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                        }
                        ctx.stroke();

                        // ×’×œ ××©×ª××© (×›×—×•×œ)
                        ctx.strokeStyle = '#00f2ff'; ctx.beginPath();
                        for(let x=0; x<300; x++) {
                            let y = 75 + Math.sin(x * (0.05 + (val-50)*0.002)) * 30;
                            if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                        }
                        ctx.stroke();

                        // ×‘×“×™×§×ª ×”×¦×œ×—×”
                        if (val > 23 && val < 27) {
                            status.innerText = "××•×ª ×™×¦×™×‘ - × ×¢×•×œ";
                            status.style.color = "#0f0";
                            clearInterval(loop);
                            setTimeout(() => {
                                Modal.close('modal-game');
                                Inventory.add(Items.GYRO);
                                State.solvedPuzzles.push(refId);
                                document.querySelector(`[data-id="${refId}"]`).style.display = 'none';
                            }, 1000);
                        } else {
                            status.innerText = "××•×ª ×—×œ×©";
                            status.style.color = "#f00";
                        }
                    }, 30);
                }, 100);
            },

            // 3. ×œ×•×— ××§×©×™× (Keypad)
            keypad() {
                const html = `
                    <div id="keypad-game">
                        <div id="keypad-display">_ _ _ _</div>
                        ${[1,2,3,4,5,6,7,8,9].map(n => `<div class="key-btn" onclick="Minigames.keyPress(${n})">${n}</div>`).join('')}
                    </div>
                `;
                document.getElementById('game-title').innerText = "×¤×¨×™×¦×ª ×“×œ×ª";
                document.getElementById('game-content').innerHTML = html;
                Modal.open('modal-game');
                this.keyCode = "";
            },

            keyPress(n) {
                this.keyCode += n;
                document.getElementById('keypad-display').innerText = this.keyCode;
                if (this.keyCode.length === 4) {
                    if (this.keyCode === "1337" || this.keyCode === "1234") { // ×§×•×“ ×¤×©×•×˜
                        Modal.close('modal-game');
                        Game.transitionToLab();
                    } else {
                        document.getElementById('keypad-display').innerText = "×©×’×™××”";
                        this.keyCode = "";
                        setTimeout(() => document.getElementById('keypad-display').innerText = "_ _ _ _", 500);
                    }
                }
            },

            // 4. ×›×™××™×”
            chemistry() {
                const html = `
                    <p>×¢×¨×‘×‘: ×™×¨×•×§ (×˜×‘×¢) + ×›×—×•×œ (×˜×›× ×•×œ×•×’×™×”) = × ×•×’×“×Ÿ</p>
                    <div id="chem-game">
                        <div class="chem-tube" style="border-color:#f00" onclick="Minigames.mix('red')"><div class="chem-liquid" style="background:#f00"></div></div>
                        <div id="flask-mix"><div id="flask-liquid"></div></div>
                        <div class="chem-tube" style="border-color:#0f0" onclick="Minigames.mix('green')"><div class="chem-liquid" style="background:#0f0"></div></div>
                        <div class="chem-tube" style="border-color:#00f" onclick="Minigames.mix('blue')"><div class="chem-liquid" style="background:#00f"></div></div>
                    </div>
                `;
                document.getElementById('game-title').innerText = "×¡×™× ×ª×–×ª × ×•×’×“×Ÿ";
                document.getElementById('game-content').innerHTML = html;
                Modal.open('modal-game');
                this.currentMix = [];
            },

            mix(color) {
                this.currentMix.push(color);
                const flask = document.getElementById('flask-liquid');
                flask.style.height = (this.currentMix.length * 50) + "%";
                flask.style.background = this.currentMix.length === 1 ? color : `linear-gradient(to top, ${this.currentMix.join(',')})`;

                if (this.currentMix.length === 2) {
                    if (this.currentMix.includes('green') && this.currentMix.includes('blue') && !this.currentMix.includes('red')) {
                        setTimeout(() => {
                            Modal.close('modal-game');
                            Inventory.add(Items.ANTIDOTE);
                            Log.add("× ×•×’×“×Ÿ ×¡×•× ×ª×– ×‘×”×¦×œ×—×”!", true);
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            this.currentMix = [];
                            flask.style.height = "0%";
                            Log.add("×ª×¢×¨×•×‘×ª ×œ× ×™×¦×™×‘×”. × ×¡×” ×©×•×‘.", true); // true ×‘×©×‘×™×œ ××“×•×
                        }, 1000);
                    }
                }
            },

            victory() {
                const html = `
                    <h1 style="color:var(--c-green); font-size:40px;">××©×™××” ×”×•×©×œ××”!</h1>
                    <p style="font-size:18px;">×”× ×—×™×œ × ×•×˜×¨×œ. ×”××—×§×¨ ×”×‘×™×•××™××˜×™ ×”×•×©×œ×.</p>
                    <button class="action-btn green" onclick="location.reload()">×”×ª×—×œ ××—×“×©</button>
                `;
                document.getElementById('game-title').innerText = "× ×™×¦×—×•×Ÿ";
                document.getElementById('game-content').innerHTML = html;
                Modal.open('modal-game');
            }
        };

        /**
         * ==========================================================================
         * ×©×™×¨×•×ª×™× (UTILS)
         * ==========================================================================
         */
        
        // × ×™×”×•×œ ×œ×•×’
        const Log = {
            add(msg, isErr = false) {
                const div = document.createElement('div');
                div.className = 'log-entry' + (isErr ? ' err' : ' new');
                const time = new Date().toLocaleTimeString('he-IL');
                div.innerText = `[${time}] ${msg}`;
                document.getElementById('system-log').prepend(div);
            }
        };

        // ×—×œ×•× ×•×ª ××•×“××œ×™×™×
        const Modal = {
            open(id) { document.getElementById(id).classList.add('active'); },
            close(id) { document.getElementById(id).classList.remove('active'); }
        };

        // ××¤×§×˜×™× (Canvas)
        const Fx = {
            mode: 'dust',
            start() {
                const cvs = document.getElementById('fx-canvas');
                const ctx = cvs.getContext('2d');
                
                const resize = () => { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; };
                window.onresize = resize; resize();

                const particles = Array.from({length: 50}, () => ({
                    x: Math.random() * cvs.width, y: Math.random() * cvs.height,
                    vx: (Math.random()-0.5), vy: (Math.random()-0.5),
                    size: Math.random() * 2
                }));

                const loop = () => {
                    ctx.clearRect(0,0,cvs.width,cvs.height);
                    ctx.fillStyle = this.mode === 'fireflies' ? 'rgba(255,200,50,0.6)' : 'rgba(255,255,255,0.3)';
                    
                    particles.forEach(p => {
                        p.x += p.vx; p.y += p.vy;
                        if(p.x<0) p.x=cvs.width; if(p.x>cvs.width) p.x=0;
                        if(p.y<0) p.y=cvs.height; if(p.y>cvs.height) p.y=0;
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                        ctx.fill();
                    });
                    requestAnimationFrame(loop);
                };
                loop();
            }
        };

        // --- ××ª×—×•×œ ---
        // ××¤×§×˜ ×˜×¢×™× ×”
        window.onload = () => {
            const lines = ["Initializing...", "Loading Hebrew Drivers...", "Connecting BSF-01...", "Done."];
            let i = 0;
            const int = setInterval(() => {
                if(i>=lines.length) {
                    clearInterval(int);
                    document.getElementById('boot-bar').style.width = "100%";
                    setTimeout(() => {
                        document.getElementById('boot-screen').style.display = 'none';
                        document.getElementById('game-wrapper').style.opacity = 1;
                        Game.init();
                    }, 500);
                } else {
                    const d = document.createElement('div');
                    d.innerText = "> " + lines[i++];
                    document.querySelector('.boot-log').appendChild(d);
                }
            }, 300);
        };

    </script>
</body>
</html>
