<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPERATION CULEX: ULTIMATE EDITION</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        /* * ==========================================================================
         * 1. CORE VARIABLES & RESET
         * ==========================================================================
         */
        :root {
            --c-bg-dark: #050505;
            --c-panel: #0a0b10;
            --c-border: #2a2b30;
            
            --c-text-main: #a8b2d1;
            --c-text-dim: #5a6070;
            --c-text-bright: #ffffff;

            /* HUD Colors */
            --c-primary: #00f2ff; /* Cyan - UI */
            --c-success: #00ff9d; /* Green - Bio */
            --c-warn: #ffae00;    /* Orange - Alert */
            --c-danger: #ff2a2a;  /* Red - Critical */
            --c-rare: #b300ff;    /* Purple - Special */

            /* Layout */
            --sidebar-width: 380px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--c-bg-dark);
            color: var(--c-text-main);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* * ==========================================================================
         * 2. BOOT SEQUENCE SCREEN
         * ==========================================================================
         */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Share Tech Mono', monospace;
            color: var(--c-primary);
        }

        .boot-log { width: 600px; height: 300px; overflow: hidden; font-size: 14px; line-height: 1.5; opacity: 0.8; }
        .boot-loader {
            width: 300px; height: 4px; background: #333; margin-top: 20px; position: relative;
        }
        .boot-bar {
            width: 0%; height: 100%; background: var(--c-success);
            transition: width 3s ease-out;
            box-shadow: 0 0 10px var(--c-success);
        }

        /* * ==========================================================================
         * 3. MAIN GAME LAYOUT
         * ==========================================================================
         */
        #game-wrapper {
            width: 100%; height: 100%;
            display: grid;
            grid-template-columns: 1fr var(--sidebar-width);
            grid-template-rows: var(--header-height) 1fr;
            opacity: 0; transition: opacity 1s; /* Fade in after boot */
        }

        /* Top Header Bar */
        #top-bar {
            grid-column: 1 / -1;
            background: var(--c-panel);
            border-bottom: 1px solid var(--c-border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
            z-index: 50;
        }

        .brand-title {
            font-family: 'Orbitron', sans-serif; font-size: 24px; letter-spacing: 2px;
            background: linear-gradient(90deg, var(--c-primary), #fff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .sys-status { font-family: 'Share Tech Mono'; font-size: 14px; color: var(--c-success); }
        .sys-status.alert { color: var(--c-danger); animation: blink 1s infinite; }

        /* Left Column: Viewport */
        #viewport {
            position: relative;
            background: #000;
            overflow: hidden;
            border-right: 1px solid var(--c-border);
        }

        /* Right Column: Sidebar */
        #sidebar {
            background: rgba(10, 11, 16, 0.95);
            display: flex; flex-direction: column;
            border-left: 1px solid var(--c-border);
            padding: 20px;
            backdrop-filter: blur(10px);
            z-index: 40;
        }

        /* * ==========================================================================
         * 4. VIEWPORT LAYERS & VISUALS
         * ==========================================================================
         */
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 1.5s; background-size: cover; background-position: center; }
        
        #bg-day { background-image: url('https://i.ibb.co/7tQt5S0h/Gemini-Generated-Image-prcu4rprcu4rprcu.png'); opacity: 1; }
        #bg-night { background-image: url('https://i.ibb.co/svJJmvYr/Gemini-Generated-Image-l4kaehl4kaehl4ka.png'); opacity: 0; }
        #bg-lab { background-image: url('https://i.ibb.co/d04yrgRx/Gemini-Generated-Image-j02tg6j02tg6j02t.png'); opacity: 0; }

        #fx-canvas { pointer-events: none; z-index: 5; opacity: 0.7; }
        
        #scan-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 242, 255, 0.05),
                rgba(0, 242, 255, 0.05) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none; z-index: 6; opacity: 0; transition: opacity 0.3s;
        }
        #scan-overlay.active { opacity: 1; }

        /* * ==========================================================================
         * 5. INTERACTIVE HOTSPOTS
         * ==========================================================================
         */
        .hotspot {
            position: absolute;
            z-index: 20;
            cursor: pointer;
            opacity: 0; /* Hidden unless scanned or hovered */
            transition: all 0.3s;
            border: 1px dashed rgba(255,255,255,0.2);
        }

        /* Scanner Logic */
        .scanner-active .hotspot { opacity: 0.3; background: rgba(0, 242, 255, 0.1); border-color: var(--c-primary); }
        .hotspot:hover { opacity: 1 !important; box-shadow: 0 0 15px var(--c-primary); border: 1px solid #fff; background: rgba(0, 242, 255, 0.2); }

        /* Positioning (Percentages) */
        /* Train */
        #spot-cat { top: 14%; left: 20%; width: 12%; height: 14%; }
        #spot-map { top: 35%; left: 9%; width: 18%; height: 23%; }
        #spot-window { top: 22%; left: 35%; width: 28%; height: 38%; }
        #spot-hat { top: 26%; left: 67%; width: 10%; height: 16%; }
        #spot-door { top: 18%; left: 78%; width: 20%; height: 75%; }
        /* Lab */
        #spot-flask { top: 55%; left: 25%; width: 15%; height: 25%; }
        #spot-jar { top: 15%; left: 60%; width: 25%; height: 55%; }
        #spot-notes { top: 70%; left: 45%; width: 20%; height: 15%; }

        /* * ==========================================================================
         * 6. UI PANELS (SIDEBAR)
         * ==========================================================================
         */
        .panel { background: rgba(255,255,255,0.03); border: 1px solid var(--c-border); padding: 15px; margin-bottom: 15px; border-radius: 6px; }
        .panel h3 { margin: 0 0 10px 0; font-family: 'Orbitron'; font-size: 14px; color: var(--c-primary); letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* Scanner Toggle */
        #scanner-btn {
            width: 100%; padding: 15px;
            background: transparent; border: 1px solid var(--c-primary); color: var(--c-primary);
            font-family: 'Share Tech Mono'; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: 0.3s; text-transform: uppercase; margin-bottom: 20px;
        }
        #scanner-btn:hover, #scanner-btn.active { background: var(--c-primary); color: #000; box-shadow: 0 0 15px var(--c-primary); }

        /* Mission Log */
        #objective-text { font-size: 14px; line-height: 1.4; color: #fff; }

        /* Inventory Grid */
        #inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .inv-slot { aspect-ratio: 1; background: #000; border: 1px solid #333; display: flex; justify-content: center; align-items: center; font-size: 20px; transition: 0.3s; position: relative; }
        .inv-slot.filled { border-color: var(--c-success); box-shadow: inset 0 0 10px rgba(0,255,157,0.2); }
        .inv-tooltip { 
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #000; border: 1px solid #fff; padding: 5px; font-size: 10px; 
            width: 100px; text-align: center; display: none; z-index: 100;
        }
        .inv-slot:hover .inv-tooltip { display: block; }

        /* DataBank (Journal) */
        #databank { height: 150px; overflow-y: auto; font-family: 'Share Tech Mono'; font-size: 12px; color: #888; }
        .log-entry { margin-bottom: 8px; border-left: 2px solid #333; padding-left: 8px; }
        .log-entry.new { border-color: var(--c-success); color: var(--c-success); }

        /* * ==========================================================================
         * 7. MINI-GAMES & MODALS
         * ==========================================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .game-window {
            width: 600px; height: 400px;
            background: #111; border: 2px solid var(--c-primary);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
            padding: 20px; position: relative;
            display: flex; flex-direction: column;
        }
        .game-header { font-family: 'Orbitron'; font-size: 20px; color: var(--c-primary); margin-bottom: 20px; text-align: center;}
        .close-modal { position: absolute; top: 10px; right: 15px; cursor: pointer; color: #666; font-size: 20px; }
        .close-modal:hover { color: #fff; }

        /* --- Mini-Game 1: Frequency Tuner (Window) --- */
        #tuner-game { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #wave-canvas { width: 100%; height: 150px; background: #000; border: 1px solid #333; margin-bottom: 20px; }
        input[type=range] { width: 80%; cursor: pointer; }
        #tuner-status { margin-top: 10px; font-family: 'Share Tech Mono'; color: var(--c-warn); }

        /* --- Mini-Game 2: Keypad Hack (Door) --- */
        #keypad-game { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 250px; margin: 0 auto; }
        .key-btn { 
            padding: 20px; background: #222; border: 1px solid #444; color: #fff; 
            font-family: 'Orbitron'; font-size: 18px; cursor: pointer; transition: 0.2s; 
        }
        .key-btn:hover { background: var(--c-primary); color: #000; }
        #keypad-display { 
            grid-column: 1 / -1; background: #000; color: var(--c-primary); 
            font-family: 'Share Tech Mono'; font-size: 24px; padding: 10px; text-align: center; border: 1px solid #444;
        }

        /* --- Mini-Game 3: Chemical Mixer (Flask) --- */
        #chem-game { display: flex; justify-content: space-around; padding-top: 50px; }
        .chem-btn { width: 80px; height: 100px; border: 2px solid #fff; cursor: pointer; position: relative; overflow: hidden; }
        .chem-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; opacity: 0.5; transition: height 0.5s; }
        #beaker-main { width: 120px; height: 150px; border: 3px solid #fff; border-radius: 0 0 20px 20px; position: relative; overflow: hidden; }
        #beaker-fill { position: absolute; bottom: 0; width: 100%; height: 0%; background: #333; transition: all 0.5s; }

        /* Victory Screen */
        #victory-screen { text-align: center; }
        #victory-screen h1 { color: var(--c-success); font-size: 40px; margin-bottom: 20px; text-shadow: 0 0 20px var(--c-success); }
        
        /* Utility */
        .hidden { display: none !important; }
        
        /* Animations */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div id="boot-screen">
        <div class="boot-log" id="boot-log"></div>
        <div class="boot-loader"><div class="boot-bar" id="boot-bar"></div></div>
    </div>

    <div id="game-wrapper">
        
        <header id="top-bar">
            <div class="brand-title">CULEX_OS <span style="font-size:12px; vertical-align:middle;">v9.4</span></div>
            <div id="sys-status" class="sys-status">SYSTEM NORMAL</div>
        </header>

        <main id="viewport">
            <canvas id="fx-canvas"></canvas>
            <div id="scan-overlay"></div>
            
            <div id="bg-lab" class="layer"></div>
            <div id="bg-night" class="layer"></div>
            <div id="bg-day" class="layer"></div>

            <div id="hotspot-layer">
                <div id="spot-cat" class="hotspot" data-ref="cat"></div>
                <div id="spot-map" class="hotspot" data-ref="map"></div>
                <div id="spot-window" class="hotspot" data-ref="window"></div>
                <div id="spot-hat" class="hotspot" data-ref="hat"></div>
                <div id="spot-door" class="hotspot" data-ref="door"></div>

                <div id="spot-flask" class="hotspot hidden" data-ref="flask"></div>
                <div id="spot-jar" class="hotspot hidden" data-ref="jar"></div>
                <div id="spot-notes" class="hotspot hidden" data-ref="notes"></div>
            </div>
        </main>

        <aside id="sidebar">
            <button id="scanner-btn" onclick="Game.toggleScanner()">Toggle Scanner [OFF]</button>

            <div class="panel">
                <h3>Current Directive</h3>
                <div id="objective-text">Initializing...</div>
            </div>

            <div class="panel" style="flex-grow:1; display:flex; flex-direction:column;">
                <h3>Research Journal</h3>
                <div id="databank">
                    </div>
            </div>

            <div class="panel">
                <h3>Inventory</h3>
                <div id="inv-grid">
                    <div class="inv-slot" id="slot-0"></div>
                    <div class="inv-slot" id="slot-1"></div>
                    <div class="inv-slot" id="slot-2"></div>
                    <div class="inv-slot" id="slot-3"></div>
                    <div class="inv-slot" id="slot-4"></div>
                    <div class="inv-slot" id="slot-5"></div>
                    <div class="inv-slot" id="slot-6"></div>
                    <div class="inv-slot" id="slot-7"></div>
                </div>
            </div>
        </aside>
    </div>

    <div id="game-modal" class="modal-overlay">
        <div class="game-window">
            <div class="close-modal" onclick="Modal.close()">Ã—</div>
            <div class="game-header" id="modal-title">SYSTEM ACCESS</div>
            
            <div id="modal-content" style="flex:1; position:relative;">
                
                <div id="tuner-game" class="minigame hidden">
                    <p style="color:#aaa; text-align:center;">Match the resonance frequency to stabilize the drone.</p>
                    <canvas id="wave-canvas"></canvas>
                    <input type="range" min="1" max="100" value="50" id="wave-slider">
                    <div id="tuner-status">SIGNAL: WEAK</div>
                </div>

                <div id="keypad-game" class="minigame hidden">
                    <div id="keypad-display">_ _ _ _</div>
                    <button class="key-btn" onclick="Keypad.press(1)">1</button>
                    <button class="key-btn" onclick="Keypad.press(2)">2</button>
                    <button class="key-btn" onclick="Keypad.press(3)">3</button>
                    <button class="key-btn" onclick="Keypad.press(4)">4</button>
                    <button class="key-btn" onclick="Keypad.press(5)">5</button>
                    <button class="key-btn" onclick="Keypad.press(6)">6</button>
                    <button class="key-btn" onclick="Keypad.press(7)">7</button>
                    <button class="key-btn" onclick="Keypad.press(8)">8</button>
                    <button class="key-btn" onclick="Keypad.press(9)">9</button>
                </div>

                <div id="chem-game" class="minigame hidden">
                    <div style="text-align:center; position:absolute; top:0; width:100%;">Mix Green (Bio) + Blue (Tech)</div>
                    <div class="chem-btn" onclick="Chem.add('red')" style="border-color:#f00;"><div class="chem-fill" style="background:#f00;"></div></div>
                    <div id="beaker-main"><div id="beaker-fill"></div></div>
                    <div class="chem-btn" onclick="Chem.add('blue')" style="border-color:#00f;"><div class="chem-fill" style="background:#00f;"></div></div>
                    <div class="chem-btn" onclick="Chem.add('green')" style="border-color:#0f0;"><div class="chem-fill" style="background:#0f0;"></div></div>
                </div>

                <div id="riddle-container" class="minigame hidden">
                    <p id="riddle-text" style="font-size:16px; line-height:1.5; color:#fff; margin-bottom:20px;"></p>
                    <input type="text" id="riddle-input" style="width:100%; padding:10px; background:#000; color:var(--c-primary); border:1px solid #333; font-family:'Share Tech Mono'; font-size:18px;">
                    <button onclick="Riddle.check()" style="margin-top:10px; padding:10px 20px; background:var(--c-primary); border:none; font-weight:bold; cursor:pointer;">SUBMIT</button>
                    <p id="riddle-err" style="color:var(--c-danger); margin-top:10px;"></p>
                </div>

                <div id="victory-screen" class="minigame hidden">
                    <h1>MISSION SUCCESS</h1>
                    <p>Dr. Arcadius's swarm has been neutralized.</p>
                    <p>Biomimicry data successfully archived.</p>
                    <button onclick="location.reload()" style="margin-top:30px; padding:15px 40px; background:var(--c-success); border:none; font-weight:bold; cursor:pointer;">REBOOT SIMULATION</button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- ASSETS & CONFIG ---
        const ITEMS = {
            needle: { icon: 'ðŸ’‰', name: 'Micro-Needle', desc: 'Inspired by Mosquito Proboscis' },
            sensor: { icon: 'ðŸ“¡', name: 'Thermal Sensor', desc: 'Heat seeking technology' },
            gyro: { icon: 'âš–ï¸', name: 'Gyro-Halteres', desc: 'Flight stabilization' },
            chem: { icon: 'ðŸ‘ƒ', name: 'Chem-Receptor', desc: 'Chemical detection unit' },
            formula: { icon: 'ðŸ“œ', name: 'Arcadius Notes', desc: 'Toxin Formula' },
            antidote: { icon: 'ðŸ§ª', name: 'The Cure', desc: 'Synthesized Antidote' },
            drone: { icon: 'ðŸ¦Ÿ', name: 'B-Drone', desc: 'Bio-Mimetic Delivery System' } // Player starts with this
        };

        // --- GLOBAL STATE ---
        const State = {
            phase: 'TRAIN', // TRAIN -> LAB
            inventory: ['drone'],
            isScannerOn: false,
            isNight: false,
            progress: 0,
            solved: []
        };

        // --- BOOT SEQUENCE ---
        function runBoot() {
            const log = document.getElementById('boot-log');
            const bar = document.getElementById('boot-bar');
            const lines = [
                "Initializing Kernel...",
                "Loading Bio-Mimetic Drivers...",
                "Connecting to BSF-01 Remote Link...",
                "Downloading Environmental Textures...",
                "Calibrating Sensors...",
                "System Ready."
            ];
            
            let i = 0;
            const interval = setInterval(() => {
                if(i >= lines.length) {
                    clearInterval(interval);
                    setTimeout(startGame, 500);
                    return;
                }
                const p = document.createElement('div');
                p.innerText = "> " + lines[i];
                log.appendChild(p);
                log.scrollTop = log.scrollHeight;
                i++;
            }, 300);

            // Animate Bar
            setTimeout(() => { bar.style.width = "100%"; }, 100);
        }

        function startGame() {
            document.getElementById('boot-screen').style.display = 'none';
            document.getElementById('game-wrapper').style.opacity = 1;
            Game.init();
        }

        // --- GAME ENGINE ---
        const Game = {
            init() {
                Inventory.render();
                Journal.add("Mission started. Phase 1: Infiltration.", true);
                Journal.add("Objective: Gather 4 biomimetic components.");
                
                this.updateObjective();
                Fx.init(); // Start particles
                
                // Add Click Listeners
                document.querySelectorAll('.hotspot').forEach(el => {
                    el.addEventListener('click', (e) => this.handleObjectClick(e.target));
                });

                // Start Clock
                setInterval(this.tickClock, 1000);
            },

            tickClock() {
                // Simulate time passing. Night cycle every 30s.
                const now = new Date();
                const sec = now.getSeconds();
                
                // Night Cycle Logic
                if (State.phase === 'TRAIN') {
                    if (sec > 30 && !State.isNight) {
                        State.isNight = true;
                        document.getElementById('bg-day').style.opacity = 0;
                        document.getElementById('bg-night').style.opacity = 1;
                        document.getElementById('sys-status').innerText = "LOW LIGHT MODE";
                        document.getElementById('sys-status').classList.add('alert');
                    } else if (sec <= 30 && State.isNight) {
                        State.isNight = false;
                        document.getElementById('bg-day').style.opacity = 1;
                        document.getElementById('bg-night').style.opacity = 0;
                        document.getElementById('sys-status').innerText = "SYSTEM NORMAL";
                        document.getElementById('sys-status').classList.remove('alert');
                    }
                }
            },

            toggleScanner() {
                State.isScannerOn = !State.isScannerOn;
                const btn = document.getElementById('scanner-btn');
                const overlay = document.getElementById('scan-overlay');
                
                if (State.isScannerOn) {
                    btn.classList.add('active');
                    btn.innerText = "Scanner [ON]";
                    overlay.classList.add('active');
                    document.body.classList.add('scanner-active');
                    Journal.add("Scanner activated. Heat signatures visible.");
                } else {
                    btn.classList.remove('active');
                    btn.innerText = "Scanner [OFF]";
                    overlay.classList.remove('active');
                    document.body.classList.remove('scanner-active');
                }
            },

            handleObjectClick(target) {
                // Only allow click if scanner is ON (except for door/obvious things)
                if (!State.isScannerOn && target.id !== 'spot-door') {
                    Journal.add("Cannot analyze. Enable Scanner first.", false);
                    return;
                }

                const ref = target.dataset.ref;
                
                // Check if already solved
                if (State.solved.includes(ref)) return;

                // Route to Logic
                switch(ref) {
                    case 'cat':
                        Riddle.open("Stealth Analysis", "I pierce skin without waking the host. My design minimizes friction. What am I?", "needle", ITEMS.needle, ref);
                        break;
                    case 'map':
                        Riddle.open("Navigation Data", "I allow tracking of heat signatures over long distances using vectors. What system am I?", "thermal", ITEMS.sensor, ref);
                        break;
                    case 'hat':
                        Riddle.open("Sensor Calibration", "I guide the way. I sit above the eyes. I represent chemical sensing authority.", "hat", ITEMS.chem, ref);
                        break;
                    case 'window':
                        // Launch Frequency Minigame
                        Modal.open("Atmospheric Stabilization", "tuner-game");
                        Tuner.start(target);
                        break;
                    case 'door':
                        // Check if we have all 4 items
                        const req = ['needle', 'sensor', 'gyro', 'chem'];
                        const hasAll = req.every(i => State.inventory.includes(i));
                        if(hasAll) {
                            Modal.open("Security Override", "keypad-game");
                        } else {
                            Journal.add("Door Locked. Requires 4 components.", false);
                        }
                        break;
                    case 'notes':
                        Riddle.open("Research Decryption", "The key to the cure is the color of life mixed with the color of technology.", "formula", ITEMS.formula, ref);
                        break;
                    case 'flask':
                        if(!State.inventory.includes('formula')) {
                            Journal.add("Need formula to operate synth.", false);
                            return;
                        }
                        Modal.open("Antidote Synthesis", "chem-game");
                        break;
                    case 'jar':
                        if(State.inventory.includes('antidote')) {
                            Modal.open("DEPLOYMENT", "victory-screen");
                        } else {
                            Journal.add("Target locked. Antidote required.", false);
                        }
                        break;
                }
            },

            updateObjective() {
                const txt = document.getElementById('objective-text');
                if (State.phase === 'TRAIN') {
                    const count = 4 - (State.inventory.length - 1); // -1 for drone
                    if(count > 0) txt.innerText = `Find ${count} more components to unlock the door.`;
                    else txt.innerText = "Components acquired. BREACH THE DOOR.";
                } else {
                    txt.innerText = "Find the Formula. Mix the Antidote. Destroy the Swarm.";
                }
            },

            transitionToLab() {
                State.phase = 'LAB';
                document.getElementById('viewport').style.opacity = 0;
                setTimeout(() => {
                    // Hide train spots, show lab spots
                    document.querySelectorAll('.train-obj').forEach(e => e.classList.add('hidden'));
                    document.querySelectorAll('.lab-obj').forEach(e => e.classList.remove('hidden'));
                    
                    document.getElementById('bg-lab').style.opacity = 1;
                    document.getElementById('viewport').style.opacity = 1;
                    
                    Journal.add("Phase 1 Complete. Entering Lab.", true);
                    Game.updateObjective();
                }, 1000);
            }
        };

        // --- INVENTORY SYSTEM ---
        const Inventory = {
            render() {
                const slots = document.querySelectorAll('.inv-slot');
                // Clear
                slots.forEach(s => { s.innerHTML = ''; s.classList.remove('filled'); });
                
                // Fill
                State.inventory.forEach((itemId, idx) => {
                    if(idx < 8) {
                        const item = Object.values(ITEMS).find(i => i.id === itemId); // find by id string
                        // For simplicity, we mapped IDs directly in ITEMS keys in Logic above, but let's do a lookup
                        let itemData = null;
                        for(let k in ITEMS) { if(ITEMS[k].id === itemId) itemData = ITEMS[k]; }

                        if(itemData) {
                            slots[idx].innerHTML = itemData.icon + `<div class="inv-tooltip">${itemData.name}</div>`;
                            slots[idx].classList.add('filled');
                        }
                    }
                });
            },
            add(itemObj) {
                if(!State.inventory.includes(itemObj.id)) {
                    State.inventory.push(itemObj.id);
                    this.render();
                    Journal.add(`Acquired: ${itemObj.name}`, true);
                    Game.updateObjective();
                }
            }
        };

        // --- JOURNAL SYSTEM ---
        const Journal = {
            add(msg, isNew = false) {
                const db = document.getElementById('databank');
                const div = document.createElement('div');
                div.className = 'log-entry' + (isNew ? ' new' : '');
                div.innerText = `> ${msg}`;
                db.prepend(div);
            }
        };

        // --- MODAL SYSTEM ---
        const Modal = {
            open(title, contentId) {
                document.getElementById('game-modal').classList.add('active');
                document.getElementById('modal-title').innerText = title;
                
                // Hide all minigames
                document.querySelectorAll('.minigame').forEach(el => el.classList.add('hidden'));
                // Show requested
                document.getElementById(contentId).classList.remove('hidden');
            },
            close() {
                document.getElementById('game-modal').classList.remove('active');
            }
        };

        // --- RIDDLE LOGIC ---
        const Riddle = {
            currentRef: null,
            currentReward: null,
            answerKey: null,

            open(title, text, answerKey, reward, ref) {
                this.currentRef = ref;
                this.currentReward = reward;
                this.answerKey = answerKey; // simple keyword check
                
                const box = document.getElementById('riddle-text');
                box.innerText = text;
                document.getElementById('riddle-input').value = "";
                document.getElementById('riddle-err').innerText = "";
                
                Modal.open(title, "riddle-container");
            },

            check() {
                const val = document.getElementById('riddle-input').value.toLowerCase();
                // Loose check
                if(val.includes('mosquito') || val.includes('needle') || val.includes('thermal') || val.includes('map') || val.includes('cloud') || val.includes('hat') || val.includes('evil') || val.includes('formula')) {
                    // Just force success for demo based on context, in real game check specific string
                    // Actually let's do specific:
                    let success = false;
                    // Cheat map for demo robustness:
                    if(this.answerKey === 'needle' && (val.includes('mosquito') || val.includes('needle'))) success = true;
                    if(this.answerKey === 'thermal' && (val.includes('map') || val.includes('thermal'))) success = true;
                    if(this.answerKey === 'cloud' && (val.includes('cloud') || val.includes('wind') || val.includes('storm'))) success = true;
                    if(this.answerKey === 'hat' && (val.includes('hat') || val.includes('cap'))) success = true;
                    if(this.answerKey === 'formula' && (val.includes('evil') || val.includes('live'))) success = true;

                    if(success) {
                        State.solved.push(this.currentRef);
                        Inventory.add(this.currentReward);
                        Modal.close();
                        // Hide the hotspot visually
                        document.querySelector(`[data-ref="${this.currentRef}"]`).style.display = 'none';
                    } else {
                        document.getElementById('riddle-err').innerText = "Incorrect. Try again.";
                    }
                } else {
                     document.getElementById('riddle-err').innerText = "Incorrect. Try again.";
                }
            }
        };

        // --- MINIGAME 1: TUNER (Canvas) ---
        const Tuner = {
            target: null,
            start(domTarget) {
                this.target = domTarget;
                const canvas = document.getElementById('wave-canvas');
                const ctx = canvas.getContext('2d');
                const slider = document.getElementById('wave-slider');
                const status = document.getElementById('tuner-status');
                
                let val = 50;
                slider.oninput = (e) => val = e.target.value;

                function draw() {
                    if(!document.getElementById('tuner-game').offsetParent) return; // Stop if hidden
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0,0,300,150);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#0f0';
                    
                    ctx.beginPath();
                    // Target Wave (Fixed)
                    for(let x=0; x<300; x++) {
                        let y = 75 + Math.sin(x * 0.1) * 30;
                        if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                    }
                    ctx.stroke();

                    // User Wave
                    ctx.strokeStyle = '#00e5ff';
                    ctx.beginPath();
                    let freq = val * 0.005; // 0.05 to 0.5
                    for(let x=0; x<300; x++) {
                        let y = 75 + Math.sin(x * (0.05 + (val-50)*0.002)) * 30;
                        if(x==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                    }
                    ctx.stroke();

                    // Check Match
                    if(val > 23 && val < 27) { // Sweet spot
                        status.innerText = "SIGNAL: LOCKED";
                        status.style.color = "#0f0";
                        setTimeout(() => {
                            Modal.close();
                            if(!State.solved.includes('window')) {
                                State.solved.push('window');
                                Inventory.add(ITEMS.gyro);
                                document.querySelector(`[data-ref="window"]`).style.display = 'none';
                            }
                        }, 1000);
                    } else {
                        status.innerText = "SIGNAL: WEAK";
                        status.style.color = "#f00";
                    }
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        // --- MINIGAME 2: KEYPAD ---
        const Keypad = {
            code: "3141", // Pi :)
            current: "",
            press(num) {
                this.current += num;
                document.getElementById('keypad-display').innerText = this.current;
                if(this.current.length === 4) {
                    if(this.current === this.code) {
                        Modal.close();
                        Game.transitionToLab();
                    } else {
                        this.current = "";
                        document.getElementById('keypad-display').innerText = "ERR";
                        setTimeout(() => document.getElementById('keypad-display').innerText = "_ _ _ _", 500);
                    }
                }
            }
        };

        // --- MINIGAME 3: CHEMISTRY ---
        const Chem = {
            mix: [],
            add(color) {
                this.mix.push(color);
                const beaker = document.getElementById('beaker-fill');
                beaker.style.height = (this.mix.length * 33) + "%";
                
                // Color mixing logic
                if(this.mix.length === 1) beaker.style.background = color;
                else beaker.style.background = "linear-gradient(to top, " + this.mix.join(',') + ")";

                if(this.mix.length === 2) {
                    // Check Recipe: Green + Blue
                    if(this.mix.includes('green') && this.mix.includes('blue') && !this.mix.includes('red')) {
                        setTimeout(() => {
                            Modal.close();
                            Inventory.add(ITEMS.antidote);
                            Journal.add("Antidote Synthesized.", true);
                            Game.updateObjective();
                        }, 1000);
                    } else {
                        setTimeout(() => {
                             this.mix = [];
                             beaker.style.height = "0%";
                             Journal.add("Mixture unstable. Dumped.", false);
                        }, 1000);
                    }
                }
            }
        };

        // --- PARTICLE FX ---
        const Fx = {
            init() {
                const cvs = document.getElementById('fx-canvas');
                const ctx = cvs.getContext('2d');
                cvs.width = window.innerWidth; cvs.height = window.innerHeight;
                
                const particles = [];
                for(let i=0; i<50; i++) particles.push({
                    x: Math.random()*cvs.width, y: Math.random()*cvs.height,
                    vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5,
                    size: Math.random()*2
                });

                function loop() {
                    ctx.clearRect(0,0,cvs.width,cvs.height);
                    ctx.fillStyle = State.isNight ? "rgba(255, 200, 50, 0.5)" : "rgba(255, 255, 255, 0.3)"; // Fireflies vs Dust
                    
                    particles.forEach(p => {
                        p.x += p.vx; p.y += p.vy;
                        if(p.x < 0) p.x = cvs.width; if(p.x > cvs.width) p.x = 0;
                        if(p.y < 0) p.y = cvs.height; if(p.y > cvs.height) p.y = 0;
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                        ctx.fill();
                    });
                    requestAnimationFrame(loop);
                }
                loop();
            }
        };

        // START
        window.onload = runBoot;

    </script>
</body>
</html>
